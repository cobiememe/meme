<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Cobie ‚Äî Crypto Sentiment Social MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0f14; --panel:#0f1622;
  --ink:#e9fbff; --muted:#9ed9e6;
  --accent:#00eaff; --good:#14F195;
}
html,body{margin:0;padding:0;background:#05080c;color:var(--ink);font-family:Inter,system-ui;}
header{position:sticky;top:0;background:#0b0f1499;backdrop-filter:blur(6px);padding:12px;border-bottom:1px solid #ffffff22}
.h{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto}
.btn{background:#0f1a24;border:1px solid #ffffff22;padding:8px 14px;border-radius:10px;cursor:pointer;color:var(--ink);font-weight:700}
.status{color:var(--muted);font-size:12px;border:1px solid #ffffff22;padding:6px 10px;border-radius:999px}
.container{max-width:1200px;margin:auto;padding:12px}
.card{background:#111827aa;border:1px solid #ffffff22;border-radius:14px;margin-bottom:14px}
.card .body{padding:14px}
textarea{width:100%;height:90px;border-radius:12px;background:#0b1320;border:1px solid #ffffff22;color:white;padding:10px;margin-top:6px}
.post{padding:12px;border-bottom:1px solid #ffffff11;display:grid;grid-template-columns:44px 1fr;gap:12px}
.avatar{width:44px;height:44px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}
.small{font-size:12px;color:var(--muted)}
.tip-btn{background:#062018;border:1px solid #00ffa388;color:#00ffa3;margin-top:4px;padding:4px 8px;font-size:12px;border-radius:6px;cursor:pointer}
</style>
</head>

<body>
<header>
  <div class="h">
    <img src="../img/1boss.png" style="width:36px;border-radius:8px;border:2px solid #00eaff77">
    <b style="font-size:20px;background:linear-gradient(90deg,#00eaff,#14f195,#00ffa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Cobie</b>
    <span style="font-size:12px;color:#9ed9e6">Sentiment Social ‚Äî MVP</span>

    <div style="flex:1"></div>
    <span id="wallet-status" class="status">Nicht verbunden</span>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<div class="container">

  <div class="card">
    <div class="body">
      <h3>Post verfassen</h3>
      <textarea id="postText" maxlength="140"></textarea>
      <div style="display:flex;align-items:center;margin-top:6px">
        <span class="small">Geb√ºhr: 0.001 SOL</span>
        <div style="flex:1"></div>
        <button id="postBtn" class="btn">Posten</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="body"><h3>Community Feed</h3></div>
    <div id="feed"></div>
  </div>

</div>

<script>
/* CONFIG */
const SUPABASE_URL = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* UI refs */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");

let wallet = null;

/* Wallet Functions */
function getWallet(){return window.phantom?.solana || window.solana;}
function uiConnected(pk){statusEl.textContent = `‚úÖ ${pk.slice(0,4)}...${pk.slice(-4)}`;connectBtn.textContent="Disconnect";}
function uiDisconnected(){statusEl.textContent="Nicht verbunden";connectBtn.textContent="Wallet verbinden";}

connectBtn.onclick = async()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p) return alert("Phantom fehlt!");
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet=null; uiDisconnected();
}

/* Send payment */
async function pay(amount){
  const p = getWallet();
  const conn = new solanaWeb3.Connection(RPC,"confirmed");
  const tx = new solanaWeb3.Transaction();
  tx.add(solanaWeb3.SystemProgram.transfer({
    fromPubkey:p.publicKey,toPubkey:new solanaWeb3.PublicKey(RECEIVER_WALLET),
    lamports:amount*solanaWeb3.LAMPORTS_PER_SOL
  }));
  tx.feePayer=p.publicKey;
  tx.recentBlockhash=(await conn.getLatestBlockhash()).blockhash;
  const signed = await p.signTransaction(tx);
  return await conn.sendRawTransaction(signed.serialize());
}

/* NFT Avatar */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;
  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({jsonrpc:"2.0",id:"nft",method:"getAssetsByOwner",params:{ownerAddress:pub}})
  });
  const nfts = (await r.json())?.result?.items||[];
  const img = nfts.find(n=>n.content?.metadata?.image)?.content?.metadata?.image;
  if(img) localStorage.setItem("a_"+pub,img);
  return img;
}

/* DB ops */
async function savePost(text,tx){
  await db.from("posts").insert([{wallet,content:text,tx}]);
}

async function loadFeed(){
  const {data} = await db.from("posts").select("*").order("created_at",{ascending:false});
  feed.innerHTML = "";
  for(const p of data){
    const img = await avatar(p.wallet);
    feed.innerHTML += `
      <div class="post">
        <div class="avatar">${img?`<img src="${img}">`:""}</div>
        <div>
          <b>${p.wallet.slice(0,6)}...</b>
          <p>${p.content}</p>
          <a class="small" target="_blank" href="https://solscan.io/tx/${p.tx}">TX ansehen</a><br>
          <button class="tip-btn" onclick="tip('${p.wallet}')">Tip üí∏</button>
        </div>
      </div>`;
  }
}

window.tip = async (to)=>{
  alert("Tip kommt Phase 2 ‚úÖ");
}

/* Post action */
postBtn.onclick = async()=>{
  const text = postText.value.trim();
  if(!wallet) return alert("Wallet verbinden!");
  if(!text) return alert("Text fehlt!");

  postBtn.disabled=true; postBtn.textContent="Sende 0.001 SOL...";

  try{
    const tx = await pay(0.001);
    await savePost(text,tx);
    postText.value="";
    alert("‚úÖ Geschickt & gespeichert!");
  } catch(e){alert("‚ùå Fehler:"+e.message);}
  
  postBtn.disabled=false; postBtn.textContent="Posten";
  loadFeed();
}

/* init */
loadFeed();
</script>
</body>
</html>
