<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/favicon.png">
<title>Gobbles ‚Äî Cope Harder!</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --ink:#e9fbff; --muted:#9ed9e6; --accent:#00eaff;
    --good:#14F195; --bad:#ff6b6b; --purple:#9945FF; --blue:#00eaff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.08),transparent 60%),
    linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:var(--accent)}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.94),rgba(10,15,22,.6));border-bottom:1px solid rgba(255,255,255,.06)}
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  .brand-logo{width:38px;height:38px;border-radius:8px;object-fit:cover;border:2px solid rgba(0,234,255,0.5);box-shadow:0 0 12px rgba(0,234,255,0.35)}
  .brand-main{font-weight:800;font-size:20px;background:linear-gradient(90deg,#00eaff,#9945FF,#14f195);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .btn{appearance:none;border:none;background:linear-gradient(135deg,var(--blue),var(--purple));color:var(--ink);
    border:1px solid rgba(255,255,255,.3);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    box-shadow:0 0 20px rgba(0,234,255,0.3);transition:all 0.3s ease;}
  .btn:hover{box-shadow:0 0 30px rgba(0,234,255,0.5);transform:translateY(-1px)}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(17,24,39,.6),rgba(7,10,16,.7));
    border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
  .card .body{padding:14px}
  .post {
    padding:12px;
    display:grid;
    grid-template-columns:48px 1fr;
    gap:12px;
    border-bottom:1px solid rgba(255,255,255,.04);
    opacity:0;
    animation:fadeUp .35s ease forwards;
    transition:0.25s ease;
  }
  .post:hover {
    background:rgba(0,255,180,0.05);
    box-shadow:0 0 12px rgba(0,255,180,0.15);
    transform:translateY(-2px);
  }
  .avatar {
    width:48px;height:48px;border-radius:12px;
    background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);
    overflow:hidden;display:block;
    animation:pulseGlow 3s infinite ease-in-out;
    box-shadow:0 0 8px rgba(0,255,180,0.3);
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .muted{color:var(--muted);font-size:12px}
  textarea{background:#09101a;border:2px solid rgba(0,234,255,0.3);color:var(--ink);border-radius:12px;padding:14px;
    font:inherit;width:100%;height:120px;resize:vertical;box-shadow:0 0 15px rgba(0,234,255,0.1);transition:all 0.3s ease;}
  textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 20px rgba(0,234,255,0.3)}
  .small{font-size:12px;color:var(--muted)}
  
  /* Post Actions */
  .post-actions{display:flex;gap:18px;margin-top:6px;align-items:center}
  .icon-btn{cursor:pointer;font-size:14px;color:var(--muted);transition:all 0.2s ease;padding:4px 8px;border-radius:6px}
  .icon-btn:hover{color:var(--accent);background:rgba(0,234,255,0.1)}
  
  .tip-btn{background:linear-gradient(135deg,#062018,#0a2a22);border:1px solid #00ffa388;color:#00ffa3;
    margin-top:4px;padding:6px 12px;font-size:12px;border-radius:8px;cursor:pointer;box-shadow:0 0 10px rgba(0,255,163,0.2)}
  .tip-btn:hover{box-shadow:0 0 15px rgba(0,255,163,0.4)}
  
  .input-group{margin-bottom:12px}
  .input-label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
  .text-input{background:#09101a;border:2px solid rgba(255,255,255,.1);color:var(--ink);border-radius:10px;padding:10px 12px;
    width:100%;font:inherit;transition:all 0.3s ease;box-shadow:0 0 10px rgba(0,0,0,0.2)}
  .text-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 15px rgba(0,234,255,0.2)}

  .sol-icon{
    width:20px;
    height:20px;
    border-radius:6px;
  }
  
  .vote-btn{
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:4px;
    font-size:14px;
    color:#7b8ca4; /* muted gray */
    transition:0.2s;
    padding:4px 8px;
    border-radius:6px;
  }

  .vote-btn.active-up{
    color:#14F195; 
    text-shadow:0 0 6px rgba(20,241,149,.7);
    font-weight:700;
  }

  .vote-btn.active-down{
    color:#9945FF;
    text-shadow:0 0 6px rgba(153,69,255,.7);
    font-weight:700;
  }

  .vote-btn:hover{opacity:0.8;}

  /* Fade animation */
  @keyframes fadeUp {
    from { opacity:0;transform:translateY(6px);}
    to   { opacity:1;transform:translateY(0);}
  }

  /* Avatar breathing glow */
  @keyframes pulseGlow {
    0%   { box-shadow:0 0 6px rgba(0,255,180,0.25); }
    50%  { box-shadow:0 0 14px rgba(0,255,180,0.55); }
    100% { box-shadow:0 0 6px rgba(0,255,180,0.25); }
  }
</style>
</head>
<body>
<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="brand-logo" alt="Gobbles">
      <div>
        <div class="brand-main">Gobbles</div>
        <div class="small">Cope Harder!</div>
      </div>
    </div>

    <span id="wallet-status" class="status">Not connected</span>
    <div style="flex:1"></div>
    <button id="connectBtn" class="btn">Connect Wallet</button>
  </div>
</header>

<!-- Sound for posts -->
<audio id="postSound">
  <source src="../sounds/mgs2.mp3" type="audio/mpeg">
</audio>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Create Post</h3>
          <textarea id="postText" maxlength="140" placeholder="What's happening?"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">Fee: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Post</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body"><h3>Community Feed</h3></div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="body">
          <h3>Sentiment & Trends</h3>
          <div class="input-group">
            <label class="input-label">Search Posts</label>
            <input type="text" class="text-input" placeholder="Enter keyword...">
          </div>
          <div class="input-group">
            <label class="input-label">Filter by User</label>
            <input type="text" class="text-input" placeholder="Wallet address...">
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* ---------- LIB INIT ---------- */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- UI refs ---------- */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");
const postSound = document.getElementById("postSound");

let wallet = null;

/* ---------- Wallet helpers ---------- */
function getWallet(){ return window.phantom?.solana || window.solana; }
function uiConnected(pk){ statusEl.textContent = `‚úÖ ${pk.slice(0,4)}...${pk.slice(-4)}`; connectBtn.textContent="Disconnect"; }
function uiDisconnected(){ statusEl.textContent = "Not connected"; connectBtn.textContent="Connect Wallet"; }

connectBtn.onclick = async ()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom wallet not found. Please install Phantom."); window.open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet = null; uiDisconnected();
}

/* ---------- Payment (robust confirm) ---------- */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Please connect wallet first");
  const conn = new solanaWeb3.Connection(RPC, { commitment:"confirmed", confirmTransactionInitialTimeout:120000 });

  const from = p.publicKey;
  const to   = new solanaWeb3.PublicKey(RECEIVER_WALLET);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);

  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("finalized");

  const tx = new solanaWeb3.Transaction({
    feePayer: from,
    recentBlockhash: blockhash
  }).add(
    solanaWeb3.SystemProgram.transfer({ fromPubkey: from, toPubkey: to, lamports })
  );

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false, maxRetries:6 });

  await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
  return sig;
}

/* ---------- NFT Avatar via Helius ---------- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;

  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });
  const json = await r.json();
  const items = json?.result?.items || [];
  // prefer metadata.image, fallback content.files[0].uri
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;

  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* ---------- DB ops ---------- */
async function savePost(text, tx){
  const { error } = await db.from("posts").insert([{ wallet, content:text, tx }]);
  if(error) throw error;
}

/* ---------- VOTING SYSTEM (UPDATED) ---------- */
window.vote = async (id, dir) => {
  if(!wallet) return alert("Please connect your wallet!");

  const success = await db.rpc(
    dir === "up" ? "vote_up" : "vote_down",
    { p_post_id: id, p_wallet: wallet }
  );

  if(!success.error){
    localStorage.setItem("vote_" + id, dir);
  }

  loadFeed(); 
};

/* ---------- Feed loading ---------- */
async function loadFeed(){
  const { data, error } = await db.from("posts").select("*").order("created_at",{ascending:false}).limit(50);
  if(error){ console.error("Supabase load error:", error); return; }

  feed.innerHTML = "";
  for(const p of (data || [])){
    const img = await avatar(p.wallet);
    const userVote = localStorage.getItem("vote_" + p.id);

    feed.innerHTML += `
      <div class="post">
        <div class="avatar">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
        <div>
          <b>${p.wallet.slice(0,6)}...</b>
          <p>${p.content}</p>
          <div class="post-actions">
            
            <span class="vote-btn ${userVote === "up" ? "active-up" : ""}" onclick="vote('${p.id}','up')">
              üëç ${p.upvotes || 0}
            </span>

            <span class="vote-btn ${userVote === "down" ? "active-down" : ""}" onclick="vote('${p.id}','down')">
              üëé ${p.downvotes || 0}
            </span>

            <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
              <img src="../img/1Solana.png" class="sol-icon">
            </span>

            <a target="_blank" class="small" href="https://solscan.io/tx/${p.tx}">
              View TX
            </a>
          </div>
        </div>
      </div>`;
  }
}

/* ---------- Cooldown ---------- */
async function canPost(pub){
  const { data, error } = await db.from("posts").select("created_at").eq("wallet", pub).order("created_at", {ascending:false}).limit(1);
  if(error || !data?.length) return true;
  const last = new Date(data[0].created_at);
  return (Date.now() - last.getTime())/1000 >= 60;
}
function startCooldown(sec){
  let t = sec; postBtn.disabled = true;
  const id = setInterval(()=>{ postBtn.textContent = `Wait ${t--}s`; if(t<0){ clearInterval(id); postBtn.textContent="Post"; postBtn.disabled=false; }}, 1000);
}

/* ---------- Realtime Feed ---------- */
db.channel("public:posts")
  .on("postgres_changes", { event:"INSERT", schema:"public", table:"posts" }, () => loadFeed())
  .subscribe();

/* ---------- Global functions for tipping ---------- */
window.tipUser = async (to) => {
  if(!wallet) return alert("Please connect your wallet to tip!");
  if(to === wallet) return alert("You can't tip yourself! üòÇ");
  alert("Tip feature coming in Phase 2 ‚úÖ");
};

/* ---------- Post action ---------- */
postBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!wallet) return alert("Please connect your wallet first!");
  if(!text) return alert("Please enter some text!");

  // Cooldown
  const ok = await canPost(wallet);
  if(!ok){ alert("‚è≥ You can only post once every 60 seconds!"); startCooldown(60); return; }

  // Directly add post to top of feed UI (optimistic UI)
  const img = await avatar(wallet);
  const newPostHTML = `
    <div class="post">
      <div class="avatar">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
      <div>
        <b>${wallet.slice(0,6)}...</b>
        <p>${text}</p>
        <div class="post-actions">
          <span class="vote-btn upvote" data-id="temp">üëç 0</span>
          <span class="vote-btn downvote" data-id="temp">üëé 0</span>
          <span class="icon-btn sol-btn">
            <img src="../img/1Solana.png" style="width:18px;height:18px;">
          </span>
          <span class="small">pending blockchain...</span>
        </div>
      </div>
    </div>
  `;

  feed.innerHTML = newPostHTML + feed.innerHTML;

  postBtn.disabled = true; postBtn.textContent = "Sending 0.001 SOL...";

  try{
    const sig = await pay(0.001);
    await savePost(text, sig);
    postText.value = "";
    
    // Play sound effect
    postSound.play().catch(e => console.log("Sound play failed:", e));
    
    alert("‚úÖ Posted successfully!");
  }catch(e){
    alert("‚ùå Error: " + (e?.message || e));
    // Remove the optimistic post if there was an error
    loadFeed();
  }

  postBtn.disabled = false; postBtn.textContent = "Post";
  loadFeed();
};

/* ---------- Init ---------- */
loadFeed();
</script>
</body>
</html>
