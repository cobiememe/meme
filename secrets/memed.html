<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cobie — Crypto Sentiment Social (MVP Layout)</title>

<!-- Solana Web3 (IIFE build) -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

<style>
  :root{
    --bg:#0b0f14; --ink:#e9fbff; --muted:#9ed9e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.04),transparent 60%),linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.9),rgba(10,15,22,.5));border-bottom:1px solid rgba(255,255,255,.06)}
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap { display:flex; align-items:center; gap:10px; }
  .brand-logo { width:38px; height:38px; border-radius:8px; object-fit:cover; border:2px solid rgba(0,234,255,0.5); box-shadow:0 0 12px rgba(0,234,255,0.4); }
  .brand-main { font-size:20px; background:linear-gradient(90deg,#00eaff,#14f195,#00ffa3); -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation:brandPulse 2.2s infinite ease-in-out; }
  @keyframes brandPulse{0%{text-shadow:0 0 2px rgba(0,234,255,.7),0 0 6px rgba(0,191,255,.4)}50%{text-shadow:0 0 6px rgba(0,234,255,1),0 0 16px rgba(20,241,149,.7)}100%{text-shadow:0 0 2px rgba(0,234,255,.7),0 0 6px rgba(0,191,255,.4)}}
  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .btn{background:linear-gradient(135deg,rgba(0,234,255,.12),rgba(0,191,255,.12));border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(17,24,39,.6);border:1px solid rgba(255,255,255,.06);border-radius:16px}
  .card .body{padding:14px}
  .post{padding:14px;display:grid;grid-template-columns:42px 1fr;gap:12px}
  .avatar{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3,#9945FF)}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>

<body>
<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="brand-logo" alt="logo">
      <div>
        <div class="brand-main">Cobie</div>
        <div style="font-size:14px;color:#9ed9e6">Sentiment Social <span style="font-size:12px;color:rgba(255,255,255,.55)">— MVP</span></div>
      </div>
    </div>

    <span id="wallet-status" class="status">Nicht verbunden</span>
    <div style="flex:1"></div>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Post verfassen</h3>
          <textarea id="postText" maxlength="140" style="width:100%;height:90px"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="muted">Gebühr: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Posten</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Community Feed</h3>
        </div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="body"><h3>Sentiment & Trends</h3></div>
      </div>
    </aside>
  </div>
</main>

<script>
/*
  Updated memed.html:
  - Uses the proven sendSOL() flow from secret9.html (signTransaction + sendRawTransaction)
  - Provider detection compatible with secret9 (window.phantom?.solana || window.solana)
  - Mainnet RPC (public) is used (same as before). Use real SOL and be careful.
*/

// UI refs
const walletStatus = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");

let provider = null;
let publicKey = null;
let walletConnected = false;

// Receiver (same as in secret9.html)
const RECEIVER_STR = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";

// RPC: mainnet
const RPC_URL = "https://api.mainnet-beta.solana.com";

// provider getter (compatible with secret9)
function getProvider() {
  // prefer window.phantom?.solana if available (like secret9)
  if (window.phantom?.solana) return window.phantom.solana;
  if (window.solana) return window.solana;
  return null;
}

// UI helper
function setUIConnected(pk) {
  walletStatus.textContent = "✅ " + pk.slice(0,4) + "..." + pk.slice(-4);
  connectBtn.textContent = "Disconnect";
}
function setUIDisconnected() {
  walletStatus.textContent = "Nicht verbunden";
  connectBtn.textContent = "Wallet verbinden";
}

// Connect / disconnect flows
async function connectWallet() {
  const p = getProvider();
  if (!p) {
    alert("Phantom Wallet nicht gefunden. Installiere es bitte.");
    window.open("https://phantom.app", "_blank");
    return;
  }
  try {
    provider = p;
    const resp = await provider.connect();
    publicKey = resp.publicKey.toString();
    walletConnected = true;
    setUIConnected(publicKey);
    // bind disconnect handler once
    if (!provider.__bound) {
      provider.on && provider.on("disconnect", () => {
        provider = null;
        publicKey = null;
        walletConnected = false;
        setUIDisconnected();
      });
      provider.__bound = true;
    }
  } catch (e) {
    console.error("connectWallet error", e);
    alert("Verbindung fehlgeschlagen: " + (e?.message || e));
  }
}

async function disconnectWallet() {
  try {
    const p = getProvider();
    if (p && p.disconnect) await p.disconnect();
  } catch (e) {
    console.warn("disconnect error", e);
  }
  provider = null;
  publicKey = null;
  walletConnected = false;
  setUIDisconnected();
}

connectBtn.onclick = () => {
  walletConnected ? disconnectWallet() : connectWallet();
};

// sendSOL based on secret9 logic (works with Phantom)
async function sendSOL(amount) {
  try {
    const p = getProvider();
    if (!p || !p.isConnected) {
      alert("Bitte zuerst Wallet verbinden");
      return false;
    }

    walletStatus.textContent = `⏳ Sending ${amount} SOL...`;

    const connection = new solanaWeb3.Connection(RPC_URL, "confirmed");
    const RECEIVER = new solanaWeb3.PublicKey(RECEIVER_STR);
    const SENDER = p.publicKey;

    const lamports = Math.floor(amount * solanaWeb3.LAMPORTS_PER_SOL);
    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: SENDER,
        toPubkey: RECEIVER,
        lamports
      })
    );

    // set fee payer & recent blockhash as in secret9
    tx.feePayer = SENDER;
    const { blockhash } = await connection.getLatestBlockhash('confirmed');
    tx.recentBlockhash = blockhash;

    // sign transaction with Phantom (user approves in popup)
    const signed = await p.signTransaction(tx);

    // send raw transaction
    const sig = await connection.sendRawTransaction(signed.serialize(), { skipPreflight: false, maxRetries: 2 });
    console.log("Transaction sent:", sig);
    walletStatus.textContent = "✅ Transaction sent!";
    // confirm (wait until confirmed)
    await connection.confirmTransaction(sig, "confirmed");
    // small delay then reset status
    setTimeout(() => { if (walletStatus.textContent.includes('sent')) walletStatus.textContent = "✅ Ready"; }, 2000);
    return sig;
  } catch (e) {
    console.error("sendSOL error:", e);
    // more helpful message from wallet if available
    const msg = e?.message || String(e);
    alert("Zahlung abgebrochen: " + msg);
    walletStatus.textContent = "❌ Payment failed";
    return false;
  }
}

// Add post to UI feed
function addPost(text) {
  const pkShort = publicKey ? (publicKey.slice(0,6) + '...') : 'Guest';
  feed.innerHTML = `
    <div class="post">
      <div class="avatar"></div>
      <div><b>${pkShort}</b><p>${text}</p></div>
    </div>
  ` + feed.innerHTML;
}

// Post button logic: send 0.001 SOL then create post if success
postBtn.onclick = async () => {
  const text = document.getElementById("postText").value.trim();
  if (!walletConnected) return alert("Bitte Wallet verbinden");
  if (!text) return alert("Bitte Text eingeben");

  postBtn.disabled = true;
  postBtn.textContent = "Sende 0.001 SOL...";

  try {
    const sig = await sendSOL(0.001); // uses secret9 flow
    if (!sig) {
      // sendSOL returned false -> aborted or failed
      throw new Error("Payment aborted or failed");
    }
    // success
    addPost(text);
    alert("✅ Zahlung erfolgreich\nTX: " + sig + "\nExplorer: https://solscan.io/tx/" + sig);
  } catch (e) {
    console.log("Post/payment failed:", e);
    // sendSOL already alerted; we keep user inform
  } finally {
    postBtn.disabled = false;
    postBtn.textContent = "Posten";
    document.getElementById("postText").value = "";
  }
};

// on load, set status if provider already connected (same pattern as secret9)
window.addEventListener("load", () => {
  const p = getProvider();
  if (p && p.isConnected && p.publicKey) {
    publicKey = p.publicKey.toString();
    walletConnected = true;
    setUIConnected(publicKey);
  } else {
    setUIDisconnected();
  }
});
</script>
</body>
</html>
