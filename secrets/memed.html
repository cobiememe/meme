<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="../img/favicon.png">
<title>Gobbles ‚Äî Cope Harder!</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --ink:#e9fbff; --muted:#9ed9e6; --accent:#00eaff;
    --good:#14F195; --bad:#ff6b6b; --purple:#9945FF; --blue:#00eaff;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;
    background:
      radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.08),transparent 60%),
      linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial
  }
  a{color:var(--accent)}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px}
  header{
    position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.94),rgba(10,15,22,.6));
    border-bottom:1px solid rgba(255,255,255,.06)
  }
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}

  /* Logo */
  .logo-anim{
    width:52px;height:52px;border-radius:10px;border:3px solid #00eaff77;object-fit:cover;
    box-shadow:0 0 12px rgba(0,234,255,0.35)
  }
  .brand-main{
    font-weight:800;font-size:26px;
    background:linear-gradient(90deg,#00eaff,#9945FF,#14F195);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent
  }
  /* nur das G wobbelt & rotiert */
  .g-wobble{display:inline-block;transform-origin:center;animation:wobble 3s ease-in-out infinite, spinPulse 9s linear infinite}
  @keyframes wobble{0%,100%{transform:rotate(0) scale(1)}25%{transform:rotate(-5deg) scale(1.10)}50%{transform:rotate(5deg) scale(1.10)}75%{transform:rotate(-3deg) scale(1.05)}}
  @keyframes spinPulse{0%,90%{transform:rotate(0)}100%{transform:rotate(360deg)}}

  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .btn{
    appearance:none;border:none;
    background:linear-gradient(135deg,var(--blue),var(--purple));color:var(--ink);
    border:1px solid rgba(255,255,255,.3);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    box-shadow:0 0 20px rgba(0,234,255,0.3);transition:all 0.3s ease;
  }
  .btn:hover{box-shadow:0 0 30px rgba(0,234,255,0.5);transform:translateY(-1px)}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,rgba(17,24,39,.6),rgba(7,10,16,.7));
    border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3)
  }
  .card .body{padding:14px}

  .post{
    padding:12px;display:grid;grid-template-columns:48px 1fr;gap:12px;
    border-bottom:1px solid rgba(255,255,255,.04);
    opacity:0;animation:fadeUp .35s ease forwards;transition:.25s ease;
  }
  .post:hover{background:rgba(0,255,180,0.05);box-shadow:0 0 12px rgba(0,255,180,0.15);transform:translateY(-2px)}

  /* Boom-Effekt f√ºr frisch geposteten Block */
  .post-boom{animation:dropBoom .55s cubic-bezier(.17,.67,.45,1.32) forwards;opacity:0}
  @keyframes dropBoom{
    0%{transform:translateY(-120px) scale(.8) rotate(-3deg);opacity:0}
    80%{transform:translateY(8px) scale(1.03);opacity:1}
    100%{transform:translateY(0) scale(1);box-shadow:0 0 18px rgba(0,255,150,.4)}
  }

  .avatar{
    width:48px;height:48px;border-radius:12px;
    background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);
    overflow:hidden;display:block;animation:pulseGlow 3s infinite ease-in-out;box-shadow:0 0 8px rgba(0,255,180,.3)
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  @keyframes pulseGlow{0%{box-shadow:0 0 6px rgba(0,255,180,.25)}50%{box-shadow:0 0 14px rgba(0,255,180,.55)}100%{box-shadow:0 0 6px rgba(0,255,180,.25)}}

  .muted{color:var(--muted);font-size:12px}
  textarea{
    background:#09101a;border:2px solid rgba(0,234,255,0.3);color:var(--ink);border-radius:12px;padding:14px;
    font:inherit;width:100%;height:120px;resize:vertical;box-shadow:0 0 15px rgba(0,234,255,0.1);transition:.3s ease;
  }
  textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 20px rgba(0,234,255,0.3)}
  .small{font-size:12px;color:var(--muted)}

  .post-actions{display:flex;gap:18px;margin-top:6px;align-items:center}
  .icon-btn{cursor:pointer;font-size:14px;color:var(--muted);transition:.2s ease;padding:4px 8px;border-radius:6px}
  .icon-btn:hover{color:var(--accent);background:rgba(0,234,255,0.1)}
  .sol-icon{width:20px;height:20px;border-radius:6px}

  @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  /* Sterne/Partikel-Leisten links & rechts (Canvas liegt dahinter) */
  #particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
  main, header{position:relative;z-index:1}
</style>
</head>
<body>
<!-- Sterne-Canvas im Hintergrund -->
<canvas id="particles"></canvas>

<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="logo-anim" alt="Gobbles">
      <div>
        <div class="brand-main"><span class="g-wobble">G</span>obbles</div>
        <div class="small">Cope Harder!</div>
      </div>
    </div>

    <div style="flex:1"></div>
    <span id="wallet-status" class="status">Nicht verbunden</span>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<!-- Sounds -->
<audio id="postSound"><source src="../sounds/mgs2.mp3" type="audio/mpeg"></audio>
<audio id="boomSound"><source src="../sounds/boom.mp3" type="audio/mpeg"></audio>

<main class="container">
  <div class="grid">
    <!-- Links: Composer + Feed -->
    <section>
      <div class="card">
        <div class="body">
          <h3>Post verfassen</h3>
          <textarea id="postText" maxlength="140" placeholder="Was geht ab?"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">Geb√ºhr: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Posten</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body"><h3>Community Feed</h3></div>
        <div id="feed"></div>
      </div>
    </section>

    <!-- Rechts: Platzhalter-Panel (unver√§ndert) -->
    <aside>
      <div class="card">
        <div class="body">
          <h3>Sentiment & Trends</h3>
          <div class="small">Coming soon‚Ä¶</div>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* ---------- LIB INIT ---------- */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- UI refs ---------- */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");
const postSound = document.getElementById("postSound");
const boomSound = document.getElementById("boomSound");

let wallet = null;

/* ---------- Sterne/Partikel ---------- */
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");
let particles = [];
function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight }
addEventListener("resize", resizeCanvas); resizeCanvas();
for(let i=0;i<90;i++){
  particles.push({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height,
    sx:(Math.random()-.5)*0.25, sy:(Math.random()-.5)*0.25,
    r: Math.random()*1.6+.4, a: Math.random()*.6+.2
  });
}
(function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    p.x+=p.sx; p.y+=p.sy;
    if(p.x<0) p.x=canvas.width; if(p.x>canvas.width) p.x=0;
    if(p.y<0) p.y=canvas.height; if(p.y>canvas.height) p.y=0;
    ctx.fillStyle=`rgba(0,234,255,${p.a})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });
  requestAnimationFrame(animate);
})();

/* ---------- Wallet ---------- */
function getWallet(){ return window.phantom?.solana || window.solana; }
function short(pk){ return `${pk.slice(0,4)}‚Ä¶${pk.slice(-4)}`; }

function uiConnected(pk){
  statusEl.textContent = `‚úÖ ${short(pk)}`;
  connectBtn.textContent = "Disconnect";
}
function uiDisconnected(){
  statusEl.textContent = "Nicht verbunden";
  connectBtn.textContent = "Wallet verbinden";
}

connectBtn.onclick = async ()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom Wallet nicht gefunden. Bitte installieren."); open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet = null; uiDisconnected();
}

/* ---------- Payment ---------- */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Bitte Wallet verbinden");
  const conn = new solanaWeb3.Connection(RPC, { commitment:"confirmed", confirmTransactionInitialTimeout:120000 });

  const from = p.publicKey;
  const to   = new solanaWeb3.PublicKey(RECEIVER_WALLET);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);

  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("finalized");

  const tx = new solanaWeb3.Transaction({
    feePayer: from,
    recentBlockhash: blockhash
  }).add(
    solanaWeb3.SystemProgram.transfer({ fromPubkey: from, toPubkey: to, lamports })
  );

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false, maxRetries:6 });
  await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
  return sig;
}

/* ---------- NFT Avatar ---------- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;
  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });
  const json = await r.json();
  const items = json?.result?.items || [];
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;
  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* ---------- DB ---------- */
async function savePost(text, tx){
  const { error } = await db.from("posts").insert([{ wallet, content:text, tx }]);
  if(error) throw error;
}

/* ---------- Feed (stabil, neueste oben) ---------- */
async function loadFeed(){
  const { data, error } = await db.from("posts").select("*").order("created_at",{ascending:false}).limit(50);
  if(error){ console.error("Supabase load error:", error); return; }

  // posts zuerst in Array bauen (damit Avatare die Sortierung nicht zerrei√üen)
  const parts = [];
  for(const p of (data||[])){
    const img = await avatar(p.wallet);
    parts.push(`
      <div class="post">
        <div class="avatar">${img?`<img src="${img}" alt="pfp">`:""}</div>
        <div>
          <b>${p.wallet.slice(0,6)}...</b>
          <p>${p.content}</p>
          <div class="post-actions">
            <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
              <img src="../img/1Solana.png" class="sol-icon">
            </span>
            <a target="_blank" class="small" href="https://solscan.io/tx/${p.tx}">TX ansehen</a>
          </div>
        </div>
      </div>
    `);
  }
  feed.innerHTML = parts.join("");
}

/* ---------- Cooldown ---------- */
async function canPost(pub){
  const { data, error } = await db.from("posts").select("created_at").eq("wallet", pub).order("created_at",{ascending:false}).limit(1);
  if(error || !data?.length) return true;
  const last = new Date(data[0].created_at);
  return (Date.now() - last.getTime())/1000 >= 60;
}
function startCooldown(sec){
  let t=sec; postBtn.disabled=true;
  const id=setInterval(()=>{ postBtn.textContent=`Warte ${t--}s`; if(t<0){ clearInterval(id); postBtn.textContent="Posten"; postBtn.disabled=false; }},1000);
}

/* ---------- Tipping Platzhalter ---------- */
window.tipUser = async (to)=>{
  if(!wallet) return alert("Zum Tippen bitte Wallet verbinden!");
  if(to === wallet) return alert("Dich selbst tippen? üòÇ Nein.");
  alert("Tip kommt in Phase 2 ‚úÖ");
};

/* ---------- Posten ---------- */
postBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!wallet) return alert("Bitte Wallet verbinden!");
  if(!text) return alert("Bitte Text eingeben!");

  // Cooldown
  const ok = await canPost(wallet);
  if(!ok){ alert("‚è≥ Nur alle 60 Sekunden posten!"); startCooldown(60); return; }

  // Boom-Sound + Drop-Animation f√ºr den visuellen Kick
  try{ boomSound.currentTime=0; boomSound.play(); }catch(e){}

  const img = await avatar(wallet);
  const temp = document.createElement("div");
  temp.className = "post post-boom";
  temp.innerHTML = `
    <div class="avatar">${img?`<img src="${img}" alt="pfp">`:""}</div>
    <div>
      <b>${wallet.slice(0,6)}...</b>
      <p>${text}</p>
      <div class="post-actions">
        <span class="icon-btn sol-btn"><img src="../img/1Solana.png" class="sol-icon"></span>
        <span class="small">wird gespeichert‚Ä¶</span>
      </div>
    </div>`;
  feed.prepend(temp);

  postBtn.disabled = true; postBtn.textContent = "Sende 0.001 SOL...";

  try{
    const sig = await pay(0.001);
    await savePost(text, sig);
    postText.value = "";
    try{ postSound.currentTime=0; postSound.play(); }catch(e){}
    alert("‚úÖ Geschickt & gespeichert!");
  }catch(e){
    alert("‚ùå Fehler: " + (e?.message || e));
    loadFeed(); // Optimistic Block ggf. √ºberschreiben
  }

  postBtn.disabled = false; postBtn.textContent = "Posten";
  loadFeed();
};

/* ---------- Realtime: neue Posts oben ---------- */
db.channel("public:posts")
  .on("postgres_changes", { event:"INSERT", schema:"public", table:"posts" }, () => loadFeed())
  .subscribe();

/* ---------- Init ---------- */
loadFeed();

/* ---------- (Optional) SNS / .sol-Namen ‚Äì AUSKOMMENTIERT ----------
   Aktivieren, wenn du testen willst:
   1) auskommentieren
   2) im connect() nach uiConnected(wallet) -> resolveName(wallet)
------------------------------------------------------------------ */
// (async function snsSetup(){
//   const { PublicKey, Connection } = await import("https://esm.sh/@solana/web3.js@1.95.3");
//   const { reverseLookup } = await import("https://esm.sh/@bonfida/spl-name-service@3.1.0");
//   const SNS_CONN = new Connection(RPC, "confirmed");
//   window.resolveName = async (base58) => {
//     try{
//       const name = await reverseLookup(SNS_CONN, new PublicKey(base58)).catch(()=>null);
//       if(name){
//         statusEl.textContent = `‚úÖ ${short(base58)} (${name})`;
//       }
//     }catch(_){}
//   };
// })();
</script>
</body>
</html>
