<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cobie — Crypto Sentiment Social (MVP Layout)</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{--bg:#0b0f14;--ink:#e9fbff;--muted:#9ed9e6;}
  *{box-sizing:border-box}
  html,body{margin:0;background:#05080c;color:var(--ink);font-family:Inter,system-ui}
  .container{max-width:1200px;margin:0 auto;padding:16px;min-height:100vh}
  header{position:sticky;top:0;backdrop-filter:blur(6px);background:#0b0f14aa;border-bottom:1px solid #ffffff15}
  .h-wrap{display:flex;align-items:center;gap:12px;padding:12px 16px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  .brand-logo{width:38px;height:38px;border-radius:8px;border:2px solid #00eaff88}
  .brand-main{font-size:20px;background:linear-gradient(90deg,#00eaff,#14f195,#00ffa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid #ffffff15;border-radius:20px}
  .btn{background:#0f1a24;border:1px solid #ffffff15;padding:10px 14px;border-radius:12px;color:white;cursor:pointer}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:#11182799;border:1px solid #ffffff15;border-radius:12px;margin-bottom:12px}
  .card .body{padding:14px}
  .post{padding:12px;display:grid;grid-template-columns:42px 1fr;gap:12px;border-bottom:1px solid #ffffff11}
  .avatar{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3)}
  .muted{font-size:12px;color:var(--muted)}
  a{color:#14f195;text-decoration:none}
</style>
</head>

<body>
<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="brand-logo">
      <div>
        <div class="brand-main">Cobie</div>
        <div style="font-size:13px;color:#9ed9e6">Sentiment Social — MVP</div>
      </div>
    </div>
    <span id="wallet-status" class="status">Nicht verbunden</span>
    <div style="flex:1"></div>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Post verfassen</h3>
          <textarea id="postText" maxlength="140" style="width:100%;height:90px"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="muted">Gebühr: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Posten</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="body"><h3>Community Feed</h3></div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card"><div class="body"><h3>Sentiment & Trends</h3></div></div>
    </aside>
  </div>
</main>

<script>
// ---- SUPABASE CONFIG ----
const supabase = supabase.createClient(
 "https://nigwdyolfgixcejslaue.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw"
);

// ---- SOLANA CONFIG ----
const RECEIVER = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";

let provider, publicKey;
const connectBtn = document.getElementById("connectBtn");
const walletStatus = document.getElementById("wallet-status");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");

function getProvider(){return window.phantom?.solana ?? window.solana;}

function setUI(pk){
  walletStatus.textContent = pk?`✅ ${pk.slice(0,4)}...${pk.slice(-4)}`:"Nicht verbunden";
  connectBtn.textContent = pk?"Disconnect":"Wallet verbinden";
}

// ---- WALLET ----
connectBtn.onclick = async()=>{
  const p = getProvider();
  if(!publicKey){
    const res = await p.connect();
    publicKey = res.publicKey.toString(); setUI(publicKey);
  } else { await p.disconnect(); publicKey=null; setUI(null); }
};

// ---- SEND SOL ----
async function sendSOL(){
  const p=getProvider(); const conn=new solanaWeb3.Connection(RPC_URL);
  const S=p.publicKey; const R=new solanaWeb3.PublicKey(RECEIVER);
  const lam=0.001*solanaWeb3.LAMPORTS_PER_SOL;

  const tx=new solanaWeb3.Transaction().add(solanaWeb3.SystemProgram.transfer({fromPubkey:S,toPubkey:R,lamports:lam}));
  tx.feePayer=S; tx.recentBlockhash=(await conn.getLatestBlockhash()).blockhash;
  const sig=await conn.sendRawTransaction((await p.signTransaction(tx)).serialize());
  await conn.confirmTransaction(sig);
  return sig;
}

// ---- DB SAVE ----
async function savePost(text,tx){
  await supabase.from("posts").insert({wallet:publicKey,content:text,tx});
}

// ---- LOAD FEED ----
async function loadFeed(){
  const {data}=await supabase.from("posts").select("*").order("created_at",{ascending:false}).limit(50);
  feed.innerHTML = data.map(p=>`
    <div class="post">
      <div class="avatar"></div>
      <div>
        <b>${p.wallet.slice(0,6)}...</b>
        <p>${p.content}</p>
        <a href="https://solscan.io/tx/${p.tx}" target="_blank" class="muted">TX ansehen</a>
      </div>
    </div>
  `).join("");
}

loadFeed();
supabase.channel("realtime")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},loadFeed)
  .subscribe();

// ---- POST ----
postBtn.onclick = async()=>{
  const text=document.getElementById("postText").value.trim();
  if(!publicKey) return alert("Wallet verbinden");
  if(!text) return alert("Text eingeben");

  postBtn.disabled=true; postBtn.textContent="Sende...";

  try{
    const tx=await sendSOL();
    await savePost(text,tx);
    document.getElementById("postText").value="";
  }catch(e){alert("Fehler: "+e.message);} 

  postBtn.disabled=false; postBtn.textContent="Posten";
};
</script>
</body>
</html>
