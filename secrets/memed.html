<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/favicon.png">
  
  <!-- Barlow Font -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700;800&display=swap" rel="stylesheet">
  
<title>Gobbles ‚Äî Cope Harder!</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart Data Labels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* ALL DEIN ORIGINAL CSS BLEIBT UNVER√ÑNDERT */
  :root{
    --bg:#0b0f14; --panel:#0f1622; --ink:#e9fbff; --muted:#9ed9e6; --accent:#00eaff;
    --good:#14F195; --bad:#ff6b6b; --purple:#9945FF; --blue:#00eaff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.08),transparent 60%),
    linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink);font-family:"Barlow", system-ui, -apple-system, Segoe UI, Roboto, Arial}
  a{color:var(--accent)}
  
  /* Barlow Font f√ºr Headlines */
  h1, h2, h3, .brand-wrap b {
    font-family:"Barlow", sans-serif;
    font-weight:800; /* ExtraBold like X headlines */
  }

  body {
    font-family:"Barlow", sans-serif;
    font-weight:400; /* regular for posts */
  }
  
  /* ‚≠ê Partikel/Sterne Hintergrund */
  #particles {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px;position:relative;z-index:1}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.94),rgba(10,15,22,.6));border-bottom:1px solid rgba(255,255,255,.06)}
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  
  /* Logo Animation - komplett √ºberarbeitet */
  .logo-anim {
    width: 52px;
    height: 52px;
    border-radius: 10px;
    border: 3px solid #00eaff77;
    object-fit: cover;
    box-shadow: 0 0 12px rgba(0,234,255,0.35);
    animation: wobble 3s ease-in-out infinite, spinPulse 9s linear infinite;
    cursor: pointer; /* F√ºr Easter Egg */
    transition: opacity 0.4s ease; /* F√ºr Logo-Wechsel */
  }

  /* Nur das 'G' hat spezielle Animation */
 .g-wobble {
  display: inline-block;
  transform-origin: center;
  animation: wobble 3s ease-in-out infinite, spinPulse 9s linear infinite;
  background: linear-gradient(90deg,#00eaff,#9945FF,#14f195);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
  
  @keyframes wobble {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-5deg) scale(1.10); }
    50% { transform: rotate(5deg) scale(1.10); }
    75% { transform: rotate(-3deg) scale(1.05); }
  }
  
  @keyframes spinPulse {
    0%, 90% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .brand-main {
    font-weight:800;
    font-size: 26px;
    background:linear-gradient(90deg,#00eaff,#9945FF,#14f195);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent
  }

  /* üîπ Cobie Home Button */
  .home-link {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: 40px;
    text-decoration: none;
    background: rgba(255,255,255,0.03);
    padding: 6px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    transition: all 0.3s ease;
  }
  .home-link:hover {
    background: rgba(0,234,255,0.08);
    border-color: rgba(0,234,255,0.4);
    box-shadow: 0 0 12px rgba(0,234,255,0.3);
    transform: translateY(-1px);
  }

  .cobie-gif {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 12px rgba(0,234,255,0.4);
    animation: pulseCobie 3s ease-in-out infinite;
  }

  .home-text {
    color: #9ed9e6;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.4px;
  }

  @keyframes pulseCobie {
    0%,100% { box-shadow: 0 0 6px rgba(0,234,255,0.3); }
    50% { box-shadow: 0 0 18px rgba(0,234,255,0.6); }
  }

  /* Wallet + Profile Bereich */
  .header-right-wrap {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-left: auto;
  }
  .profile-link {
  position: relative;
  font-weight: 700;
  font-size: 14px;
  color: #fff;
  padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
    background: linear-gradient(135deg,#00eaff,#9945FF,#14f195);
    box-shadow: 0 0 18px rgba(0,234,255,0.4);
    overflow: hidden;
    transition: all 0.4s ease;
  }

  /* Glitzer-Rand Animation */
  .profile-link::before {
    content: "";
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 14px;
    background: linear-gradient(
      90deg,
      #00eaff,
      #9945FF,
      #14f195,
      #00eaff
    );
    background-size: 300%;
    z-index: -1;
    filter: blur(6px);
    animation: borderFlow 6s linear infinite;
    opacity: 0.9;
  }

  @keyframes borderFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .profile-link:hover {
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 0 25px rgba(0,234,255,0.7);
  }

  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .btn{appearance:none;border:none;background:linear-gradient(135deg,var(--blue),var(--purple));color:var(--ink);
    border:1px solid rgba(255,255,255,.3);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    box-shadow:0 0 20px rgba(0,234,255,0.3);transition:all 0.3s ease;}
  .btn:hover{box-shadow:0 0 30px rgba(0,234,255,0.5);transform:translateY(-1px)}
  .connect-btn { margin-left: 10px; }
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(17,24,39,.6),rgba(7,10,16,.7));
    border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
  .card .body{padding:14px}

  /* === Gobbles Post Card === */
  .post {
    position: relative;
    display: grid;
    grid-template-columns: 48px 1fr;
    gap: 12px;
    padding: 14px;
    margin-bottom: 10px;
    border-radius: 14px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    transition: transform .3s ease, box-shadow .3s ease, background .3s ease;
    overflow: hidden;
    will-change: transform, box-shadow;
    opacity: 0;
    animation: fadeUp .35s ease forwards;
  }

  /* Inhalt bleibt √ºber Glow */
  .post > * {
    position: relative;
    z-index: 2;
  }

  /* Hover-Neonrahmen + Shine-Flow */
  .post:hover::before {
    content: "";
    position: absolute;
    inset: 0;
    padding: 2px;
    border-radius: 14px;
    background: linear-gradient(90deg, #00ffc8, #0ff0fc, #9945FF, #00ffc8);
    background-size: 300% 100%;
    animation: gobblesBorderFlow 2.5s linear infinite;
    filter: drop-shadow(0 0 12px rgba(0,255,200,0.45));
    -webkit-mask:
      linear-gradient(#fff 0 0) content-box,
      linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    z-index: 1;
  }

  /* Optional leichter Glow im Inneren */
  .post:hover::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 14px;
    background: radial-gradient(
      circle at center,
      rgba(0,255,200,0.12),
      rgba(0,255,200,0.02) 70%
    );
    opacity: 0.8;
    animation: gobblesInnerPulse 3s ease-in-out infinite;
    z-index: 0;
  }

  @keyframes gobblesBorderFlow {
    0%   { background-position: 0% 50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  @keyframes gobblesInnerPulse {
    0%,100% { opacity: 0.6; filter: blur(1px); }
    50%     { opacity: 1; filter: blur(2px); }
  }

  /* Hover-Bewegung & Schatten */
  .post:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow:
      0 0 20px rgba(0,255,200,0.15),
      0 0 40px rgba(15,240,252,0.1);
    background: rgba(0,255,200,0.03);
  }
  
  /* Boom-Post Animation */
  .post-boom {
    animation: dropBoom 0.55s cubic-bezier(.17,.67,.45,1.32) forwards;
    opacity: 0;
  }

  @keyframes dropBoom {
    0% {
      transform: translateY(-120px) scale(0.8) rotate(-3deg);
      opacity: 0;
      box-shadow: none;
    }
    80% {
      transform: translateY(8px) scale(1.03);
      opacity: 1;
    }
    100% {
      transform: translateY(0) scale(1);
      box-shadow: 0 0 18px rgba(0,255,150,.4);
    }
  }

  .avatar {
    width:48px;height:48px;border-radius:12px;
    background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);
    overflow:hidden;display:block;
    animation:pulseGlow 3s infinite ease-in-out;
    box-shadow:0 0 8px rgba(0,255,180,0.3);
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .muted{color:var(--muted);font-size:12px}
  textarea{background:#09101a;border:2px solid rgba(0,234,255,0.3);color:var(--ink);border-radius:12px;padding:14px;
    font:inherit;width:100%;height:120px;resize:vertical;box-shadow:0 0 15px rgba(0,234,255,0.1);transition:all 0.3s ease;}
  textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 20px rgba(0,234,255,0.3)}
  .small{font-size:12px;color:var(--muted)}
  
  /* Post Actions - ERWEITERT f√ºr neue Buttons */
  .post-actions {
    display: flex;
    gap: 12px;
    margin-top: 6px;
    align-items: center;
    flex-wrap: wrap;
  }

  .post-actions button {
    background: rgba(255,255,255,0.07);
    border: none;
    border-radius: 8px;
    padding: 4px 8px;
    cursor: pointer;
    color: #00ffc8;
    transition: all 0.2s ease;
    font-size: 0.9em;
    min-height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .post-actions button:hover {
    background: rgba(0,255,200,0.2);
    transform: scale(1.1);
  }

  /* Spezifische Styles f√ºr die neuen Buttons */
  .btn-copy, .btn-profile, .btn-reply {
    min-width: 32px;
  }

  .btn-reply {
    font-size: 0.8em;
    padding: 4px 6px;
  }

  .icon-btn{cursor:pointer;font-size:14px;color:var(--muted);transition:all 0.2s ease;padding:4px 8px;border-radius:6px}
  .icon-btn:hover{color:var(--accent);background:rgba(0,234,255,0.1)}
  
  .tip-btn{background:linear-gradient(135deg,#062018,#0a2a22);border:1px solid #00ffa388;color:#00ffa3;
    margin-top:4px;padding:6px 12px;font-size:12px;border-radius:8px;cursor:pointer;box-shadow:0 0 10px rgba(0,255,163,0.2)}
  .tip-btn:hover{box-shadow:0 0 15px rgba(0,255,163,0.4)}
  
  .input-group{margin-bottom:12px}
  .input-label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
  .text-input{background:#09101a;border:2px solid rgba(255,255,255,.1);color:var(--ink);border-radius:10px;padding:10px 12px;
    width:100%;font:inherit;transition:all 0.3s ease;box-shadow:0 0 10px rgba(0,0,0,0.2)}
  .text-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 15px rgba(0,234,255,0.2)}

  .sol-icon{
    width:20px;
    height:20px;
    border-radius:6px;
  }
  
  .vote-btn{
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:4px;
    font-size:14px;
    color:#7b8ca4; /* muted gray */
    transition:0.2s;
    padding:4px 8px;
    border-radius:6px;
  }

  .vote-btn.active-up{
    color:#14F195; 
    text-shadow:0 0 6px rgba(20,241,149,.7);
    font-weight:700;
  }

  .vote-btn.active-down{
    color:#9945FF;
    text-shadow:0 0 6px rgba(153,69,255,.7);
    font-weight:700;
  }

  .vote-btn:hover{opacity:0.8;}

  /* Fade animation */
  @keyframes fadeUp {
    from { opacity:0;transform:translateY(6px);}
    to   { opacity:1;transform:translateY(0);}
  }

  /* Avatar breathing glow */
  @keyframes pulseGlow {
    0%   { box-shadow:0 0 6px rgba(0,255,180,0.25); }
    50%  { box-shadow:0 0 14px rgba(0,255,180,0.55); }
    100% { box-shadow:0 0 6px rgba(0,255,180,0.25); }
  }

  /* ‚úÖ Verified NFT Halo */
  .nft-halo {
    position: relative;
    border-radius: 12px;
    animation: nftGlow 2.5s ease-in-out infinite;
    box-shadow: 0 0 12px rgba(20,241,149,0.6), 0 0 24px rgba(0,234,255,0.4);
  }

  @keyframes nftGlow {
    0% { box-shadow: 0 0 8px rgba(0,234,255,0.35), 0 0 14px rgba(20,241,149,0.3); }
    50% { box-shadow: 0 0 18px rgba(0,234,255,0.7), 0 0 32px rgba(20,241,149,0.55); }
    100% { box-shadow: 0 0 8px rgba(0,234,255,0.35), 0 0 14px rgba(20,241,149,0.3); }
  }

  /* ‚úÖ Hashtag Styles */
  .hashtag {
    color:#00eaff;
    cursor:pointer;
    font-weight:600;
    transition:all 0.2s ease;
  }
  .hashtag:hover {
    text-shadow:0 0 8px #00eaff;
    background:rgba(0,234,255,0.1);
    padding:2px 4px;
    border-radius:4px;
  }

  /* ‚úÖ Trending Styles */
  .trend-item {
    padding:8px 12px;
    margin-bottom:6px;
    background:rgba(255,255,255,0.03);
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s ease;
    border:1px solid rgba(255,255,255,0.05);
  }
  .trend-item:hover {
    background:rgba(0,234,255,0.1);
    border-color:rgba(0,234,255,0.3);
    transform:translateX(4px);
  }
  .trend-count {
    color:var(--muted);
    font-size:11px;
    float:right;
  }

  /* ‚úÖ Active Filter Badge */
  .active-filter {
    background:linear-gradient(135deg,var(--blue),var(--purple));
    color:white;
    padding:4px 8px;
    border-radius:6px;
    font-size:12px;
    margin-left:8px;
    animation:pulseGlow 2s infinite;
  }

  /* === Modal Core === */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    width: 75%;
    max-width: 1000px;
    margin: 5% auto;
    background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(7,10,16,.95));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px;
    padding: 30px;
    color: var(--ink);
    box-shadow: 0 0 60px rgba(0,234,255,0.25);
    position: relative;
  }

  .close-btn {
    position: absolute;
    top: 14px;
    right: 18px;
    font-size: 28px;
    cursor: pointer;
    color: var(--muted);
    transition: .2s;
  }
  .close-btn:hover { color: var(--accent); }

  /* === Layout === */
  .profile-body {
    display: flex;
    gap: 40px;
    align-items: flex-start;
  }

  .profile-left {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .profile-right {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* === Inputs === */
  .input-pair {
    display: flex;
    gap: 10px;
  }
  .file-input, textarea {
    width: 100%;
    border: 2px solid rgba(255,255,255,0.08);
    background: #09101a;
    border-radius: 10px;
    color: var(--ink);
    padding: 10px;
    font-family: inherit;
    transition: 0.25s;
  }
  .text-input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(0,234,255,0.3);
  }

  /* Container f√ºr beide Buttons */
.profile-image-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 10px;
}

  /* Gleiche Breite f√ºr beide Buttons */
.upload-btn, .reset-btn {
  flex: 1; /* Beide Buttons nehmen gleichen Platz ein */
  min-width: 0; /* Verhindert √úberlauf */
  text-align: center;
}
  
/* Upload-Button */
.upload-btn {
  background: linear-gradient(90deg,#00eaff,#9945FF,#14f195);
  color: #fff;
  font-weight: 600;
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(0,234,255,0.3);
  transition: all .3s ease;
  display: inline-block;
  text-align: center;
}
.upload-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 0 18px rgba(0,234,255,0.5);
}
  .file-hidden {
    display: none;
  }

  /* === Fix Chart === */
  #portfolioChart {
    width: 100%;
    max-width: 350px;
    aspect-ratio: 1 / 1;
  }

  /* === Portfolio List === */
  .portfolio-list {
    margin: 10px 0;
    max-height: 120px;
    overflow-y: auto;
  }
  .portfolio-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 6px 10px;
    background: rgba(255,255,255,0.03);
    border-radius: 6px;
    margin-bottom: 4px;
    font-size: 13px;
  }
  .portfolio-item span {
    flex: 1;
  }
  .remove-asset {
    color: #ff6b6b;
    cursor: pointer;
    font-weight: bold;
    margin-left: 8px;
  }

  /* === Profile Avatar Preview === */
  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    object-fit: cover;
    border: 2px solid rgba(0,234,255,0.3);
    margin-bottom: 10px;
  }

/* Reset-Button */
.reset-btn {
  background: linear-gradient(90deg,#ff5f6d,#ffc371);
  color: #fff;
  font-weight: 600;
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(255,100,100,0.3);
  transition: all .3s ease;
}
.reset-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 0 18px rgba(255,120,120,0.5);
}
 #bioInput {
  background: #09101a;
  border: 2px solid rgba(0,234,255,0.3);
  color: var(--ink);
  border-radius: 12px;
  padding: 14px;
  font: inherit;
  width: 100%;
  resize: none;
  min-height: 80px;       /* ~4 Zeilen Startgr√∂√üe */
  max-height: 120px;      /* ~4 Zeilen maximale H√∂he */
  overflow-y: auto;
  box-shadow: 0 0 15px rgba(0,234,255,0.1);
  transition: all 0.3s ease;
}

#bioInput:focus {
  outline: none;
  border-color: var(--blue);
  box-shadow: 0 0 20px rgba(0,234,255,0.3);
}

  .feed-separator {
  position: relative;
  height: 2px;
  width: 100%;
  background: linear-gradient(90deg, rgba(0,234,255,0.1), rgba(153,69,255,0.2), rgba(0,234,255,0.1));
  border-radius: 2px;
  overflow: hidden;
  margin: 15px 0;
}

/* Laufender Licht-Reflex */
.feed-separator::after {
  content: "";
  position: absolute;
  top: 0;
  left: -20%;
  width: 40%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,234,255,0.8), transparent);
  animation: shine 2.8s linear infinite;
  filter: blur(1px);
}

@keyframes shine {
  0% {
    left: -40%;
  }
  100% {
    left: 100%;
  }
}

/* === üåÄ Rick Easter Egg Animation === */
@keyframes rickFlyAndWobble {
  0% {
    transform: translateX(-200px) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  25% {
    transform: translateX(25vw) rotate(-5deg);
  }
  40% {
    transform: translateX(45vw) rotate(4deg);
  }
  55% {
    transform: translateX(60vw) rotate(-4deg);
  }
  70% {
    transform: translateX(80vw) rotate(3deg);
  }
  85% {
    transform: translateX(100vw) rotate(-3deg);
  }
  100% {
    transform: translateX(120vw) rotate(0deg);
    opacity: 0;
  }
}

/* === üåÄ Rick Portal Effect === */
#portal {
  position: fixed;
  bottom: 50%;
  left: -200px;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #14f195 0%, #00ffa3 25%, transparent 70%);
  filter: blur(8px) brightness(1.3);
  opacity: 0;
  pointer-events: none;
  z-index: 999;
  transform: scale(0.3);
  animation: none;
}

/* Portal √∂ffnet sich, pulsiert & verschwindet */
@keyframes portalOpen {
  0%   { transform: scale(0.3); opacity: 0; filter: blur(8px); }
  20%  { transform: scale(1); opacity: 1; filter: blur(3px); }
  60%  { transform: scale(1.1); opacity: 1; filter: blur(6px); }
  100% { transform: scale(0.4); opacity: 0; filter: blur(8px); }
}

/* Portal Glow-Loop */
@keyframes portalGlow {
  0%,100% { box-shadow: 0 0 25px rgba(20,241,149,0.5), inset 0 0 25px rgba(0,234,255,0.4); }
  50% { box-shadow: 0 0 45px rgba(20,241,149,0.8), inset 0 0 35px rgba(0,234,255,0.7); }
}

/* Rick mit Wobble-Effect */
#rick {
  position: fixed;
  bottom: 50%;
  left: -200px;
  width: 180px;
  opacity: 0;
  pointer-events: none;
  z-index: 1000;
  transition: opacity 0.6s ease;
  filter: drop-shadow(0 0 12px rgba(0,234,255,0.5));
}

/* Text-Popup */
#rick-text {
  position: fixed;
  bottom: 60%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  color: black;
  font-weight: 700;
  font-family: "Barlow", sans-serif;
  padding: 10px 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(255,255,255,0.3);
  opacity: 0;
  z-index: 1100;
  transition: opacity 0.4s ease;
}

/* === Realtime Trending Hashtags Styles === */
#trending-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

#trending-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px;
  margin: 3px 0;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  color: #00ffc8;
  font-weight: 500;
  transition: background 0.3s ease, transform 0.2s ease;
}

/* --- Animationen --- */
@keyframes popIn {
  0% { transform: scale(0.8); background: rgba(0,255,200,0.2); }
  50% { transform: scale(1.05); background: rgba(0,255,200,0.4); }
  100% { transform: scale(1); background: rgba(255,255,255,0.05); }
}

@keyframes pulseUpdate {
  0% { background: rgba(0,255,150,0.2); }
  50% { background: rgba(0,255,150,0.5); }
  100% { background: rgba(255,255,255,0.05); }
}

/* Trigger √ºber Klassen */
.trend-added {
  animation: popIn 0.5s ease-out;
}

.trend-updated {
  animation: pulseUpdate 0.8s ease-out;
}

/* === Toast Notification === */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,255,200,0.1);
  color: #00ffc8;
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 0.9em;
  backdrop-filter: blur(8px);
  border: 1px solid rgba(0,255,200,0.3);
  z-index: 10000;
  animation: fadeInOut 2s ease;
}

@keyframes fadeInOut {
  0%,100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
  10%,90% { opacity: 1; transform: translateX(-50%) translateY(0); }
}

/* ‚≠ê‚≠ê NEUER CSS CODE HIER EINF√úGEN ‚≠ê‚≠ê */

/* Post Header mit Wallet + Buttons */
.post-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.header-actions {
  display: flex;
  gap: 6px;
}

.header-actions button {
  background: rgba(255,255,255,0.07);
  border: none;
  border-radius: 6px;
  padding: 3px 6px;
  cursor: pointer;
  color: #00ffc8;
  transition: all 0.2s ease;
  font-size: 0.8em;
  opacity: 0.7;
}

.header-actions button:hover {
  background: rgba(0,255,200,0.2);
  transform: scale(1.1);
  opacity: 1;
}

/* Reply Button in den normalen Post-Actions */
.btn-reply {
  background: rgba(255,255,255,0.07);
  border: none;
  border-radius: 8px;
  padding: 4px 8px;
  cursor: pointer;
  color: #00ffc8;
  transition: all 0.2s ease;
  font-size: 0.9em;
}

.btn-reply:hover {
  background: rgba(0,255,200,0.2);
  transform: scale(1.1);
}

/* === HENSHIN Reply Modal === */
.reply-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(4px);
  animation: fadeIn 0.3s ease;
}

.reply-modal.hidden {
  display: none;
}

/* Box */
.reply-box {
  background: rgba(25,25,25,0.95);
  border: 1px solid rgba(0,255,200,0.3);
  border-radius: 16px;
  padding: 20px;
  width: 320px;
  max-width: 90%;
  color: #00ffc8;
  box-shadow: 0 0 20px rgba(0,255,200,0.3);
  animation: wobbleIn 0.6s ease;
}

/* Inputs */
.reply-box textarea {
  width: 100%;
  height: 100px;
  background: rgba(255,255,255,0.05);
  border: none;
  border-radius: 10px;
  color: #fff;
  resize: none;
  padding: 8px;
  font-size: 0.9em;
}

.reply-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
}

.reply-actions button {
  background: rgba(0,255,200,0.1);
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  color: #00ffc8;
  cursor: pointer;
  transition: all 0.2s ease;
}

.reply-actions button:hover {
  background: rgba(0,255,200,0.3);
}

/* Animations */
@keyframes wobbleIn {
  0%   { transform: scale(0.8) rotate(-3deg); opacity: 0; }
  50%  { transform: scale(1.05) rotate(3deg); opacity: 1; }
  100% { transform: scale(1) rotate(0); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* === Reply Panel === */
.reply-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 360px;
  height: 100%;
  background: rgba(10,10,10,0.95);
  border-left: 1px solid rgba(0,255,200,0.2);
  box-shadow: -4px 0 25px rgba(0,255,200,0.15);
  transform: translateX(100%);
  transition: transform 0.4s ease;
  z-index: 1000;
  backdrop-filter: blur(6px);
}

.reply-panel.show {
  transform: translateX(0);
  animation: panelGlow 0.6s ease;
  box-shadow: -6px 0 24px rgba(0,255,200,0.05);
  border-left: 1px solid rgba(0,255,200,0.15);
}

  .reply-panel-body::-webkit-scrollbar-thumb {
  background: linear-gradient(var(--gobbles-neon-1), var(--gobbles-neon-2));
  border-radius: 8px;
}
  
.reply-panel-inner {
  padding: 14px;
  color: #00ffc8;
  overflow-y: auto;
  height: 100%;
}

/* Header mit X-Button */
.reply-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(0,255,200,0.2);
  padding-bottom: 8px;
  margin-bottom: 10px;
}

.close-replies {
  background: none;
  border: none;
  color: #00ffc8;
  font-size: 1.2em;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.close-replies:hover {
  transform: scale(1.2);
}

/* Reply-Items */
.reply-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 10px 12px;
  margin-bottom: 10px;
  transition: background .25s ease, box-shadow .25s ease;
}
.reply-item:hover {
  background: rgba(0,255,200,0.04);
  box-shadow: 0 0 12px rgba(0,255,200,0.1);
}
.reply-text {
  color: #d7fdfd;
  font-size: 0.9rem;
  line-height: 1.5;
}
.reply-time {
  font-size: 0.7rem;
  color: rgba(255,255,255,0.35);
}


.reply-item small {
  opacity: 0.6;
  font-size: 0.75em;
}

/* Optional: leichte Scrollbar */
.reply-list::-webkit-scrollbar {
  width: 6px;
}
.reply-list::-webkit-scrollbar-thumb {
  background: rgba(0,255,200,0.3);
  border-radius: 3px;
}

@keyframes panelGlow {
  0%   { box-shadow: -4px 0 40px rgba(0,255,200,0.0); }
  50%  { box-shadow: -4px 0 40px rgba(0,255,200,0.4); }
  100% { box-shadow: -4px 0 25px rgba(0,255,200,0.15); }
}


  .reply-author {
  font-weight: 700;
  color: var(--gobbles-neon-2);
  text-decoration: underline;
  text-underline-offset: 3px;
  cursor: pointer;
  transition: color .25s ease, text-shadow .25s ease;
}

.reply-author:hover {
  color: var(--gobbles-neon-1);
  text-shadow: 0 0 8px rgba(0,255,200,0.6);
}

  
</style>
</head>
<body>
<!-- ‚≠ê Partikel/Sterne Canvas -->
<canvas id="particles"></canvas>

<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img id="logoImg" src="../img/1boss.png" class="logo-anim" alt="Gobbles">
      <div>
        <div class="brand-main"><span class="g-wobble">G</span>obbles</div>
        <div class="small">Cope Harder!</div>
      </div>

      <!-- üîπ Cobie Home Button -->
      <a href="https://www.cobie.uk/" target="_blank" class="home-link">
        <img src="../img/cobieGif.gif" alt="Cobie" class="cobie-gif">
        <span class="home-text">Cobie Main</span>
      </a>
    </div>

    <div class="header-right-wrap">
      <span class="profile-link">Profile</span>
      <span id="wallet-status" class="status">Not connected</span>
      <button id="connectBtn" class="btn connect-btn">Connect Wallet</button>
    </div>
  </div>
</header>

<!-- Sound for posts -->
<audio id="postSound">
  <source src="../sounds/mgs2.mp3" type="audio/mpeg">
</audio>

<!-- Boom Sound for new posts -->
<audio id="boomSound">
  <source src="../sounds/coin.mp3" type="audio/mpeg">
</audio>

<!-- Rick Easter Egg Sound -->
<audio id="rickSound">
  <source src="../sounds/portal.mp3" type="audio/mpeg">
</audio>

<!-- === Profile Modal === -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeProfile()">&times;</span>
    <div class="profile-body">
      <!-- Left Side -->
      <div class="profile-left">
        <h2>Your Profile</h2>

       <label class="input-label">Profile Image</label>
<img id="avatarPreview" class="avatar-preview" alt="Avatar Preview">

<div class="profile-image-buttons">
  <label for="avatarUpload" class="upload-btn">Upload Image</label>
  <button class="reset-btn" onclick="resetAvatar()">üîÅ Reset to NFT</button>
</div>
<input type="file" id="avatarUpload" accept="image/*" class="file-hidden">

        <label class="input-label">About you (max 200 chars)</label>
        <textarea id="bioInput" maxlength="200" class="text-input" placeholder="Write something about yourself..."></textarea>

        <h3 style="margin-top:20px;">Portfolio Allocation</h3>
        
        <div class="input-pair">
          <input type="text" class="text-input asset-input" placeholder="Asset (e.g. Solana)" id="assetInput">
          <input type="number" class="text-input percent-input" placeholder="%" id="percentInput">
        </div>
        
        <div class="portfolio-list" id="portfolioList"></div>
        
        <div class="small" style="color: var(--muted); margin-top: 8px;">
          Press Enter after filling both fields to add assets
        </div>

        <button class="btn" onclick="saveProfile()" style="margin-top: 15px;">üíæ Save Profile</button>
      </div>

      <!-- Right Side -->
      <div class="profile-right">
        <canvas id="portfolioChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- === HENSHIN Reply Modal === -->
<div id="replyModal" class="reply-modal hidden">
  <div class="reply-box">
    <h3>üåÄ HENSHIN ‚Äì Reply</h3>
    <textarea id="replyText" maxlength="140" placeholder="Type your reply (max 140 chars)..."></textarea>
    <div class="reply-actions">
      <span id="charCount">0 / 140</span>
      <button id="cancelReply">Cancel</button>
      <button id="sendReply">Send</button>
    </div>
  </div>
</div>

<!-- === Reply Side Panel === -->
<div id="replyPanel" class="reply-panel hidden">
  <div class="reply-panel-inner">
    <div class="reply-header">
      <h3>Replies üåÄ</h3>
      <button id="closeReplies" class="close-replies">‚úñ</button>
    </div>
    <div id="replyList" class="reply-list"></div>
  </div>
</div>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Create Post</h3>
          <textarea id="postText" maxlength="140" placeholder="What's happening? Use #hashtags for trends!"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">Fee: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Post</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Community Feed <span id="filterBadge" style="display:none"></span></h3>
        </div>
        <div class="feed-separator"></div>

        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="body">
          <h3>Trending</h3>
          <div id="trendBox">
            <div class="small" style="text-align:center;padding:20px;color:var(--muted)">
              No trends yet. Be the first to post with #hashtags!
            </div>
          </div>
          <ul id="trending-list"></ul>
          <button id="resetFeedBtn" class="btn" style="margin-top:10px;width:100%;">
            üîÑ Show All Posts
          </button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Sentiment & Trends</h3>
          <div class="input-group">
            <label class="input-label">Search Posts</label>
            <input type="text" class="text-input" placeholder="Enter keyword...">
          </div>
          <div class="input-group">
            <label class="input-label">Filter by User</label>
            <input type="text" class="text-input" placeholder="Wallet address...">
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- üåÄ Rick Easter Egg -->
<div id="portal"></div>
<img id="rick" src="../img/rick.png" alt="Rick">
<div id="rick-text">Never go into Crypto, Morty!</div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* ---------- LIB INIT ---------- */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- UI refs ---------- */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");
const postSound = document.getElementById("postSound");
const boomSound = document.getElementById("boomSound");
const trendBox = document.getElementById("trendBox");
const filterBadge = document.getElementById("filterBadge");
const resetFeedBtn = document.getElementById("resetFeedBtn");

let wallet = null;
let currentFilter = null;
let uploadedAvatar = null;

/* === Gobbles Portal Hover Sound === */
// Spielt den Rick & Morty Portal-Sound ab, wenn ein Post gehovert wird üåÄ
document.addEventListener("DOMContentLoaded", () => {
  const portalSound = document.getElementById("rickSound");
  if (!portalSound) return console.warn("‚ö†Ô∏è Portal-Sound (rickSound) nicht gefunden!");

  document.querySelectorAll(".post").forEach(post => {
    post.addEventListener("mouseenter", () => {
      try {
        portalSound.currentTime = 0; // Neustart
        portalSound.volume = 0.15;   // Angenehme Lautst√§rke
        portalSound.play();
      } catch (err) {
        console.warn("‚ö†Ô∏è Portal-Sound konnte nicht abgespielt werden:", err);
      }
    });
  });
});

/* === üåÄ Dynamic Logo Switcher === */
const logoImg = document.getElementById("logoImg");
const logoImages = [
  "../img/1boss.png",
  "../img/1bitcoin.png", 
  "../img/1YaoMing.png",
  "../img/1uuuuu.png"
];
let currentLogo = 0;

// Logo wechseln alle 9 Sekunden (gleich zur CSS-Dauer der spinPulse Animation)
setInterval(() => {
  currentLogo = (currentLogo + 1) % logoImages.length;
  logoImg.style.opacity = "0";
  
  // Sanfter √úbergang
  setTimeout(() => {
    logoImg.src = logoImages[currentLogo];
    logoImg.style.opacity = "1";
  }, 400);
}, 9000);

/* === Fallback Avatar Generation === */
function generateFallbackAvatar(address) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = 200;
  canvas.height = 200;

  // Generate unique hue based on wallet address
  const hue = address.split("").reduce((a, c) => a + c.charCodeAt(0), 0) % 360;
  
  // Create gradient
  const grad = ctx.createLinearGradient(0, 0, 200, 200);
  grad.addColorStop(0, `hsl(${hue}, 70%, 50%)`);
  grad.addColorStop(1, `hsl(${(hue + 80) % 360}, 70%, 60%)`);
  
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, 200, 200);

  // Add some visual texture
  ctx.fillStyle = `hsla(${(hue + 120) % 360}, 60%, 40%, 0.1)`;
  for (let i = 0; i < 50; i++) {
    const x = Math.random() * 200;
    const y = Math.random() * 200;
    const size = Math.random() * 10 + 5;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }

  return canvas.toDataURL("image/png");
}

/* === Portfolio Management === */
let portfolio = [];
const assetInput = document.getElementById("assetInput");
const percentInput = document.getElementById("percentInput");
const portfolioList = document.getElementById("portfolioList");
const avatarPreview = document.getElementById("avatarPreview");
const avatarUpload = document.getElementById("avatarUpload");

function addAssetToChart() {
  const name = assetInput.value.trim();
  const val = parseFloat(percentInput.value);
  
  if (!name || !val || val <= 0) return;
  
  // Check if asset already exists
  const existingIndex = portfolio.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
  if (existingIndex > -1) {
    portfolio[existingIndex].val = val;
  } else {
    portfolio.push({ name, val });
  }
  
  assetInput.value = "";
  percentInput.value = "";
  updatePortfolioList();
  updateChart();
}

function removeAsset(index) {
  portfolio.splice(index, 1);
  updatePortfolioList();
  updateChart();
}

function updatePortfolioList() {
  portfolioList.innerHTML = portfolio.map((item, index) => `
    <div class="portfolio-item">
      <span>${item.name}</span>
      <span>${item.val}%</span>
      <span class="remove-asset" onclick="removeAsset(${index})">√ó</span>
    </div>
  `).join("");
}

// Smart input flow
assetInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && percentInput.value) {
    addAssetToChart();
  }
});

percentInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && assetInput.value) {
    addAssetToChart();
  }
});

// Avatar upload handler
avatarUpload.addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      uploadedAvatar = event.target.result;
      avatarPreview.src = uploadedAvatar;
    };
    reader.readAsDataURL(file);
  }
});

/* === Portfolio Chart === */
let chartCtx = document.getElementById("portfolioChart")?.getContext("2d");
let portfolioChart;

function updateChart() {
  const assets = portfolio.map(p => p.name);
  const values = portfolio.map(p => p.val);

  const total = values.reduce((a, b) => a + b, 0);
  if (total < 100 && total > 0) {
    assets.push("Other");
    values.push(100 - total);
  }

  if (portfolioChart) portfolioChart.destroy();

  portfolioChart = new Chart(chartCtx, {
    type: "doughnut",
    data: {
      labels: assets,
      datasets: [{
        data: values,
        backgroundColor: [
          "#00eaff",
          "#9945FF", 
          "#14F195",
          "#FF6B6B",
          "#FFD166",
          "#06D6A0"
        ],
        borderWidth: 2,
        borderColor: "#0b0f14"
      }]
    },
    options: {
      cutout: "65%",
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: true
        },
        datalabels: {
          color: "#fff",
          font: { 
            weight: "bold",
            size: 11,
            family: "Barlow"
          },
          formatter: (value, ctx) => {
            return ctx.chart.data.labels[ctx.dataIndex];
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

/* ---------- Profile Management ---------- */
async function loadProfile() {
  if (!wallet) return;

  try {
    const { data, error } = await db
      .from("profiles")
      .select("bio, portfolio, avatar")
      .eq("wallet", wallet)
      .maybeSingle();

    if (error) {
      console.error("‚ùå Error loading profile:", error);
      return;
    }

    if (data) {
      document.getElementById("bioInput").value = data.bio || "";
      portfolio = Array.isArray(data.portfolio) ? data.portfolio : [];
      updatePortfolioList();
      updateChart();

      if (data.avatar) {
        uploadedAvatar = data.avatar;
        avatarPreview.src = data.avatar;
      } else {
        avatarPreview.src = generateFallbackAvatar(wallet);
      }
    } else {
      avatarPreview.src = generateFallbackAvatar(wallet);
    }
  } catch (err) {
    console.error("‚ùå JS error while loading profile:", err);
  }
}

async function saveProfile() {
  if (!wallet) {
    alert("Please connect your wallet first!");
    return;
  }

  try {
    const bio = document.getElementById("bioInput").value.trim().slice(0, 200);
    const safePortfolio = Array.isArray(portfolio)
      ? portfolio.map(p => ({
          name: String(p.name || "").slice(0, 32),
          val: Number(p.val) || 0
        }))
      : [];

    const { data, error } = await db
      .from("profiles")
      .upsert(
        {
          wallet,
          bio,
          portfolio: safePortfolio,
          avatar: uploadedAvatar,
          updated_at: new Date().toISOString()
        },
        { onConflict: "wallet" }
      )
      .select()
      .single();

    if (error) {
      console.error("‚ùå Supabase save error:", error);
      alert("Error saving profile: " + error.message);
      return;
    }

    console.log("‚úÖ Profile saved:", data);
    alert("‚úÖ Profile saved successfully!");
    updateChart();
    closeProfile();
  } catch (err) {
    console.error("‚ùå JS error:", err);
    alert("Error saving profile: " + err.message);
  }
}

/* === Reset Avatar Function === */
async function resetAvatar() {
  if (!wallet) {
    alert("Please connect your wallet first!");
    return;
  }

  if (!confirm("Are you sure you want to reset your avatar? This will remove your uploaded image and use your NFT or fallback avatar instead.")) {
    return;
  }

  try {
    // Set uploadedAvatar to null
    uploadedAvatar = null;
    
    // Try to get NFT avatar first
    const nftAvatar = await avatar(wallet);
    
    if (nftAvatar) {
      avatarPreview.src = nftAvatar;
    } else {
      // Fallback to generated avatar
      avatarPreview.src = generateFallbackAvatar(wallet);
    }

    // Save immediately to update database
    const { error } = await db
      .from("profiles")
      .upsert(
        {
          wallet,
          avatar: null, // Explicitly set to null in database
          updated_at: new Date().toISOString()
        },
        { onConflict: "wallet" }
      );

    if (error) {
      console.error("‚ùå Error resetting avatar:", error);
      alert("Error resetting avatar: " + error.message);
      return;
    }

    console.log("‚úÖ Avatar reset successfully!");
    alert("‚úÖ Avatar reset! Using your NFT or fallback image.");
    
  } catch (err) {
    console.error("‚ùå JS error while resetting avatar:", err);
    alert("Error resetting avatar: " + err.message);
  }
}

/* ---------- Hashtag Functions ---------- */
function extractHashtags(text) {
  return (text.match(/#\w+/g) || []).map(t => t.toLowerCase().replace('#', ''));
}

function renderTextWithTags(text){
  const withTags = text.replace(/#(\w+)/g, `<span class="hashtag" data-tag="$1">#$1</span>`);
  return withTags.replace(/\n/g, "<br>");
}

/* ---------- Partikel/Sterne Animation ---------- */
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");
let particles = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Erstelle Partikel/Sterne
for (let i = 0; i < 80; i++) {
  particles.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    size: Math.random() * 1.5 + 0.5, // Kleinere, subtilere Gr√∂√üe
    speedX: (Math.random() - 0.5) * 0.3, // Langsamere Bewegung
    speedY: (Math.random() - 0.5) * 0.3,
    alpha: Math.random() * 0.6 + 0.2 // Subtile Transparenz
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => {
    p.x += p.speedX; 
    p.y += p.speedY;
    
    // Wrap around edges
    if (p.x < 0) p.x = canvas.width;
    if (p.x > canvas.width) p.x = 0;
    if (p.y < 0) p.y = canvas.height;
    if (p.y > canvas.height) p.y = 0;

    ctx.fillStyle = `rgba(0,234,255,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

/* ---------- Wallet helpers ---------- */
function getWallet(){ return window.phantom?.solana || window.solana; }

function uiConnected(pk){ 
  statusEl.textContent = "‚úÖ ";
  const span = document.createElement("span");
  statusEl.appendChild(span);
  
  // ‚úÖ Fallback falls displayWalletLabel nicht verf√ºgbar
  if (typeof displayWalletLabel === 'function') {
    displayWalletLabel(pk, span);
  } else {
    span.textContent = `${pk.slice(0,4)}‚Ä¶${pk.slice(-4)}`;
  }
  connectBtn.textContent="Disconnect"; 
  
  // Load profile when wallet connects
  loadProfile();
}

function uiDisconnected(){ 
  statusEl.textContent = "Not connected"; 
  connectBtn.textContent="Connect Wallet"; 
}

connectBtn.onclick = async ()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom wallet not found. Please install Phantom."); window.open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet = null; 
  uiDisconnected();
}

/* ---------- Payment (robust confirm) ---------- */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Please connect wallet first");
  const conn = new solanaWeb3.Connection(RPC, { commitment:"confirmed", confirmTransactionInitialTimeout:120000 });

  const from = p.publicKey;
  const to   = new solanaWeb3.PublicKey(RECEIVER_WALLET);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);

  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("finalized");

  const tx = new solanaWeb3.Transaction({
    feePayer: from,
    recentBlockhash: blockhash
  }).add(
    solanaWeb3.SystemProgram.transfer({ fromPubkey: from, toPubkey: to, lamports })
  );

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false, maxRetries:6 });

  await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
  return sig;
}

/* ---------- NFT Avatar via Helius ---------- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;

  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });
  const json = await r.json();
  const items = json?.result?.items || [];
  // prefer metadata.image, fallback content.files[0].uri
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;

  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* ---------- DB ops ---------- */
async function savePost(text, tx){
  // Hashtags extrahieren (#solana #gobbles #pump)
  const tags = [...text.matchAll(/#(\w+)/g)].map(m => m[1].toLowerCase());

  // ‚úÖ Speichern mit Tags und created_at
  const { error } = await db.from("posts").insert([{ 
    wallet, 
    content:text, 
    tx, 
    tags,
    created_at: new Date().toISOString() // üëà WICHTIG: created_at mitgeben
  }]);
  if(error) throw error;
}

/* ---------- VOTING SYSTEM (UPDATED) ---------- */
window.vote = async (id, dir) => {
  if(!wallet) return alert("Please connect your wallet!");

  const success = await db.rpc(
    dir === "up" ? "vote_up" : "vote_down",
    { p_post_id: id, p_wallet: wallet }
  );

  if(!success.error){
    localStorage.setItem("vote_" + id, dir);
  }

  loadFeed(); 
};

/* ---------- Feed loading ---------- */
async function loadFeed(tag = null){
  currentFilter = tag;
  
  // Update filter badge
  if(tag) {
    filterBadge.style.display = 'inline';
    filterBadge.innerHTML = `Filter: #${tag} <span class="clear-filter" style="cursor:pointer;margin-left:8px">‚úï</span>`;
  } else {
    filterBadge.style.display = 'none';
  }

  let query = db.from("posts").select("*, replies(count)").order("created_at", {ascending:false});

  if(tag) {
    query = query.contains("tags", [tag]);
  }

  const { data, error } = await query.limit(50);
    
  if(error){ console.error("Supabase load error:", error); return; }

  // ‚úÖ Parallele Avatar-Abfragen f√ºr bessere Performance
  const postsWithAvatars = await Promise.all(
    (data || []).map(async p => ({ 
      ...p, 
      img: await avatar(p.wallet) 
    }))
  );

  const htmlParts = [];
  
  for(const p of postsWithAvatars){
    const hasNft = !!p.img; // true wenn ein NFT gefunden wurde
    const userVote = localStorage.getItem("vote_" + p.id);
    const replyCount = p.replies?.[0]?.count || 0;

    htmlParts.push(`
      <div class="post">
        <div class="avatar ${hasNft ? "nft-halo" : ""}">${p.img ? `<img src="${p.img}" alt="pfp">` : ""}</div>
        <div>
          <div class="post-header">
            <b class="wallet-label" data-wallet="${p.wallet}">${p.wallet.slice(0,6)}...</b>
            <div class="header-actions">
              <button class="btn-copy" title="Copy address" data-wallet="${p.wallet}">üìã</button>
              <button class="btn-profile" title="View profile" data-wallet="${p.wallet}">üë§</button>
            </div>
          </div>
          <p style="white-space: pre-line">${renderTextWithTags(p.content)}</p>
          <div class="post-actions">
            
            <span class="vote-btn ${userVote === "up" ? "active-up" : ""}" onclick="vote('${p.id}','up')">
              üëç ${p.upvotes || 0}
            </span>

            <span class="vote-btn ${userVote === "down" ? "active-down" : ""}" onclick="vote('${p.id}','down')">
              üëé ${p.downvotes || 0}
            </span>

            <!-- Reply Button mit Z√§hler -->
            <button class="btn-reply" title="Reply (Ëøî‰ø°)" data-wallet="${p.wallet}" data-post-id="${p.id}">
              Ëøî‰ø° ${replyCount}
            </button>

            <!-- Bestehende Buttons -->
            <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
              <img src="../img/1Solana.png" class="sol-icon">
            </span>

            <a target="_blank" class="small" href="https://solscan.io/tx/${p.tx}">
              View TX
            </a>
          </div>
        </div>
      </div>`);
  }

  feed.innerHTML = htmlParts.join("");
  displayWalletLabels();

  // Clear filter event
  const clearBtn = document.querySelector('.clear-filter');
  if(clearBtn) clearBtn.onclick = () => loadFeed();
}

/* ---------- Wallet Label Display ---------- */
async function displayWalletLabels() {
  document.querySelectorAll(".wallet-label").forEach(async el => {
    const wallet = el.dataset.wallet;
    const cache = localStorage.getItem("label_" + wallet);
    if(cache) { el.textContent = cache; return; }

    const r = await fetch(`https://api.solana.fm/v0/accounts/${wallet}`);
    const json = await r.json();
    const label = json?.result?.account?.accountName || wallet.slice(0,6)+"...";
    localStorage.setItem("label_" + wallet, label);
    el.textContent = label;
  });
}

/* ---------- Tip User ---------- */
async function tipUser(toWallet) {
  if(!wallet) return alert("Please connect your wallet!");
  try {
    const sig = await pay(0.001);
    alert(`Tip sent! TX: ${sig}`);
  } catch(e) {
    alert("Tip failed: " + e.message);
  }
}

/* ---------- Posting ---------- */
postBtn.onclick = async ()=>{
  if(!wallet) return alert("Please connect your wallet!");
  const text = postText.value.trim();
  if(!text) return alert("Please enter some text");
  if(text.length > 140) return alert("Max 140 characters");

  try {
    // üî• Sending Status anzeigen
    const originalText = postBtn.textContent;
    postBtn.textContent = "Sending 0.001 SOL...";
    postBtn.disabled = true;

    const sig = await pay(0.001);
    await savePost(text, sig);
    
    // üî• WICHTIG: Kurz warten, damit Supabase ready ist
    await new Promise(r => setTimeout(r, 300));
    
    postText.value = "";
    
    // üî• Feed neu laden
    await loadFeed();
    
    boomSound.play();
    
    // Boom animation f√ºr den neuesten Post
    setTimeout(() => {
      const posts = document.querySelectorAll('.post');
      if(posts.length > 0) {
        posts[0].classList.add('post-boom');
      }
    }, 100);

    // ‚úÖ Erfolgsmeldung
    alert("‚úÖ Posted successfully!");

  } catch(e) {
    alert("Post failed: " + e.message);
  } finally {
    // Button zur√ºcksetzen
    postBtn.textContent = "Post";
    postBtn.disabled = false;
  }
};

/* ---------- Trending Hashtags ---------- */
async function updateTrends(){
  const { data } = await db.from("posts").select("tags");
  const allTags = (data || []).flatMap(p => p.tags || []);
  const counts = {};
  allTags.forEach(t => { counts[t] = (counts[t] || 0) + 1; });
  const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0,5);

  if(sorted.length === 0) return;

  trendBox.innerHTML = sorted.map(([tag,count]) => `
    <div class="trend-item" onclick="loadFeed('${tag}')">
      #${tag} <span class="trend-count">${count}</span>
    </div>`).join("");
}

/* ---------- Realtime Trending Hashtags --- */
function updateTrendingFeed(newHashtag) {
  const list = document.querySelector('#trending-list');
  if (!list || !newHashtag?.tag) return;

  const existing = list.querySelector(`[data-tag="${newHashtag.tag}"]`);
  
  if (existing) {
    // Count √§ndern
    const countElem = existing.querySelector('.count');
    const oldCount = parseInt(countElem.textContent, 10);
    countElem.textContent = newHashtag.count;

    // Wenn sich der Count wirklich ge√§ndert hat ‚Üí Pulse
    if (oldCount !== newHashtag.count) {
      existing.classList.remove('trend-updated');
      void existing.offsetWidth; // Reflow, um Animation neu zu triggern
      existing.classList.add('trend-updated');
    }
  } else {
    // Neuer Trend hinzugef√ºgt
    const li = document.createElement('li');
    li.dataset.tag = newHashtag.tag;
    li.innerHTML = `${newHashtag.tag} <span class="count">${newHashtag.count}</span>`;
    li.classList.add('trend-added');
    list.prepend(li);
  }
}

// Supabase Realtime f√ºr Trending Hashtags
const hashtagChannel = db
  .channel('trending-hashtags')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'hashtags' },
    payload => {
      console.log('üìä Realtime hashtag update:', payload);
      updateTrendingFeed(payload.new);
    }
  )
  .subscribe();

/* ---------- Hashtag Click Handler ---------- */
document.addEventListener("click", e => {
  if(e.target.classList.contains("hashtag")){
    const tag = e.target.dataset.tag;
    loadFeed(tag);
  }
});

/* ---------- Reset Feed ---------- */
resetFeedBtn.onclick = () => loadFeed();

/* ---------- Profile Modal ---------- */
document.querySelector(".profile-link").onclick = async () => {
  if (!wallet) {
    alert("Please connect your wallet first!");
    return;
  }

  // Lade Profil-Daten beim √ñffnen
  await loadProfile();

  // Zeig das Modal
  document.getElementById("profileModal").style.display = "block";
};

function closeProfile() {
  document.getElementById("profileModal").style.display = "none";
}

/* === Toast Notification Utility === */
function toast(msg) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}

/* ---------- Neue Button-Funktionen ---------- */
document.addEventListener('click', e => {
  // Copy wallet to clipboard
  if (e.target.classList.contains('btn-copy')) {
    const wallet = e.target.dataset.wallet;
    navigator.clipboard.writeText(wallet).then(() => {
      e.target.textContent = '‚úÖ'; // kurz Feedback
      setTimeout(() => (e.target.textContent = 'üìã'), 1000);
    }).catch(err => {
      console.error('Copy failed:', err);
      e.target.textContent = '‚ùå';
      setTimeout(() => (e.target.textContent = 'üìã'), 1000);
    });
  }

  // Open profile modal (aktuell nur eigenes Profil)
  if (e.target.classList.contains('btn-profile')) {
    const wallet = e.target.dataset.wallet;
    // Aktuell √∂ffnen wir nur das eigene Profil-Modal
    if (wallet === window.wallet) {
      document.querySelector(".profile-link").click();
    } else {
      toast(`Profile view for other users coming soon!\nWallet: ${wallet}`);
    }
  }
});

/* ---------- HENSHIN Reply Logic ---------- */
const replyModal = document.getElementById('replyModal');
const replyText = document.getElementById('replyText');
const charCount = document.getElementById('charCount');
const cancelReply = document.getElementById('cancelReply');
const sendReply = document.getElementById('sendReply');

let replyTarget = null; // post id

// √ñffnen beim Klick auf „ÄåËøî‰ø°„Äç
document.addEventListener('click', e => {
  if (e.target.classList.contains('btn-reply')) {
    replyTarget = e.target.dataset.postId;
    replyModal.classList.remove('hidden');
    replyText.value = '';
    charCount.textContent = '0 / 140';
    replyText.focus();
  }
});

// Zeichen z√§hlen
replyText?.addEventListener('input', () => {
  charCount.textContent = `${replyText.value.length} / 140`;
});

// Abbrechen
cancelReply?.addEventListener('click', () => {
  replyModal.classList.add('hidden');
});

// Absenden
sendReply?.addEventListener('click', async () => {
  const text = replyText.value.trim();
  if (!text) return alert('Empty reply!');
  if (text.length > 140) return alert('Too long!');
  
  if (!wallet) {
    alert("Please connect your wallet first!");
    return;
  }

  replyModal.classList.add('hidden');

  try {
    // Speichern in Supabase
    const { data, error } = await db
      .from('replies')
      .insert([{ 
        post_id: replyTarget, 
        wallet, 
        content: text,
        created_at: new Date().toISOString()
      }])
      .select();

    if (error) {
      console.error(error);
      toast('‚ùå Error sending reply');
      return;
    }

    toast('üåÄ Reply sent!');
    
    // Feed neu laden, um Reply-Z√§hler zu aktualisieren
    await loadFeed();
    
    // Replies-Panel √∂ffnen
    showRepliesForPost(replyTarget);
    
  } catch (err) {
    console.error('Error saving reply:', err);
    toast('‚ùå Error sending reply');
  }
});

/* ---------- Reply Panel Logic ---------- */
const replyPanel = document.getElementById('replyPanel');
const closeReplies = document.getElementById('closeReplies');

async function showRepliesForPost(postId) {
  const list = document.getElementById('replyList');

  const { data, error } = await db
    .from('replies')
    .select('*')
    .eq('post_id', postId)
    .order('created_at', { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  list.innerHTML = data.map(r => `
    <div class="reply-item">
      <b>${r.wallet.slice(0,6)}...</b>
      <p>${r.content}</p>
      <small>${new Date(r.created_at).toLocaleString()}</small>
    </div>
  `).join('');

  replyPanel.classList.remove('hidden');
  replyPanel.classList.add('show');
}

// X-Button klick
closeReplies?.addEventListener('click', () => {
  replyPanel.classList.remove('show');
  setTimeout(() => replyPanel.classList.add('hidden'), 400);
});

// Klick au√üerhalb schlie√üt Panel
document.addEventListener('click', (e) => {
  if (e.target === replyPanel) {
    replyPanel.classList.remove('show');
    setTimeout(() => replyPanel.classList.add('hidden'), 400);
  }
});

/* ---------- Init ---------- */
loadFeed();
updateTrends();
setInterval(updateTrends, 30000); // Update trends every 30 seconds

// Auto-connect if previously connected
window.addEventListener("load", async ()=>{
  const p = getWallet();
  if(p?.isConnected && p.publicKey){
    wallet = p.publicKey.toString();
    uiConnected(wallet);
  }
});

/* === üß© Easter Egg: Triple Click on Logo === */
let clickCount = 0;
const logo = document.querySelector(".logo-anim");
const rick = document.getElementById("rick");
const portal = document.getElementById("portal");
const rickText = document.getElementById("rick-text");
const rickSound = document.getElementById("rickSound");

logo.addEventListener("click", () => {
  clickCount++;
  if (clickCount === 3) {
    triggerRickEasterEgg();
    clickCount = 0;
  }
  setTimeout(() => (clickCount = 0), 1200);
});

function triggerRickEasterEgg() {
  // üéµ Sound abspielen
  rickSound.play().catch(e => console.log("Rick sound failed:", e));
  
  // üíö Portal erscheint
  portal.style.opacity = "1";
  portal.style.animation = "portalOpen 2.8s ease-out, portalGlow 3s ease-in-out infinite";

  // üåÄ Rick fliegt raus mit kombinierter Animation!
  rick.style.opacity = "1";
  rick.style.animation = "rickFlyAndWobble 6s ease-in-out forwards";

  // üí¨ Text poppt auf
  setTimeout(() => {
    rickText.style.opacity = "1";
  }, 2300);

  setTimeout(() => {
    rickText.style.opacity = "0";
  }, 5300);

  // üîÅ Reset alles
  setTimeout(() => {
    portal.style.animation = "none";
    portal.style.opacity = "0";
    rick.style.animation = "none";
    rick.style.opacity = "0";
  }, 7000);
}
</script>
</body>
</html>

