<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cobie ‚Äî Crypto Sentiment Social MVP</title>

<!-- Solana + Supabase -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#05080c; --panel:#0f1622;
  --ink:#e9fbff; --muted:#9ed9e6;
  --accent:#00eaff; --good:#14F195; --bad:#ff6b6b;
}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui;}
header{position:sticky;top:0;background:#0b0f1499;backdrop-filter:blur(6px);padding:12px;border-bottom:1px solid #ffffff22}
.h{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto}
.btn{background:#0f1a24;border:1px solid #ffffff22;padding:8px 14px;border-radius:10px;cursor:pointer;color:var(--ink);font-weight:700}
.status{color:var(--muted);font-size:12px;border:1px solid #ffffff22;padding:6px 10px;border-radius:999px}
.container{max-width:1200px;margin:auto;padding:12px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
.card{background:#111827aa;border:1px solid #ffffff22;border-radius:14px}
.card .body{padding:14px}
textarea{width:100%;height:90px;border-radius:12px;background:#0b1320;border:1px solid #ffffff22;color:white;padding:10px;margin-top:6px}
.post{padding:12px;border-bottom:1px solid #ffffff11;display:grid;grid-template-columns:48px 1fr;gap:12px}
.avatar{width:48px;height:48px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}
.small{font-size:12px;color:var(--muted)}

.post-actions{display:flex;gap:12px;margin-top:6px;align-items:center}
.icon-btn{cursor:pointer;display:flex;align-items:center;gap:4px;font-size:14px;color:var(--muted)}
.icon-btn:hover{color:var(--accent)}
.sol-btn img{width:20px;height:20px}
</style>
</head>

<body>
<header>
  <div class="h">
    <img src="../img/1boss.png" style="width:36px;border-radius:8px;border:2px solid #00eaff77">
    <b style="font-size:20px;background:linear-gradient(90deg,#00eaff,#14F195);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Cobie</b>
    <span style="font-size:12px;color:#9ed9e6">Sentiment Social ‚Äî MVP</span>

    <div style="flex:1"></div>
    <span id="wallet-status" class="status">Nicht verbunden</span>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<audio id="postSound" src="../sounds/mgs2.mp3"></audio>

<div class="container">

<!-- LEFT -->
<div>
  <div class="card">
    <div class="body">
      <h3>Post verfassen</h3>
      <textarea id="postText" maxlength="140" placeholder="Was geht ab?"></textarea>
      <div style="display:flex;align-items:center;margin-top:6px;">
        <span class="small">Geb√ºhr: 0.001 SOL</span>
        <div style="flex:1"></div>
        <button id="postBtn" class="btn">Posten</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="body"><h3>Community Feed</h3></div>
    <div id="feed"></div>
  </div>
</div>

<!-- RIGHT -->
<div>
  <div class="card">
    <div class="body">
      <h3>üìà Market Sentiment</h3>
      <p class="small">Coming soon: AI-Sentiment, Trends, Heatmap üî•</p>
    </div>
  </div>
</div>

</div>

<script>
/* --- Config --- */
const SUPABASE_URL = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "YOUR_SUPABASE_KEY_HERE"; // ‚ö†Ô∏è Replace with your anon key

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC    = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* Supabase */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* UI */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");
const postSound = document.getElementById("postSound");

let wallet = null;

/* --- Wallet --- */
function getWallet(){ return window.phantom?.solana || window.solana; }

function uiConnected(pk){
  statusEl.textContent = `‚úÖ ${pk.slice(0,4)}...${pk.slice(-4)}`;
  connectBtn.textContent="Disconnect";
}

function uiDisconnected(){
  statusEl.textContent="Nicht verbunden";
  connectBtn.textContent="Wallet verbinden";
}

connectBtn.onclick = async()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p) return alert("Phantom installieren!");

  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet=null; uiDisconnected();
}

/* --- SOL Pay --- */
async function sendSol(to, amt){
  const p = getWallet();
  const c = new solanaWeb3.Connection(RPC,"confirmed");
  const tx = new solanaWeb3.Transaction().add(
    solanaWeb3.SystemProgram.transfer({
      fromPubkey:p.publicKey, toPubkey:new solanaWeb3.PublicKey(to),
      lamports:amt * solanaWeb3.LAMPORTS_PER_SOL
    })
  );
  tx.feePayer=p.publicKey;
  tx.recentBlockhash=(await c.getLatestBlockhash()).blockhash;
  const s = await p.signTransaction(tx);
  return await c.sendRawTransaction(s.serialize());
}

/* --- NFT Avatar --- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;
  const r=await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({jsonrpc:"2.0",id:"nft",method:"getAssetsByOwner",params:{ownerAddress:pub}})
  });
  const n=(await r.json())?.result?.items||[];
  const img=n.find(x=>x.content?.metadata?.image)?.content?.metadata?.image;
  if(img) localStorage.setItem("a_"+pub,img);
  return img;
}

/* --- Database Actions --- */
async function savePost(t,tx){ await db.from("posts").insert([{wallet,content:t,tx}]); }

async function updateVote(id,dir){
  await db.rpc(dir==="up"?"increment_upvotes":"increment_downvotes",{post_id:id});
}

/* --- Feed --- */
async function loadFeed(){
  const {data}=await db.from("posts").select("*").order("created_at",{ascending:false});
  feed.innerHTML="";
  for(const p of data){
    const img = await avatar(p.wallet);
    feed.innerHTML+=`
    <div class="post">
      <div class="avatar">${img?`<img src="${img}">`:``}</div>
      <div>
        <b>${p.wallet.slice(0,6)}...</b>
        <p>${p.content}</p>
        <div class="post-actions">
          <span class="icon-btn" onclick="vote('${p.id}','up')">üëç ${p.upvotes||0}</span>
          <span class="icon-btn" onclick="vote('${p.id}','down')">üëé ${p.downvotes||0}</span>
          <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
            <img src="https://cryptologos.cc/logos/solana-sol-logo.png">
          </span>
          <a class="small" target="_blank" href="https://solscan.io/tx/${p.tx}">TX ansehen</a>
        </div>
      </div>
    </div>`;
  }
}

window.vote=async(id,d)=>{await updateVote(id,d);loadFeed();}
async function tipUser(to){
  if(to===wallet) return alert("Bro‚Ä¶ nicht dich selbst üòÇ");
  const sig=await sendSol(to,0.001);
  alert("üí∏ Tip gesendet!\n"+sig);
}

/* --- Posting --- */
postBtn.onclick=async()=>{
  if(!wallet) return alert("Wallet verbinden!");
  const t=postText.value.trim(); if(!t) return alert("Text fehlt!");
  postBtn.disabled=true; postBtn.textContent="Sende...";
  try{
    const tx=await sendSol(RECEIVER_WALLET,0.001);
    await savePost(t,tx);
    postText.value=""; postSound.play();
    alert("‚úÖ Gespeichert!"); loadFeed();
  }catch(e){alert("‚ùå "+e.message);}
  postBtn.disabled=false; postBtn.textContent="Posten";
}

/* Init */
loadFeed();
</script>
</body>
</html>
