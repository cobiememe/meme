<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cobie — Crypto Sentiment Social (MVP Layout)</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

<style>
  :root{--bg:#0b0f14;--ink:#e9fbff;--muted:#9ed9e6;}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#05080c;color:var(--ink);font-family:Inter,system-ui}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:#0b0f14aa;border-bottom:1px solid #ffffff15}
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  .brand-logo{width:38px;height:38px;border-radius:8px;object-fit:cover;border:2px solid #00eaff88}
  .brand-main{font-size:20px;background:linear-gradient(90deg,#00eaff,#14f195,#00ffa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid #ffffff15;border-radius:999px}
  .btn{background:#0f1a24;border:1px solid #ffffff15;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:#11182799;border:1px solid #ffffff15;border-radius:16px}
  .card .body{padding:14px}
  .post{padding:12px;display:grid;grid-template-columns:42px 1fr;gap:12px;border-bottom:1px solid #ffffff11}
  .avatar{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);overflow:hidden}
  .muted{color:var(--muted);font-size:12px}
  img.avatar{object-fit:cover}
</style>
</head>

<body>
<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="brand-logo" alt="logo">
      <div>
        <div class="brand-main">Cobie</div>
        <div style="font-size:13px;color:#9ed9e6">Sentiment Social — MVP</div>
      </div>
    </div>
    <span id="wallet-status" class="status">Nicht verbunden</span>
    <div style="flex:1"></div>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Post verfassen</h3>
          <textarea id="postText" maxlength="140" style="width:100%;height:90px"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="muted">Gebühr: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Posten</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body"><h3>Community Feed</h3></div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card"><div class="body"><h3>Sentiment & Trends</h3></div></div>
    </aside>
  </div>
</main>

<script>
// ---- CONFIG ----
const RECEIVER_STR = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS_KEY = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

// ---- UI ----
const walletStatus = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");

let provider = null;
let publicKey = null;
let walletConnected = false;

// ---- PROVIDER ----
function getProvider() {
  if (window.phantom?.solana) return window.phantom.solana;
  if (window.solana) return window.solana;
  return null;
}

function setUIConnected(pk) {
  walletStatus.textContent = "✅ " + pk.slice(0,4) + "..." + pk.slice(-4);
  connectBtn.textContent = "Disconnect";
}
function setUIDisconnected() {
  walletStatus.textContent = "Nicht verbunden";
  connectBtn.textContent = "Wallet verbinden";
}

async function connectWallet() {
  const p = getProvider();
  if (!p) return alert("Phantom Wallet nicht gefunden.");
  try {
    provider = p;
    const res = await p.connect();
    publicKey = res.publicKey.toString();
    walletConnected = true;
    setUIConnected(publicKey);
  } catch(e) {
    alert("Verbindung fehlgeschlagen: " + e.message);
  }
}

async function disconnectWallet() {
  try { await provider?.disconnect(); } catch(e){}
  provider = null; publicKey = null; walletConnected = false;
  setUIDisconnected();
}

connectBtn.onclick = () => walletConnected ? disconnectWallet() : connectWallet();

// ---- SOL PAYMENT ----
async function sendSOL(amount) {
  try {
    const p = getProvider();
    if (!p || !p.isConnected) throw new Error("Bitte Wallet verbinden");
    const conn = new solanaWeb3.Connection(RPC_URL, "confirmed");
    const SENDER = p.publicKey;
    const RECEIVER = new solanaWeb3.PublicKey(RECEIVER_STR);
    const lamports = Math.floor(amount * solanaWeb3.LAMPORTS_PER_SOL);
    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({fromPubkey:SENDER,toPubkey:RECEIVER,lamports})
    );
    tx.feePayer = SENDER;
    tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;
    const signed = await p.signTransaction(tx);
    const sig = await conn.sendRawTransaction(signed.serialize());
    await conn.confirmTransaction(sig);
    return sig;
  } catch(e) {
    alert("Zahlung abgebrochen: " + e.message);
    return false;
  }
}

// ---- NFT AVATAR FETCH ----
async function getWalletAvatar(wallet) {
  try {
    const cached = localStorage.getItem("avatar_" + wallet);
    if (cached) return cached;
    const resp = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS_KEY}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: "getNFTs",
        method: "getAssetsByOwner",
        params: { ownerAddress: wallet }
      })
    });
    const data = await resp.json();
    const nfts = data?.result?.items || [];
    const first = nfts.find(n => n?.content?.metadata?.image);
    const img = first?.content?.metadata?.image || null;
    if (img) localStorage.setItem("avatar_" + wallet, img);
    return img;
  } catch(e) {
    console.error("Avatar fetch error", e);
    return null;
  }
}

// ---- POST ----
async function addPost(text) {
  const pk = publicKey || "Guest";
  const avatar = await getWalletAvatar(pk);
  const avatarHTML = avatar
    ? `<img src="${avatar}" class="avatar">`
    : `<div class="avatar"></div>`;
  feed.innerHTML = `
    <div class="post">
      ${avatarHTML}
      <div><b>${pk.slice(0,6)}...</b><p>${text}</p></div>
    </div>` + feed.innerHTML;
}

postBtn.onclick = async () => {
  const text = document.getElementById("postText").value.trim();
  if (!walletConnected) return alert("Bitte Wallet verbinden");
  if (!text) return alert("Bitte Text eingeben");
  postBtn.disabled = true; postBtn.textContent = "Sende 0.001 SOL...";
  try {
    const sig = await sendSOL(0.001);
    if (!sig) throw new Error("Zahlung fehlgeschlagen");
    await addPost(text);
    alert("✅ Zahlung erfolgreich!\nTX: https://solscan.io/tx/" + sig);
  } catch(e) {
    alert("Fehler: " + e.message);
  }
  postBtn.disabled = false; postBtn.textContent = "Posten";
  document.getElementById("postText").value = "";
};

window.addEventListener("load", () => {
  const p = getProvider();
  if (p && p.isConnected && p.publicKey) {
    publicKey = p.publicKey.toString();
    walletConnected = true;
    setUIConnected(publicKey);
  } else setUIDisconnected();
});
</script>
</body>
</html>
