<!DOCTYPE html>
<html lang="de">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cobie â€" Crypto Sentiment Social (MVP)</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --ink:#e9fbff; --muted:#9ed9e6; --accent:#00eaff;
    --good:#14F195; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.08),transparent 60%),
    linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:var(--accent)}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.94),rgba(10,15,22,.6));border-bottom:1px solid rgba(255,255,255,.06)}
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  .brand-logo{width:38px;height:38px;border-radius:8px;object-fit:cover;border:2px solid rgba(0,234,255,0.5);box-shadow:0 0 12px rgba(0,234,255,0.35)}
  .brand-main{font-weight:800;font-size:20px;background:linear-gradient(90deg,#00eaff,#14f195,#00ffa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .btn{appearance:none;border:none;background:linear-gradient(135deg,rgba(0,234,255,.12),rgba(0,191,255,.12));color:var(--ink);
    border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(17,24,39,.6),rgba(7,10,16,.7));
    border:1px solid rgba(255,255,255,.08);border-radius:16px}
  .card .body{padding:14px}
  .post{padding:12px;display:grid;grid-template-columns:48px 1fr;gap:12px;border-bottom:1px solid rgba(255,255,255,.04)}
  .avatar{width:48px;height:48px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);overflow:hidden;display:block}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .muted{color:var(--muted);font-size:12px}
  textarea{background:#09101a;border:1px solid rgba(255,255,255,.06);color:var(--ink);border-radius:12px;padding:10px;font:inherit}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="brand-logo" alt="Cobie">
      <div>
        <div class="brand-main">Cobie</div>
        <div class="small">Sentiment Social â€" MVP</div>
      </div>
    </div>

    <span id="wallet-status" class="status">Nicht verbunden</span>
    <div style="flex:1"></div>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Post verfassen</h3>
          <textarea id="postText" maxlength="140" style="width:100%;height:90px"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">GebÃ¼hr: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Posten</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body"><h3>Community Feed</h3></div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card"><div class="body"><h3>Sentiment & Trends</h3></div></div>
    </aside>
  </div>
</main>

<script>
// ---------------- CONFIG (your keys & URLs) ----------------
const SUPABASE_URL = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_STR = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS_KEY = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

// ---------------- LIB INIT ----------------
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON);

// ---------------- UI refs ----------------
const connectBtn = document.getElementById("connectBtn");
const walletStatus = document.getElementById("wallet-status");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");

let provider = null;
let publicKey = null;
let walletConnected = false;

// ---------------- Provider detection (robust) ----------------
function getProvider(){
  // prefer window.phantom.solana, fallback to window.solana if it's Phantom
  if (window.phantom && window.phantom.solana) return window.phantom.solana;
  if (window.solana && window.solana.isPhantom) return window.solana;
  // some wallets set window.solana without isPhantom; still return it
  if (window.solana && window.solana.isConnected !== undefined) return window.solana;
  return null;
}

// ---------------- UI helpers ----------------
function setUIConnected(pk){
  walletStatus.textContent = "âœ… " + pk.slice(0,4) + "..." + pk.slice(-4);
  connectBtn.textContent = "Disconnect";
}
function setUIDisconnected(){
  walletStatus.textContent = "Nicht verbunden";
  connectBtn.textContent = "Wallet verbinden";
}

// ---------------- Connect / Disconnect ----------------
async function connectWallet(){
  const p = getProvider();
  if(!p) { alert("Phantom nicht gefunden. Installiere Phantom."); window.open("https://phantom.app", "_blank"); return; }
  try {
    provider = p;
    const res = await p.connect();
    publicKey = res.publicKey.toString();
    walletConnected = true;
    setUIConnected(publicKey);
    console.log("Connected:", publicKey);
  } catch (e) {
    console.error("connectWallet error", e);
    alert("Connect failed: " + (e?.message || e));
  }
}
async function disconnectWallet(){
  try { await provider?.disconnect(); } catch(e){ console.warn(e); }
  provider = null; publicKey = null; walletConnected = false;
  setUIDisconnected();
}
connectBtn.onclick = () => walletConnected ? disconnectWallet() : connectWallet();

// ---------------- Sol transfer (Phantom-friendly) ----------------
async function sendSOL(amount){
  const p = getProvider();
  if(!p || !p.publicKey) throw new Error("Bitte Wallet verbinden");
  const conn = new solanaWeb3.Connection(RPC_URL, "confirmed");
  const S = p.publicKey;
  const R = new solanaWeb3.PublicKey(RECEIVER_STR);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);
  const tx = new solanaWeb3.Transaction().add(
    solanaWeb3.SystemProgram.transfer({fromPubkey:S, toPubkey:R, lamports})
  );
  tx.feePayer = S;
  tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;
  // Phantom: signTransaction then sendRawTransaction
  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight: false });
  await conn.confirmTransaction(sig, "confirmed");
  return sig;
}

// ---------------- Helius: get wallet NFTs (simple) ----------------
async function fetchWalletNFTs(wallet){
  try {
    const res = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS_KEY}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        jsonrpc:"2.0",
        id:"getAssets",
        method:"getAssetsByOwner",
        params:{ ownerAddress: wallet }
      })
    });
    return await res.json();
  } catch(e) {
    console.error("Helius fetch error", e);
    return null;
  }
}

async function getWalletAvatar(wallet){
  // cache key
  const key = "avatar_" + wallet;
  const cached = localStorage.getItem(key);
  if (cached) return cached;
  const data = await fetchWalletNFTs(wallet);
  const items = data?.result?.items || [];
  if (!items.length) return null;
  // choose first with image
  const first = items.find(it => it?.content?.metadata?.image);
  const img = first?.content?.metadata?.image || null;
  if (img) localStorage.setItem(key, img);
  return img;
}

// ---------------- Supabase: load feed, save post, realtime ----------------
async function loadFeed(){
  try {
    const { data, error } = await supabaseClient.from("posts").select("*").order("created_at",{ascending:false}).limit(50);
    if (error) { console.error("supabase load error", error); return; }
    // collect unique wallets to fetch avatars (cache-aware)
    const wallets = [...new Set(data.map(d=>d.wallet))];
    const avatarMap = {};
    for (const w of wallets){
      avatarMap[w] = await getWalletAvatar(w);
    }
    feed.innerHTML = data.map(p => {
      const avatarHTML = avatarMap[p.wallet] ? `<span class="avatar"><img src="${avatarMap[p.wallet]}" alt="pfp"></span>` : `<span class="avatar"></span>`;
      return `
      <div class="post">
        ${avatarHTML}
        <div>
          <b>${p.wallet.slice(0,6)}...</b>
          <p>${p.content}</p>
          <a class="muted" href="https://solscan.io/tx/${p.tx}" target="_blank">TX ansehen</a>
        </div>
      </div>`;
    }).join("");
  } catch(e){
    console.error("loadFeed error", e);
  }
}

async function savePostToDB(wallet, content, tx){
  try {
    const { data, error } = await supabaseClient.from("posts").insert([{ wallet, content, tx }]);
    if (error) { console.error("savePost error", error); return false; }
    return true;
  } catch(e) {
    console.error("savePostToDB error", e);
    return false;
  }
}

// ---- Anti-spam cooldown check ----
async function canPost(wallet) {
  const { data, error } = await supabaseClient
    .from("posts")
    .select("created_at")
    .eq("wallet", wallet)
    .order("created_at", { ascending: false })
    .limit(1);

  if (error || !data || data.length === 0) return true;

  const last = new Date(data[0].created_at);
  const diff = (Date.now() - last.getTime()) / 1000;
  return diff >= 60; // 60 seconds
}

// ---- UI Cooldown timer ----
function startCooldown(seconds) {
  let time = seconds;
  postBtn.disabled = true;
  const interval = setInterval(() => {
    postBtn.textContent = `Warte ${time}s`;
    time--;
    if (time <= 0) {
      clearInterval(interval);
      postBtn.textContent = "Posten";
      postBtn.disabled = false;
    }
  }, 1000);
}

// Realtime subscribe
supabaseClient.channel("public:posts")
  .on("postgres_changes", { event: "INSERT", schema: "public", table: "posts" }, payload => {
    // when new post inserted, reload feed (simple)
    loadFeed();
  })
  .subscribe()
  .catch(e => console.warn("realtime sub failed", e));

// initial load
loadFeed();

// ---------------- Post flow ----------------
postBtn.onclick = async () => {
  const text = postText.value.trim();
  if (!text) return alert("Bitte Text eingeben");
  if (!walletConnected) return alert("Bitte Wallet verbinden");

  // ⏳ Cooldown check
  const ok = await canPost(publicKey);
  if (!ok) {
    alert("⏳ Du kannst nur alle 60 Sekunden posten!");
    startCooldown(60);
    return;
  }

  postBtn.disabled = true;
  postBtn.textContent = "Sende 0.001 SOL...";

  try {
    const sig = await sendSOL(0.001);
    if (!sig) throw new Error("TX fehlgeschlagen");
    // save in supabase
    const saved = await savePostToDB(publicKey, text, sig);
    if (!saved) throw new Error("DB save fehlgeschlagen");
    // UI: the realtime listener will refresh feed â€" but add immediate optimistic post:
    const avatar = await getWalletAvatar(publicKey);
    const avatarHTML = avatar ? `<span class="avatar"><img src="${avatar}" alt="pfp"></span>` : `<span class="avatar"></span>`;
    feed.innerHTML = `
      <div class="post">
        ${avatarHTML}
        <div><b>${publicKey.slice(0,6)}...</b><p>${text}</p><a class="muted" href="https://solscan.io/tx/${sig}" target="_blank">TX ansehen</a></div>
      </div>
    ` + feed.innerHTML;
    postText.value = "";
    alert("âœ… Zahlung & Post gespeichert\nTX: https://solscan.io/tx/" + sig);
  } catch (e){
    console.error("post error", e);
    alert("Fehler: " + (e?.message || e));
  } finally {
    postBtn.disabled = false;
    postBtn.textContent = "Posten";
  }
};

// On load: if wallet already present, set UI
window.addEventListener("load", async () => {
  const p = getProvider();
  if (p && p.isConnected && p.publicKey) {
    provider = p;
    publicKey = p.publicKey.toString();
    walletConnected = true;
    setUIConnected(publicKey);
  } else {
    setUIDisconnected();
  }
});
</script>
</body>
</html>

