<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cobie ‚Äî Crypto Sentiment Social MVP</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0f14; --panel:#0f1622;
  --ink:#e9fbff; --muted:#9ed9e6;
  --accent:#00eaff; --good:#14F195;
}
html,body{margin:0;padding:0;background:#05080c;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;background:#0b0f1499;backdrop-filter:blur(6px);padding:12px;border-bottom:1px solid #ffffff22}
.h{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto}
.btn{background:#0f1a24;border:1px solid #ffffff22;padding:8px 14px;border-radius:10px;cursor:pointer;color:var(--ink);font-weight:700}
.status{color:var(--muted);font-size:12px;border:1px solid #ffffff22;padding:6px 10px;border-radius:999px}
.container{max-width:1200px;margin:auto;padding:12px}
.card{background:#111827aa;border:1px solid #ffffff22;border-radius:14px;margin-bottom:14px}
.card .body{padding:14px}
textarea{width:100%;height:90px;border-radius:12px;background:#0b1320;border:1px solid #ffffff22;color:white;padding:10px;margin-top:6px}
.post{padding:12px;border-bottom:1px solid #ffffff11;display:grid;grid-template-columns:44px 1fr;gap:12px}
.avatar{width:44px;height:44px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.small{font-size:12px;color:var(--muted)}
.tip-btn{background:#062018;border:1px solid #00ffa388;color:#00ffa3;margin-top:4px;padding:4px 8px;font-size:12px;border-radius:6px;cursor:pointer}
</style>
</head>

<body>
<header>
  <div class="h">
    <img src="../img/1boss.png" style="width:36px;border-radius:8px;border:2px solid #00eaff77" alt="Cobie">
    <b style="font-size:20px;background:linear-gradient(90deg,#00eaff,#14f195,#00ffa3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Cobie</b>
    <span style="font-size:12px;color:#9ed9e6">Sentiment Social ‚Äî MVP</span>

    <div style="flex:1"></div>
    <span id="wallet-status" class="status">Nicht verbunden</span>
    <button id="connectBtn" class="btn">Wallet verbinden</button>
  </div>
</header>

<div class="container">

  <div class="card">
    <div class="body">
      <h3>Post verfassen</h3>
      <textarea id="postText" maxlength="140" placeholder="Was geht ab?"></textarea>
      <div style="display:flex;align-items:center;margin-top:6px;gap:12px">
        <span class="small">Geb√ºhr: 0.001 SOL</span>
        <div style="flex:1"></div>
        <button id="postBtn" class="btn">Posten</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="body"><h3>Community Feed</h3></div>
    <div id="feed"></div>
  </div>

</div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* ---------- LIB INIT ---------- */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- UI refs ---------- */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");

let wallet = null;

/* ---------- Wallet helpers ---------- */
function getWallet(){ return window.phantom?.solana || window.solana; }
function uiConnected(pk){ statusEl.textContent = `‚úÖ ${pk.slice(0,4)}...${pk.slice(-4)}`; connectBtn.textContent="Disconnect"; }
function uiDisconnected(){ statusEl.textContent = "Nicht verbunden"; connectBtn.textContent="Wallet verbinden"; }

connectBtn.onclick = async ()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom nicht gefunden. Bitte installieren."); window.open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet = null; uiDisconnected();
}

/* ---------- Payment (robust confirm) ---------- */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Bitte Wallet verbinden");
  const conn = new solanaWeb3.Connection(RPC, { commitment:"confirmed", confirmTransactionInitialTimeout:120000 });

  const from = p.publicKey;
  const to   = new solanaWeb3.PublicKey(RECEIVER_WALLET);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);

  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("finalized");

  const tx = new solanaWeb3.Transaction({
    feePayer: from,
    recentBlockhash: blockhash
  }).add(
    solanaWeb3.SystemProgram.transfer({ fromPubkey: from, toPubkey: to, lamports })
  );

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false, maxRetries:6 });

  await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
  return sig;
}

/* ---------- NFT Avatar via Helius ---------- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;

  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });
  const json = await r.json();
  const items = json?.result?.items || [];
  // prefer metadata.image, fallback content.files[0].uri
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;

  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* ---------- DB ops ---------- */
async function savePost(text, tx){
  const { error } = await db.from("posts").insert([{ wallet, content:text, tx }]);
  if(error) throw error;
}

async function loadFeed(){
  const { data, error } = await db.from("posts").select("*").order("created_at",{ascending:false}).limit(50);
  if(error){ console.error("Supabase load error:", error); return; }

  feed.innerHTML = "";
  for(const p of (data || [])){
    const img = await avatar(p.wallet);
    feed.innerHTML += `
      <div class="post">
        <div class="avatar">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
        <div>
          <b>${p.wallet.slice(0,6)}...</b>
          <p>${p.content}</p>
          <a class="small" target="_blank" href="https://solscan.io/tx/${p.tx}">TX ansehen</a><br>
          <button class="tip-btn" onclick="tip('${p.wallet}')">Tip üí∏</button>
        </div>
      </div>`;
  }
}

/* ---------- Cooldown ---------- */
async function canPost(pub){
  const { data, error } = await db.from("posts").select("created_at").eq("wallet", pub).order("created_at", {ascending:false}).limit(1);
  if(error || !data?.length) return true;
  const last = new Date(data[0].created_at);
  return (Date.now() - last.getTime())/1000 >= 60;
}
function startCooldown(sec){
  let t = sec; postBtn.disabled = true;
  const id = setInterval(()=>{ postBtn.textContent = `Warte ${t--}s`; if(t<0){ clearInterval(id); postBtn.textContent="Posten"; postBtn.disabled=false; }}, 1000);
}

/* ---------- Realtime Feed ---------- */
db.channel("public:posts")
  .on("postgres_changes", { event:"INSERT", schema:"public", table:"posts" }, () => loadFeed())
  .subscribe();

/* ---------- Tip (Phase 2 placeholder) ---------- */
window.tip = async (to)=>{ alert("Tip kommt in Phase 2 ‚úÖ"); };

/* ---------- Post action ---------- */
postBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!wallet) return alert("Bitte Wallet verbinden!");
  if(!text) return alert("Bitte Text eingeben!");

  // Cooldown
  const ok = await canPost(wallet);
  if(!ok){ alert("‚è≥ Du kannst nur alle 60 Sekunden posten!"); startCooldown(60); return; }

  postBtn.disabled = true; postBtn.textContent = "Sende 0.001 SOL...";

  try{
    const sig = await pay(0.001);
    await savePost(text, sig);
    postText.value = "";
    alert("‚úÖ Geschickt & gespeichert!");
  }catch(e){
    alert("‚ùå Fehler: " + (e?.message || e));
  }

  postBtn.disabled = false; postBtn.textContent = "Posten";
  loadFeed();
};

/* ---------- Init ---------- */
loadFeed();
</script>
</body>
</html>
