<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="../img/favicon.png">
<title>Gobbles ‚Äî Cope Harder!</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --ink:#e9fbff; --muted:#9ed9e6; --accent:#00eaff;
    --good:#14F195; --bad:#ff6b6b; --purple:#9945FF; --blue:#00eaff;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0;
    background:
      radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.08),transparent 60%),
      linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial
  }
  a{color:var(--accent)}

  /* === Header & Grundlayout (altes Design) === */
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px}
  header{
    position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.94),rgba(10,15,22,.6));
    border-bottom:1px solid rgba(255,255,255,.06)
  }
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .btn{
    appearance:none;border:none;background:linear-gradient(135deg,rgba(0,234,255,.12),rgba(0,191,255,.12));color:var(--ink);
    border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer
  }
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,rgba(17,24,39,.6),rgba(7,10,16,.7));
    border:1px solid rgba(255,255,255,.08);border-radius:16px
  }
  .card .body{padding:14px}
  textarea{
    background:#09101a;border:1px solid rgba(255,255,255,.06);color:var(--ink);
    border-radius:12px;padding:10px;font:inherit;width:100%;height:120px;resize:vertical
  }
  .post{
    padding:12px;display:grid;grid-template-columns:48px 1fr;gap:12px;
    border-bottom:1px solid rgba(255,255,255,.04);
    opacity:0; animation:fadeUp .35s ease forwards
  }
  .post:hover{background:rgba(0,255,180,0.05);box-shadow:0 0 12px rgba(0,255,180,0.15);transform:translateY(-2px)}
  @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .avatar{
    width:48px;height:48px;border-radius:12px;background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);
    overflow:hidden;display:block;animation:pulseGlow 3s infinite ease-in-out
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  @keyframes pulseGlow{
    0%{box-shadow:0 0 6px rgba(0,255,180,0.25)}
    50%{box-shadow:0 0 14px rgba(0,255,180,0.55)}
    100%{box-shadow:0 0 6px rgba(0,255,180,0.25)}
  }
  .muted{color:var(--muted);font-size:12px}
  .small{font-size:12px;color:var(--muted)}
  .post-actions{display:flex;gap:18px;margin-top:6px;align-items:center}
  .icon-btn{cursor:pointer;font-size:14px;color:var(--muted);transition:all 0.2s ease;padding:4px 8px;border-radius:6px}
  .icon-btn:hover{color:var(--accent);background:rgba(0,234,255,0.1)}
  .sol-icon{width:20px;height:20px;border-radius:6px}

  /* === Voting Farben (wie zuvor) === */
  .vote-btn{
    cursor:pointer;display:flex;align-items:center;gap:4px;font-size:14px;color:#7b8ca4;
    transition:0.2s;padding:4px 8px;border-radius:6px
  }
  .vote-btn:hover{opacity:0.8}
  .vote-btn.active-up{color:#14F195;text-shadow:0 0 6px rgba(20,241,149,.7);font-weight:700}
  .vote-btn.active-down{color:#9945FF;text-shadow:0 0 6px rgba(153,69,255,.7);font-weight:700}

  /* === G wobble + leichter Logo-Wobble (behalten) === */
  .g-wobble{display:inline-block;animation:wobble 3s ease-in-out infinite,spin 8s linear infinite;transform-origin:center}
  @keyframes wobble{0%,100%{transform:rotate(0deg) scale(1)}20%{transform:rotate(-5deg) scale(1.05)}40%{transform:rotate(4deg) scale(1.05)}}
  @keyframes spin{0%{transform:rotate(0)}92%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .logo-anim{animation:wobble 4s ease-in-out infinite}

  /* === Boom-Drop Animation f√ºr neuen Post (unver√§ndert) === */
  .post-boom{animation:dropBoom 0.55s cubic-bezier(.17,.67,.45,1.32) forwards;opacity:0}
  @keyframes dropBoom{
    0%{transform:translateY(-120px) scale(0.8) rotate(-3deg);opacity:0;box-shadow:none}
    80%{transform:translateY(8px) scale(1.03);opacity:1}
    100%{transform:translateY(0) scale(1);box-shadow:0 0 18px rgba(0,255,150,.4)}
  }
</style>
</head>
<body>

<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="logo-anim" style="width:52px;border-radius:10px;border:3px solid #00eaff77" alt="Gobbles">
      <div>
        <b style="font-size:26px;"><span class="g-wobble">G</span>obbles</b>
        <div class="small">Cope Harder!</div>
      </div>
    </div>
    <div style="flex:1"></div>
    <span id="wallet-status" class="status">Not connected</span>
    <button id="connectBtn" class="btn">Connect Wallet</button>
  </div>
</header>

<!-- Sounds (wie gehabt) -->
<audio id="postSound"><source src="../sounds/mgs2.mp3" type="audio/mpeg"></audio>
<audio id="coinSound"><source src="../sounds/coin.mp3" type="audio/mpeg"></audio>
<audio id="boomSound"><source src="../sounds/boom.mp3" type="audio/mpeg"></audio>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Create Post</h3>
          <textarea id="postText" maxlength="140" placeholder="What's happening?"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">Fee: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Post</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body"><h3>Community Feed</h3></div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="body">
          <h3>Sentiment & Trends</h3>
          <div class="input-group">
            <label class="small">Search Posts (coming soon)</label>
            <input type="text" class="text-input" placeholder="Enter keyword..." disabled
              style="background:#09101a;border:2px solid rgba(255,255,255,.1);color:var(--ink);border-radius:10px;padding:10px 12px;width:100%;font:inherit;">
          </div>
          <div class="input-group" style="margin-top:10px">
            <label class="small">Filter by User (coming soon)</label>
            <input type="text" class="text-input" placeholder="Wallet address..." disabled
              style="background:#09101a;border:2px solid rgba(255,255,255,.1);color:var(--ink);border-radius:10px;padding:10px 12px;width:100%;font:inherit;">
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- ===== SNS Resolver (nur Funktionen, kein Design-Change) ===== -->
<script type="module">
  import { PublicKey, Connection } from "https://esm.sh/@solana/web3.js@1.95.3";
  import { reverseLookup } from "https://esm.sh/@bonfida/spl-name-service@3.1.0";

  // deine bestehende Helius RPC
  const SNS_CONN = new Connection("https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841","confirmed");
  const snsCache = new Map();

  async function resolveSolanaName(address){
    if(snsCache.has(address)) return snsCache.get(address);
    try {
      const name = await reverseLookup(SNS_CONN, new PublicKey(address)).catch(()=>null);
      const value = name ? name + ".sol" : null;
      snsCache.set(address, value);
      if(value) localStorage.setItem("sns_"+address, value);
      return value;
    } catch {
      const cached = localStorage.getItem("sns_"+address);
      snsCache.set(address, cached || null);
      return cached || null;
    }
  }

  window.displayWalletName = async (address, el)=>{
    const short = `${address.slice(0,4)}‚Ä¶${address.slice(-4)}`;
    const name = await resolveSolanaName(address);
    el.textContent = name ? `${short} (${name})` : short;
  };
</script>

<script>
/* ===== Funktionalit√§t (nur Erg√§nzungen, Design unver√§ndert) ===== */

/* CONFIG */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* LIB INIT */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* UI refs */
const statusEl  = document.getElementById("wallet-status");
const connectBtn= document.getElementById("connectBtn");
const postBtn   = document.getElementById("postBtn");
const feed      = document.getElementById("feed");
const postText  = document.getElementById("postText");
const postSound = document.getElementById("postSound");
const coinSound = document.getElementById("coinSound");
const boomSound = document.getElementById("boomSound");

let wallet = null;

/* Wallet helpers */
function getWallet(){ return window.phantom?.solana || window.solana; }

function uiConnected(pk){
  statusEl.textContent = "‚úÖ ";
  const span = document.createElement("span");
  statusEl.appendChild(span);
  // SNS-Anzeige
  displayWalletName(pk, span);
  connectBtn.textContent="Disconnect";
}
function uiDisconnected(){ statusEl.textContent = "Not connected"; connectBtn.textContent="Connect Wallet"; }

connectBtn.onclick = async ()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom wallet not found. Please install Phantom."); window.open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}
async function disconnect(){ await getWallet()?.disconnect(); wallet=null; uiDisconnected(); }

/* Payment (bew√§hrt) */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Please connect wallet first");
  const conn = new solanaWeb3.Connection(RPC, "confirmed");

  const tx = new solanaWeb3.Transaction().add(
    solanaWeb3.SystemProgram.transfer({
      fromPubkey: p.publicKey,
      toPubkey: new solanaWeb3.PublicKey(RECEIVER_WALLET),
      lamports: Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL)
    })
  );
  tx.feePayer = p.publicKey;
  tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false });
  return sig;
}

/* NFT Avatar via Helius */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;

  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });

  const items = (await r.json())?.result?.items || [];
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;
  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* DB ops */
async function savePost(text, tx){
  const { error } = await db.from("posts").insert([{ wallet, content:text, tx }]);
  if(error) throw error;
}

/* Voting */
window.vote = async (id, dir)=>{
  if(!wallet) return alert("Please connect your wallet!");
  const res = await db.rpc(dir==="up" ? "vote_up" : "vote_down", { p_post_id:id, p_wallet:wallet });
  if(!res.error){
    localStorage.setItem("vote_"+id, dir);
    coinSound.currentTime=0; coinSound.play();
  }
  loadFeed();
};

/* FEED (REIHENFOLGE FIXED) */
async function loadFeed(){
  const { data, error } = await db.from("posts").select("*").order("created_at",{ascending:false}).limit(50);
  if(error){ console.error("Supabase load error:", error); return; }

  const htmlParts = [];

  for(const p of (data || [])){
    const img = await avatar(p.wallet);
    const userVote = localStorage.getItem("vote_" + p.id);

    htmlParts.push(`
      <div class="post">
        <div class="avatar">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
        <div>
          <b class="wallet-label" data-wallet="${p.wallet}">${p.wallet.slice(0,6)}‚Ä¶</b>
          <p>${p.content}</p>
          <div class="post-actions">
            <span class="vote-btn ${userVote === "up" ? "active-up" : ""}" onclick="vote('${p.id}','up')">üëç ${p.upvotes||0}</span>
            <span class="vote-btn ${userVote === "down" ? "active-down" : ""}" onclick="vote('${p.id}','down')">üëé ${p.downvotes||0}</span>
            <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
              <img src="../img/1Solana.png" class="sol-icon">
            </span>
            <a target="_blank" class="small" href="https://solscan.io/tx/${p.tx}">TX ansehen</a>
          </div>
        </div>
      </div>
    `);
  }

  // EINMALIG setzen ‚Üí Reihenfolge bleibt korrekt
  feed.innerHTML = htmlParts.join("");

  // SNS Namen nachladen (asynchron, ohne Layout-Shift)
  document.querySelectorAll(".wallet-label").forEach(el=>{
    displayWalletName(el.dataset.wallet, el);
  });
}

/* Tip Placeholder */
window.tipUser = async (to)=>{
  if(!wallet) return alert("Please connect your wallet to tip!");
  if(to === wallet) return alert("You can't tip yourself! üòÇ");
  alert("Tip feature coming in Phase 2 ‚úÖ");
};

/* Post action (Boom + Sound + Optimistic UI) */
postBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!wallet) return alert("Please connect your wallet first!");
  if(!text) return alert("Please enter some text!");

  // Optimistisches Prepend mit Boom
  const img = await avatar(wallet);
  const temp = document.createElement("div");
  temp.className = "post post-boom";
  temp.innerHTML = `
    <div class="avatar">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
    <div>
      <b class="wallet-label" data-wallet="${wallet}">${wallet.slice(0,6)}‚Ä¶</b>
      <p>${text}</p>
      <div class="post-actions">
        <span class="small">pending blockchain...</span>
      </div>
    </div>
  `;
  feed.prepend(temp);

  // Name sofort h√ºbsch anzeigen (SNS async)
  const label = temp.querySelector(".wallet-label");
  if(label) displayWalletName(wallet, label);

  // Boom Sound
  try{ boomSound.currentTime=0; boomSound.play(); }catch(e){}

  postBtn.disabled = true; postBtn.textContent = "Sending 0.001 SOL...";

  try{
    const sig = await pay(0.001);
    await savePost(text, sig);
    postText.value = "";
    try{ postSound.currentTime=0; postSound.play(); }catch(e){}
  }catch(e){
    alert("‚ùå Error: " + (e?.message || e));
  }

  postBtn.disabled = false; postBtn.textContent = "Post";
  loadFeed();
};

/* Init + Realtime */
loadFeed();
db.channel("public:posts")
  .on("postgres_changes", { event:"INSERT", schema:"public", table:"posts" }, () => loadFeed())
  .subscribe();
</script>
</body>
</html>
