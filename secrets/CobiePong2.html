<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>CobiePong</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    #game-wrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* TRIPPY BACKGROUND (secret2) */
    #trippy {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* THREE.JS CANVAS */
    #three-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #crt-overlay, #vignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }

    #crt-overlay {
      mix-blend-mode: overlay;
      opacity: 0.25;
      background-image:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0.5),
          rgba(0,0,0,0.5) 1px,
          rgba(0,0,0,0) 4px
        );
    }

    #vignette {
      background: radial-gradient(circle at center, rgba(0,0,0,0) 55%, rgba(0,0,0,0.75) 100%);
    }

    /* SCORE */
    #score {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 48px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 15px rgba(120,200,255,0.9);
      z-index: 3;
      pointer-events: none;
    }

    /* MENU / GAME OVER */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,20,0.55);
      backdrop-filter: blur(5px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .hidden { display: none; }

    /* TITLE SCREEN */
    #title {
      font-size: 90px;
      font-weight: 900;
      display: flex;
      gap: 4px;
      margin-bottom: 35px;
    }
    .tletter {
      animation: bounce 1.4s infinite ease-in-out;
      transform-origin: bottom;
      text-shadow: 0 0 20px rgba(255,255,255,0.7);
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-14px); }
    }

    .menu-option {
      margin: 12px;
      padding: 12px 30px;
      font-size: 30px;
      border-radius: 12px;
      color: white;
      background: rgba(255,255,255,0.12);
      cursor: pointer;
      transition: 0.2s;
    }
    .menu-option.selected {
      background: rgba(255,255,255,0.35);
      transform: scale(1.08);
    }

    .hint-text {
      margin-top: 25px;
      font-size: 24px;
      opacity: 0.8;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 0.55; }
      50% { opacity: 1; }
    }
  </style>
</head>

<body>
<div id="game-wrapper">

  <canvas id="trippy"></canvas>

  <canvas id="three-canvas"></canvas>
  <div id="crt-overlay"></div>
  <div id="vignette"></div>

  <div id="score">0 : 0</div>

  <!-- MENU -->
  <div id="menu-overlay" class="overlay">
      <div id="title"></div>

      <div class="menu-option selected" data-mode="0">Player vs CPU</div>
      <div class="menu-option" data-mode="1">Player1 vs Player2</div>

      <div class="hint-text">Press ENTER to play</div>
  </div>

  <!-- GAME OVER -->
  <div id="gameover-overlay" class="overlay hidden">
      <div id="gameover-title" style="font-size:70px;font-weight:900;color:white;">
        GAME OVER
      </div>

      <div id="gameover-sub" style="font-size:34px;margin-top:15px;color:#ff66dd;">
        TRY HARDER!
      </div>

      <div style="margin-top:35px;font-size:24px;opacity:0.9;">
        Press ENTER for menu
      </div>
  </div>

</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>

/* =========================================================
   SOUNDS (neu)
   ========================================================= */
const sndBounce = new Audio("../sounds/power1.wav");
sndBounce.volume = 0.4;

/* =========================================================
   TITLE SCREEN
   ========================================================= */

const title = document.getElementById("title");
const colors = ["#4285F4","#EA4335","#FBBC05","#34A853","#A142F4"];

"CobiePong".split("").forEach((ch,i)=>{
  const span = document.createElement("span");
  span.textContent = ch;
  span.className = "tletter";
  span.style.color = colors[i % colors.length];
  span.style.animationDelay = (i*0.08)+"s";
  title.appendChild(span);
});

  /* =========================================================
   SECRET2 BACKGROUND (Trippy Spirals)
   ========================================================= */

const bg = document.getElementById("trippy");
const ctx = bg.getContext("2d");

function resizeBG(){
  bg.width = window.innerWidth;
  bg.height = window.innerHeight;
}
resizeBG();
window.addEventListener("resize", resizeBG);

let t = 0;
let shock = 0;

function triggerBgShock(p=40){
  shock = Math.min(shock + p, 150);
}

function drawBG(){
  ctx.fillStyle = "rgba(0,0,0,0.08)";
  ctx.fillRect(0,0,bg.width,bg.height);

  const cx = bg.width/2, cy = bg.height/2;

  for(let i=0;i<60;i++){
    const ang = t*0.002 + i*0.14;
    const rad = (i*15) + Math.sin(t*0.008+i)*10 + shock;

    const x = cx + Math.cos(ang)*rad;
    const y = cy + Math.sin(ang*1.7)*rad*0.6;

    const r = 8 + Math.sin(t*0.018+i)*4 + shock*0.05;
    const hue = (t*0.4 + i*12 + shock*0.4) % 360;

    ctx.beginPath();
    ctx.fillStyle = `hsla(${hue},85%,60%,0.8)`;
    ctx.shadowColor = `hsla(${(hue+50)%360},90%,70%,0.9)`;
    ctx.shadowBlur = 34;
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  shock *= 0.92;
  t++;
  requestAnimationFrame(drawBG);
}
drawBG();

/* =========================================================
   THREE.JS INITIALIZATION
   ========================================================= */

const menuOverlay = document.getElementById("menu-overlay");
const gameoverOverlay = document.getElementById("gameover-overlay");

let gameState = "menu";
let menuIndex = 0;
let gameMode = 0;
let score = {p1:0,p2:0};
let WIN_SCORE = 5;

const canvas3D = document.getElementById("three-canvas");
const renderer = new THREE.WebGLRenderer({
  canvas: canvas3D,
  antialias: true,
  alpha: true
});
renderer.setSize(window.innerWidth, window.innerHeight);

/* ðŸ”¥ Spielfeld sichtbar machen (Fix) */
renderer.setClearColor(0x02040a, 0.75);  // leichtes Navy-Blau statt komplett transparent

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  50, window.innerWidth/window.innerHeight, 0.1, 200
);
camera.position.set(0,8,16);
camera.lookAt(0,0,0);

scene.add(new THREE.AmbientLight(0xffffff,0.4));

/* =========================================================
   SPIELFELD (NEUE SICHTBARE VERSION)
   ========================================================= */

const FIELD_W = 16;
const FIELD_H = 9;

const field = new THREE.Mesh(
  new THREE.PlaneGeometry(FIELD_W, FIELD_H),
  new THREE.MeshStandardMaterial({
    color: 0x0a0f22,           // sichtbar
    metalness: 0.4,
    roughness: 0.6,
    emissive: 0x081833,
    emissiveIntensity: 0.45,
    transparent: false,
    opacity: 1.0
  })
);
field.rotation.x = -Math.PI/2;
scene.add(field);

/* =========================================================
   PADDLES
   ========================================================= */

const paddleH = 2, paddleW = 0.4, paddleD = 0.4;

const paddleGeom = new THREE.BoxGeometry(paddleW,paddleD,paddleH);

const p1 = new THREE.Mesh(
  paddleGeom,
  new THREE.MeshStandardMaterial({color:0x55ccff, emissive:0x115577})
);
const p2 = new THREE.Mesh(
  paddleGeom,
  new THREE.MeshStandardMaterial({color:0xff55aa, emissive:0x551133})
);

p1.position.set(-FIELD_W/2+1, paddleD/2, 0);
p2.position.set( FIELD_W/2-1, paddleD/2, 0);

scene.add(p1,p2);

/* =========================================================
   BALL
   ========================================================= */

const ballR = 0.25;
const BALL_BASE_SPEED = 0.15;
let hitCount = 0;

let ball = {
  mesh: new THREE.Mesh(
    new THREE.SphereGeometry(ballR,32,32),
    new THREE.MeshStandardMaterial({color:0xffffff, emissive:0x55aaff, emissiveIntensity:2})
  ),
  x:0, z:0, vx:0.15, vz:0
};

ball.mesh.position.y = ballR+0.1;
scene.add(ball.mesh);

function resetBall(dir=1){
  ball.x = 0;
  ball.z = 0;

  hitCount = 0;   // SPEED RESET FIX

  const angle = (Math.random()*Math.PI/2) - Math.PI/4;
  const dx = dir>=0 ? 1 : -1;

  ball.vx = Math.cos(angle) * BALL_BASE_SPEED * dx;
  ball.vz = Math.sin(angle) * BALL_BASE_SPEED;
}

/* =========================================================
   CONTROLS
   ========================================================= */

let keys={};
document.addEventListener("keydown",e=>{
  keys[e.key]=true;

  if(gameState==="menu"){
    if(e.key==="ArrowUp"||e.key==="ArrowDown"){
      menuIndex = menuIndex===0 ? 1 : 0;
      updateMenu();
    }
    if(e.key==="Enter"){
      startGame();
    }
  }

  if(gameState==="gameover" && e.key==="Enter"){
    menuOverlay.classList.remove("hidden");
    gameoverOverlay.classList.add("hidden");
    gameState="menu";
  }
});

document.addEventListener("keyup",e=>{ keys[e.key]=false; });

function updateMenu(){
  const opts = [...document.querySelectorAll(".menu-option")];
  opts.forEach((el,i)=> el.classList.toggle("selected", i===menuIndex));
}

function startGame(){
  gameMode = menuIndex;
  score.p1 = 0;
  score.p2 = 0;
  document.getElementById("score").textContent = "0 : 0";

  resetBall(1);

  menuOverlay.classList.add("hidden");
  gameoverOverlay.classList.add("hidden");

  gameState = "playing";
}

  /* ------------------ GAME UPDATE ---------------------------- */

let p1z = 0, p2z = 0;
let camShake = 0;

function updateGame(dt){

  /* PLAYER 1 */
  const speed = 0.22;
  if (keys["w"]) p1z -= speed;
  if (keys["s"]) p1z += speed;

  const lim = FIELD_H/2 - paddleH/2;
  p1z = Math.max(-lim, Math.min(lim, p1z));

  /* PLAYER 2 / CPU */
  if (gameMode === 1) {
    if (keys["ArrowUp"])   p2z -= speed;
    if (keys["ArrowDown"]) p2z += speed;
  } else {
    const cs = 0.18;
    if (ball.z < p2z - 0.2) p2z -= cs;
    if (ball.z > p2z + 0.2) p2z += cs;
  }
  p2z = Math.max(-lim, Math.min(lim, p2z));

  /* MOVE BALL (mit Hit-Speed-Multiplikator) */
  const mult = hitCount <= 5 ? 1 + hitCount * 0.2 : (hitCount < 10 ? 2 : 3);
  ball.x += ball.vx * mult;
  ball.z += ball.vz * mult;

  /* WALL COLLISION (oben/unten) */
  const topZ    = -FIELD_H/2 + ballR;
  const bottomZ =  FIELD_H/2 - ballR;

  if (ball.z < topZ) {
    ball.z  = topZ;
    ball.vz *= -1;
    sndBounce.currentTime = 0;
    sndBounce.play();
    triggerBgShock(30);
    camShake = 0.25;
  }

  if (ball.z > bottomZ) {
    ball.z  = bottomZ;
    ball.vz *= -1;
    sndBounce.currentTime = 0;
    sndBounce.play();
    triggerBgShock(30);
    camShake = 0.25;
  }

  /* PADDLES COLLISION */
  const p1x = -FIELD_W/2 + 1;
  const p2x =  FIELD_W/2 - 1;
  const pw  = paddleW/2 + ballR;

  if (ball.vx < 0 && Math.abs(ball.x - p1x) < pw && Math.abs(ball.z - p1z) < paddleH/2) {
    paddleBounce(true);
  }
  if (ball.vx > 0 && Math.abs(ball.x - p2x) < pw && Math.abs(ball.z - p2z) < paddleH/2) {
    paddleBounce(false);
  }

  /* SCORE CHECK (Ball aus dem Feld links/rechts) */
  if (ball.x < -FIELD_W/2 - 1) {
    score.p2++;
    updateScore();
    checkRound(-1);
  }
  if (ball.x >  FIELD_W/2 + 1) {
    score.p1++;
    updateScore();
    checkRound(1);
  }

  /* PADDLE-POSITIONEN UPDATEN */
  p1.position.z = p1z;
  p2.position.z = p2z;

  /* BALL-POSITION UPDATEN */
  ball.mesh.position.set(ball.x, ballR + 0.1, ball.z);

  /* CAMERA SHAKE */
  if (camShake > 0) {
    camera.position.x = (Math.random() - 0.5) * camShake;
    camera.position.y = 8 + (Math.random() - 0.5) * camShake;
    camShake -= dt * 2;
  } else {
    camera.position.x = 0;
    camera.position.y = 8;
  }

  camera.lookAt(0,0,0);
}

/* ------------------ PADDLE BOUNCE (inkl. SOUND) ---------------------------- */

function paddleBounce(left){
  const pz  = left ? p1z : p2z;
  const rel = (ball.z - pz) / (paddleH/2);
  const ang = Math.max(-1, Math.min(1, rel)) * Math.PI/3;
  const dir = left ? 1 : -1;

  ball.vx = Math.cos(ang) * BALL_BASE_SPEED * dir;
  ball.vz = Math.sin(ang) * BALL_BASE_SPEED;

  hitCount++;   // Speed steigt wÃ¤hrend der Rally

  sndBounce.currentTime = 0;
  sndBounce.play();

  camShake = 0.35;
  triggerBgShock(70);
}

/* ------------------ SCORE & RUNDEN ---------------------------- */

function updateScore(){
  document.getElementById("score").textContent =
    `${score.p1} : ${score.p2}`;
}

function checkRound(lastDir){
  if (score.p1 >= WIN_SCORE) {
    showGameOver(true);
  } else if (score.p2 >= WIN_SCORE) {
    showGameOver(false);
  } else {
    hitCount = 0;          // Reset nach Punkt
    resetBall(-lastDir);   // NÃ¤chste Runde startet moderat
  }
}

/* ------------------ GAME OVER SCREEN ---------------------------- */

function showGameOver(p1Won){
  gameState = "gameover";

  const title = document.getElementById("gameover-title");
  const sub   = document.getElementById("gameover-sub");

  if (p1Won) {
    title.textContent = "Player 1 Won!";
    sub.textContent   = "Nice reflexes!";
    sub.style.color   = "#66ccff";
  } else {
    if (gameMode === 0) {
      // CPU hat gewonnen
      title.textContent = "You lost against the CPU!";
      sub.textContent   = "TRY HARDER!";
      sub.style.color   = "#ff66dd"; // Neon Pink
    } else {
      // Player 2 hat gewonnen (bei PvP)
      title.textContent = "Player 2 Won!";
      sub.textContent   = "Good match!";
      sub.style.color   = "#66ff99";
    }
  }

  gameoverOverlay.classList.remove("hidden");
}

/* ------------------ MAIN LOOP ---------------------------- */

const clock = new THREE.Clock();

function loop(){
  requestAnimationFrame(loop);
  const dt = clock.getDelta();

  if (gameState === "playing") {
    updateGame(dt);
  }

  renderer.render(scene, camera);
}
loop();

/* ------------------ RESIZE HANDLER ---------------------------- */

window.addEventListener("resize", ()=>{
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  resizeBG();
});

</script>
</body>
</html>

