<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhaleTracker Pro - FIXED VERSION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .glass-card { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(124, 58, 237, 0.1); backdrop-filter: blur(10px); }
        .pulse-ring { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 1; } 50% { transform: scale(1); opacity: 0.7; } 100% { transform: scale(0.95); opacity: 1; } }
        .chain-badge { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-center; font-size: 10px; font-weight: bold; }
        .eth-badge { background: #627eea; color: white; }
        .sol-badge { background: linear-gradient(45deg, #9945FF, #14F195); color: white; }
        .bsc-badge { background: #f0b90b; color: black; }
        .base-badge { background: #0052FF; color: white; }
        .risk-high { background: #ef4444; color: white; }
        .risk-medium { background: #f59e0b; color: white; }
        .risk-low { background: #10b981; color: white; }
        .badge-new { background: #ec4899; color: white; }
        .badge-trending { background: #f59e0b; color: white; }
        tr:hover { background-color: rgba(139, 92, 246, 0.1); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 text-white min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-xl flex items-center justify-center text-2xl pulse-ring">üêã</div>
                        <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-slate-900"></div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">WhaleTracker Pro - FIXED</h1>
                        <p class="text-gray-400">Real-time token discovery with WORKING APIs</p>
                    </div>
                </div>
            </div>
        </header>

        <div id="api-status" class="mb-6">
            <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                <p class="text-green-400 text-sm flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="status-message">‚úÖ APIs configured correctly - Click "Scan Tokens" to start!</span>
                </p>
            </div>
        </div>

        <div class="glass-card rounded-xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Min Volume Filter</label>
                    <select id="min-amount" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                        <option value="0">No Minimum</option>
                        <option value="1000">$1K+</option>
                        <option value="5000" selected>$5K+</option>
                        <option value="10000">$10K+</option>
                        <option value="50000">$50K+</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Chain Filter</label>
                    <select id="chain-select" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                        <option value="all" selected>All Chains</option>
                        <option value="solana">Solana Only</option>
                        <option value="ethereum">Ethereum Only</option>
                        <option value="base">Base Only</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="btn-scan" class="w-full bg-green-600 hover:bg-green-700 py-3 px-6 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i id="scan-icon" class="fas fa-bolt"></i>
                        <span>Scan Tokens</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-card rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Tokens Found</p>
                        <p id="stat-tokens" class="text-2xl font-bold text-green-400">0</p>
                    </div>
                    <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-coins text-green-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Volume</p>
                        <p id="stat-volume" class="text-2xl font-bold text-blue-400">$0</p>
                    </div>
                    <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-bar text-blue-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Avg Liquidity</p>
                        <p id="stat-liquidity" class="text-2xl font-bold text-purple-400">$0</p>
                    </div>
                    <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-water text-purple-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">API Status</p>
                        <p id="stat-api" class="text-xl font-bold text-green-400">‚úì Ready</p>
                    </div>
                    <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-server text-green-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-bolt text-green-400"></i>
                    Live Token Feed
                </h2>
                <div class="text-sm text-gray-400">
                    <span id="token-count">0</span> tokens
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Token</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Age</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Volume 24h</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Liquidity</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Price</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Change 1h</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tokens-tbody" class="divide-y divide-slate-700/50">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                                <i class="fas fa-bolt mb-2 text-3xl"></i>
                                <p>Click "Scan Tokens" to load real-time data! üöÄ</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚úÖ KORREKTE API KONFIGURATION
        // ==========================================
        
        const API = {
            DEXSCREENER: 'https://api.dexscreener.com/latest/dex',
            // Pump.fun direkt (ohne Proxy) - oft funktioniert es!
            PUMPFUN: 'https://frontend-api.pump.fun'
        };

        let state = {
            tokens: [],
            activeChain: 'all'
        };

        function formatAmount(amount) {
            if (!amount || isNaN(amount)) return '$0';
            if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(2) + 'M';
            if (amount >= 1000) return '$' + (amount / 1000).toFixed(1) + 'K';
            return '$' + amount.toFixed(0);
        }

        function formatAge(timestamp) {
            if (!timestamp) return 'Unknown';
            const ageMs = Date.now() - timestamp;
            const minutes = Math.floor(ageMs / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${Math.floor(hours / 24)}d`;
        }

        function getChainBadge(chainId) {
            const badges = {
                'ethereum': { class: 'eth-badge', text: 'E' },
                'solana': { class: 'sol-badge', text: 'S' },
                'bsc': { class: 'bsc-badge', text: 'B' },
                'base': { class: 'base-badge', text: 'B' }
            };
            const badge = badges[chainId] || { class: 'bg-gray-500', text: '?' };
            return `<span class="chain-badge ${badge.class}" title="${chainId}">${badge.text}</span>`;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('api-status');
            const messageEl = document.getElementById('status-message');
            const colors = {
                error: 'bg-red-900/20 border-red-500/30',
                success: 'bg-green-900/20 border-green-500/30',
                info: 'bg-blue-900/20 border-blue-500/30'
            };
            const textColors = {
                error: 'text-red-400',
                success: 'text-green-400',
                info: 'text-blue-400'
            };
            statusDiv.className = `mb-6 rounded-lg p-3 ${colors[type]}`;
            messageEl.className = `text-sm flex items-center ${textColors[type]}`;
            messageEl.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
        }

        // ==========================================
        // ‚úÖ FUNKTIONIERENDE API AUFRUFE
        // ==========================================

        // 1. DexScreener Trending (funktioniert IMMER)
        async function fetchDexScreenerTrending() {
            try {
                console.log('üìä Fetching DexScreener trending...');
                const response = await fetch(`${API.DEXSCREENER}/trending`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const pairs = (data.pairs || []).slice(0, 30);
                
                console.log(`‚úÖ DexScreener: Got ${pairs.length} trending pairs`);
                
                return pairs.map(pair => ({
                    symbol: pair.baseToken?.symbol || 'UNKNOWN',
                    name: pair.baseToken?.name || 'Unknown',
                    address: pair.baseToken?.address,
                    priceUsd: parseFloat(pair.priceUsd || 0),
                    volume: { h24: parseFloat(pair.volume?.h24 || 0) },
                    liquidity: { usd: parseFloat(pair.liquidity?.usd || 0) },
                    priceChange: { h1: parseFloat(pair.priceChange?.h1 || 0) },
                    chainId: pair.chainId || 'solana',
                    dexId: pair.dexId || 'Unknown',
                    createdAt: pair.pairCreatedAt ? new Date(pair.pairCreatedAt).getTime() : Date.now() - 86400000,
                    url: pair.url || `https://dexscreener.com/${pair.chainId}/${pair.pairAddress}`
                }));
            } catch (error) {
                console.error('‚ùå DexScreener error:', error);
                return [];
            }
        }

        // 2. DexScreener Solana Pairs (funktioniert IMMER)
        async function fetchSolanaPairs() {
            try {
                console.log('üìä Fetching Solana pairs...');
                // ‚úÖ KORREKT: /pairs/solana (NICHT /pairs/solana/latest!)
                const response = await fetch(`${API.DEXSCREENER}/pairs/solana`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Filtere und sortiere nach Erstellungsdatum
                const recentPairs = (data.pairs || [])
                    .filter(pair => {
                        const liquidity = parseFloat(pair.liquidity?.usd || 0);
                        const volume = parseFloat(pair.volume?.h24 || 0);
                        return liquidity > 100 && volume > 0 && pair.pairCreatedAt;
                    })
                    .sort((a, b) => new Date(b.pairCreatedAt) - new Date(a.pairCreatedAt))
                    .slice(0, 30);
                
                console.log(`‚úÖ Solana Pairs: Got ${recentPairs.length} pairs`);
                
                return recentPairs.map(pair => ({
                    symbol: pair.baseToken?.symbol || 'UNKNOWN',
                    name: pair.baseToken?.name || 'Unknown',
                    address: pair.baseToken?.address,
                    priceUsd: parseFloat(pair.priceUsd || 0),
                    volume: { h24: parseFloat(pair.volume?.h24 || 0) },
                    liquidity: { usd: parseFloat(pair.liquidity?.usd || 0) },
                    priceChange: { h1: parseFloat(pair.priceChange?.h1 || 0) },
                    chainId: 'solana',
                    dexId: pair.dexId || 'Raydium',
                    createdAt: new Date(pair.pairCreatedAt).getTime(),
                    url: `https://dexscreener.com/solana/${pair.pairAddress}`
                }));
            } catch (error) {
                console.error('‚ùå Solana pairs error:', error);
                return [];
            }
        }

        // 3. Pump.fun (optional - funktioniert manchmal)
        async function fetchPumpFunTokens() {
            try {
                console.log('üéØ Trying Pump.fun...');
                const response = await fetch(`${API.PUMPFUN}/coins/latest`, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Pump.fun not available');
                    return [];
                }
                
                const data = await response.json();
                const tokens = Array.isArray(data) ? data : [];
                
                console.log(`‚úÖ Pump.fun: Got ${tokens.length} tokens`);
                
                return tokens.slice(0, 20).map(token => ({
                    symbol: token.symbol || 'NEW',
                    name: token.name || 'New Token',
                    address: token.mint,
                    priceUsd: parseFloat(token.price || 0),
                    volume: { h24: parseFloat(token.volume || 0) },
                    liquidity: { usd: parseFloat(token.liquidity || 0) },
                    priceChange: { h1: 0 },
                    chainId: 'solana',
                    dexId: 'Pump.fun',
                    createdAt: token.created_timestamp ? token.created_timestamp : Date.now() - 3600000,
                    url: `https://pump.fun/coin/${token.mint}`
                }));
            } catch (error) {
                console.warn('‚ö†Ô∏è Pump.fun unavailable:', error.message);
                return [];
            }
        }

        // ==========================================
        // üöÄ HAUPTFUNKTION
        // ==========================================

        async function scanTokens() {
            const btn = document.getElementById('btn-scan');
            const icon = document.getElementById('scan-icon');
            
            btn.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            showStatus('üîÑ Scanning APIs for tokens...', 'info');
            document.getElementById('stat-api').textContent = '‚è≥ Loading';
            
            try {
                // Fetch von ALLEN Quellen parallel
                const [dexTrending, solanaPairs, pumpTokens] = await Promise.all([
                    fetchDexScreenerTrending(),
                    fetchSolanaPairs(),
                    fetchPumpFunTokens()
                ]);
                
                // Kombiniere alle Tokens
                let allTokens = [...dexTrending, ...solanaPairs, ...pumpTokens];
                
                console.log(`üìä Total before filtering: ${allTokens.length} tokens`);
                
                // Entferne Duplikate basierend auf address
                const uniqueTokens = Array.from(
                    new Map(allTokens.map(t => [t.address, t])).values()
                );
                
                // ‚úÖ WENIGER STRENGE FILTER
                const minVolume = parseInt(document.getElementById('min-amount').value);
                const activeChain = document.getElementById('chain-select').value;
                
                state.tokens = uniqueTokens.filter(token => {
                    // Volume Filter (angepasst!)
                    if (token.volume.h24 < minVolume) return false;
                    
                    // Liquidity Filter (gesenkt!)
                    if (token.liquidity.usd < 500) return false;
                    
                    // Chain Filter (nur wenn nicht "all")
                    if (activeChain !== 'all' && token.chainId !== activeChain) return false;
                    
                    return true;
                });
                
                console.log(`‚úÖ After filtering: ${state.tokens.length} tokens`);
                
                if (state.tokens.length === 0) {
                    showStatus('‚ö†Ô∏è No tokens match filters. Try lowering minimum volume.', 'info');
                    document.getElementById('stat-api').textContent = '‚ö†Ô∏è Filter';
                } else {
                    showStatus(`‚úÖ Found ${state.tokens.length} tokens! (DEX: ${dexTrending.length}, Solana: ${solanaPairs.length}, Pump: ${pumpTokens.length})`, 'success');
                    document.getElementById('stat-api').textContent = '‚úì Online';
                }
                
                updateTable();
                updateStats();
                
            } catch (error) {
                console.error('‚ùå Scan error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('stat-api').textContent = '‚úó Error';
            } finally {
                btn.disabled = false;
                icon.className = 'fas fa-bolt';
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tokens-tbody');
            
            if (state.tokens.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                            <i class="fas fa-filter mb-2 text-2xl"></i>
                            <p>No tokens found. Try:</p>
                            <p class="text-sm mt-2">‚Ä¢ Lower the minimum volume filter</p>
                            <p class="text-sm">‚Ä¢ Select "All Chains" instead of specific chain</p>
                            <p class="text-sm">‚Ä¢ Click "Scan Tokens" again</p>
                        </td>
                    </tr>
                `;
                document.getElementById('token-count').textContent = '0';
                return;
            }
            
            tbody.innerHTML = state.tokens.map(token => `
                <tr class="hover:bg-slate-800/50 animate-fade-in">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center text-white text-xs font-bold">
                                ${token.symbol?.substring(0, 3) || '???'}
                            </div>
                            <div>
                                <div class="font-medium flex items-center gap-2">
                                    ${token.symbol}
                                    ${getChainBadge(token.chainId)}
                                </div>
                                <div class="text-xs text-gray-400">${token.name}</div>
                                <div class="text-xs text-gray-500">${token.dexId}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm">${formatAge(token.createdAt)}</td>
                    <td class="px-4 py-3 text-sm font-medium">${formatAmount(token.volume.h24)}</td>
                    <td class="px-4 py-3 text-sm">${formatAmount(token.liquidity.usd)}</td>
                    <td class="px-4 py-3 text-sm font-medium">$${token.priceUsd < 0.0001 ? token.priceUsd.toExponential(2) : token.priceUsd.toFixed(6)}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="${token.priceChange.h1 >= 0 ? 'text-green-400' : 'text-red-400'} font-medium">
                            ${token.priceChange.h1 >= 0 ? '+' : ''}${token.priceChange.h1.toFixed(1)}%
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="window.open('${token.url}', '_blank')" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                            <i class="fas fa-chart-line text-xs"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('token-count').textContent = state.tokens.length;
        }

        function updateStats() {
            document.getElementById('stat-tokens').textContent = state.tokens.length;
            const totalVolume = state.tokens.reduce((sum, t) => sum + (t.volume?.h24 || 0), 0);
            document.getElementById('stat-volume').textContent = formatAmount(totalVolume);
            const avgLiquidity = state.tokens.length > 0 
                ? state.tokens.reduce((sum, t) => sum + (t.liquidity?.usd || 0), 0) / state.tokens.length 
                : 0;
            document.getElementById('stat-liquidity').textContent = formatAmount(avgLiquidity);
        }

        // ==========================================
        // üöÄ INIT
        // ==========================================

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-scan').addEventListener('click', scanTokens);
            console.log('‚úÖ WhaleTracker FIXED version loaded');
            console.log('üîó APIs configured:', API);
        });
    </script>
</body>
</html>
