<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhaleTracker Pro - Real-time Crypto Whale Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .glass-card { 
            background: rgba(15, 23, 42, 0.7); 
            border: 1px solid rgba(124, 58, 237, 0.1); 
            backdrop-filter: blur(10px);
        }
        .tab-active { 
            border-bottom: 2px solid #8b5cf6;
            color: #8b5cf6;
        }
        tr:hover { 
            background-color: rgba(139, 92, 246, 0.1) !important; 
            transform: scale(1.01);
            transition: all 0.15s ease;
        }
        .tab-content {
            transition: opacity 0.3s ease;
        }
        .tab-content.hidden { 
            opacity: 0; 
            pointer-events: none;
            position: absolute;
        }
        .tab-content:not(.hidden) {
            opacity: 1;
            position: relative;
        }
        .pulse-ring {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }
        .chain-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        .eth-badge { background: #627eea; color: white; }
        .sol-badge { background: linear-gradient(45deg, #9945FF, #14F195); color: white; }
        .bsc-badge { background: #f0b90b; color: black; }
        .base-badge { background: #0052FF; color: white; }
        .risk-high { background: #ef4444; color: white; }
        .risk-medium { background: #f59e0b; color: white; }
        .risk-low { background: #10b981; color: white; }
        .badge-new { background: #ec4899; color: white; }
        .badge-trending { background: #f59e0b; color: white; }
        .badge-whale { background: #8b5cf6; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 text-white min-h-screen">
    <div id="app" class="p-4">
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-xl flex items-center justify-center text-white font-bold text-lg pulse-ring">
                            üêã
                        </div>
                        <div id="live-indicator" class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-slate-900"></div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                            WhaleTracker Pro
                        </h1>
                        <p class="text-gray-400 mt-1">Live whale tracking & new meme coin discovery</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-lg">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-300">Live</span>
                        <span id="update-timer" class="text-xs text-gray-500">30s</span>
                    </div>
                    <button id="btn-refresh" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto flex gap-6">
            <!-- Main Content -->
            <div class="flex-1">
                <!-- API Status -->
                <div id="api-status" class="mb-6">
                    <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                        <p class="text-green-400 text-sm flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span id="status-message">üöÄ Connected to live APIs - Auto-refresh every 30s</span>
                        </p>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="glass-card rounded-xl p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">
                                <i class="fas fa-link mr-2"></i>Data Source
                            </label>
                            <select id="source-select" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="hybrid">üî• Hybrid (Best)</option>
                                <option value="dex">DexScreener</option>
                                <option value="pump">Pump.fun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">
                                <i class="fas fa-filter mr-2"></i>Min Liquidity
                            </label>
                            <select id="min-liquidity" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="0">All</option>
                                <option value="5000">$5K+</option>
                                <option value="10000">$10K+</option>
                                <option value="50000" selected>$50K+</option>
                                <option value="100000">$100K+</option>
                            </select>
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="btn-start" class="flex-1 bg-green-600 hover:bg-green-700 py-2 px-4 rounded-lg font-medium transition flex items-center justify-center gap-2">
                                <i id="start-icon" class="fas fa-play"></i>
                                Start Live
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button id="btn-stop" class="w-full bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg font-medium transition flex items-center justify-center gap-2" disabled>
                                <i class="fas fa-stop"></i>
                                Stop
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="mt-6 pt-6 border-t border-slate-700/50">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Age</label>
                                <select id="filter-age" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="5m">Last 5m</option>
                                    <option value="15m">Last 15m</option>
                                    <option value="30m" selected>Last 30m</option>
                                    <option value="1h">Last 1h</option>
                                    <option value="24h">Last 24h</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Volume</label>
                                <select id="filter-volume" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="0">All</option>
                                    <option value="10000">$10k+</option>
                                    <option value="50000">$50k+</option>
                                    <option value="100000">$100k+</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Chain</label>
                                <select id="filter-chain" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="all">All Chains</option>
                                    <option value="solana">Solana</option>
                                    <option value="ethereum">Ethereum</option>
                                    <option value="base">Base</option>
                                    <option value="bsc">BSC</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Risk</label>
                                <select id="filter-risk" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="all">All</option>
                                    <option value="LOW">Low Only</option>
                                    <option value="MEDIUM">Medium</option>
                                    <option value="HIGH">High</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="btn-apply-filters" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 px-4 rounded-lg font-medium transition">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 animate-fade-in hover:transform hover:scale-105 transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Live Tokens</p>
                                <p id="stat-tokens" class="text-2xl font-bold text-green-400">0</p>
                            </div>
                            <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-green-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-4 animate-fade-in hover:transform hover:scale-105 transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Total Volume</p>
                                <p id="stat-volume" class="text-2xl font-bold text-blue-400">$0</p>
                            </div>
                            <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-bar text-blue-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-4 animate-fade-in hover:transform hover:scale-105 transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Avg Liquidity</p>
                                <p id="stat-liquidity" class="text-2xl font-bold text-purple-400">$0</p>
                            </div>
                            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-water text-purple-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-4 animate-fade-in hover:transform hover:scale-105 transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Last Update</p>
                                <p id="stat-update" class="text-2xl font-bold text-orange-400">--</p>
                            </div>
                            <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-orange-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Table -->
                <div class="glass-card rounded-xl border border-green-500/20 overflow-hidden">
                    <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-bolt text-green-400"></i>
                            Live Token Feed
                        </h2>
                        <div class="flex items-center gap-2">
                            <div class="text-sm text-gray-400">
                                <span id="token-count">0</span> tokens
                            </div>
                            <div id="pulse-indicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-800/50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Token</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Age</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Volume 24h</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Liquidity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Price</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Change 1h</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Risk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tokens-tbody" class="divide-y divide-slate-700/50">
                                <tr>
                                    <td colspan="8" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-play-circle mb-2 text-3xl"></i>
                                        <p>Click "Start Live" to begin tracking! üöÄ</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="w-80">
                <!-- Activity Feed -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-rss text-purple-400"></i>
                        Recent Activity
                    </h3>
                    <div id="activity-feed" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-sm text-gray-400 text-center py-4">
                            <i class="fas fa-hourglass-half mb-2"></i>
                            <p>Waiting for data...</p>
                        </div>
                    </div>
                </div>

                <!-- API Info -->
                <div class="glass-card rounded-xl p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-400"></i>
                        Data Sources
                    </h3>
                    <div class="space-y-2 text-xs text-gray-400">
                        <div class="flex items-center justify-between">
                            <span>DexScreener</span>
                            <span id="dex-status" class="text-green-400">‚úì Active</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Pump.fun</span>
                            <span id="pump-status" class="text-yellow-400">‚ö† Setup</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Auto-Refresh</span>
                            <span class="text-purple-400">30s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // üöÄ CONFIGURATION
        // ==========================================
        
        // API Endpoints
        const API_CONFIG = {
            // DexScreener - Public API (IMMER FUNKTIONSF√ÑHIG)
            DEXSCREENER: {
                BASE: 'https://api.dexscreener.com/latest/dex',
                TRENDING: '/trending',
                PAIRS_SOLANA: '/pairs/solana',
                PAIRS_ETH: '/pairs/ethereum',
                PAIRS_BASE: '/pairs/base',
                PAIRS_BSC: '/pairs/bsc'
            },
            
            // Pump.fun - Via Vercel Proxy (wenn deployed)
            PUMP: {
                BASE: 'https://api-pump-proxy-js.vercel.app/api',
                TOKENS: '/tokens?limit=50',
                DEX: '/dex-proxy?type=new&limit=50'
            }
        };

        // State Management
        let state = {
            isLive: false,
            tokens: [],
            filters: {
                age: '30m',
                volume: 0,
                liquidity: 50000,
                chain: 'all',
                risk: 'all'
            },
            source: 'hybrid',
            refreshInterval: null,
            updateTimer: 30
        };

        // ==========================================
        // üõ†Ô∏è UTILITY FUNCTIONS
        // ==========================================

        function formatAmount(amount) {
            if (!amount || isNaN(amount)) return '$0';
            if (amount >= 1000000000) return '$' + (amount / 1000000000).toFixed(2) + 'B';
            if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(2) + 'M';
            if (amount >= 1000) return '$' + (amount / 1000).toFixed(1) + 'K';
            return '$' + amount.toFixed(0);
        }

        function formatAge(timestamp) {
            if (!timestamp) return 'Unknown';
            const ageMs = Date.now() - timestamp;
            const minutes = Math.floor(ageMs / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            return `${Math.floor(hours / 24)}d`;
        }

        function calculateAgeMinutes(timestamp) {
            if (!timestamp) return 0;
            const ageMs = Date.now() - timestamp;
            return Math.floor(ageMs / (1000 * 60));
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('api-status');
            const messageEl = document.getElementById('status-message');
            
            const colors = {
                error: 'bg-red-900/20 border-red-500/30 text-red-400',
                success: 'bg-green-900/20 border-green-500/30 text-green-400',
                info: 'bg-yellow-900/20 border-yellow-500/30 text-yellow-400'
            };
            
            const icons = {
                error: 'exclamation-triangle',
                success: 'check-circle',
                info: 'info-circle'
            };
            
            statusDiv.className = `mb-6 rounded-lg p-3 ${colors[type] || colors.info}`;
            messageEl.className = `text-sm flex items-center ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-yellow-400'}`;
            messageEl.innerHTML = `<i class="fas fa-${icons[type] || icons.info} mr-2"></i>${message}`;
        }

        function getChainBadge(chainId) {
            const badges = {
                'ethereum': { class: 'eth-badge', text: 'E' },
                'solana': { class: 'sol-badge', text: 'S' },
                'bsc': { class: 'bsc-badge', text: 'B' },
                'base': { class: 'base-badge', text: 'B' }
            };
            const badge = badges[chainId] || { class: 'bg-gray-500', text: '?' };
            return `<span class="chain-badge ${badge.class}" title="${chainId}">${badge.text}</span>`;
        }

        function calculateRiskScore(token) {
            let score = 0;
            let reasons = [];
            
            const ageMinutes = token.ageMinutes || 60;
            const liquidity = token.liquidity?.usd || 0;
            const priceChange1h = token.priceChange?.h1 || 0;
            
            // Age scoring
            if (ageMinutes < 10) {
                score += 30;
                reasons.push('Very new');
            } else if (ageMinutes < 30) {
                score += 20;
                reasons.push('New');
            } else if (ageMinutes < 60) {
                score += 10;
                reasons.push('Recent');
            }
            
            // Liquidity scoring
            if (liquidity < 5000) {
                score += 25;
                reasons.push('Low liquidity');
            } else if (liquidity < 20000) {
                score += 15;
                reasons.push('Medium liquidity');
            }
            
            // Volatility scoring
            if (Math.abs(priceChange1h) > 50) {
                score += 15;
                reasons.push('Extreme volatility');
            } else if (Math.abs(priceChange1h) > 20) {
                score += 10;
                reasons.push('High volatility');
            }
            
            return {
                score: Math.min(100, score),
                level: score >= 70 ? 'HIGH' : score >= 40 ? 'MEDIUM' : 'LOW',
                reasons: reasons.slice(0, 3)
            };
        }

        // ==========================================
        // üì° API FETCH FUNCTIONS
        // ==========================================

        async function fetchDexScreenerData() {
            try {
                console.log('üî∑ Fetching from DexScreener...');
                const response = await fetch(`${API_CONFIG.DEXSCREENER.BASE}/pairs/solana`);
                
                if (!response.ok) {
                    throw new Error(`DexScreener API error: ${response.status}`);
                }
                
                const data = await response.json();
                const pairs = (data.pairs || []).filter(pair => {
                    const liquidity = parseFloat(pair.liquidity?.usd || 0);
                    const volume = parseFloat(pair.volume?.h24 || 0);
                    return liquidity > 1000 && volume > 0;
                }).slice(0, 50);
                
                console.log(`‚úì DexScreener: ${pairs.length} pairs fetched`);
                
                return pairs.map(pair => ({
                    symbol: pair.baseToken?.symbol || 'UNKNOWN',
                    name: pair.baseToken?.name || 'Unknown',
                    address: pair.baseToken?.address,
                    mint: pair.baseToken?.address,
                    priceUsd: parseFloat(pair.priceUsd || 0),
                    volume: { 
                        h24: parseFloat(pair.volume?.h24 || 0),
                        h1: parseFloat(pair.volume?.h1 || 0)
                    },
                    liquidity: { 
                        usd: parseFloat(pair.liquidity?.usd || 0) 
                    },
                    priceChange: { 
                        h1: parseFloat(pair.priceChange?.h1 || 0),
                        h24: parseFloat(pair.priceChange?.h24 || 0)
                    },
                    chainId: pair.chainId || 'solana',
                    createdAt: pair.pairCreatedAt || Date.now(),
                    url: pair.url || `https://dexscreener.com/solana/${pair.pairAddress}`,
                    dex: pair.dexId || 'Unknown',
                    source: 'DexScreener'
                }));
            } catch (error) {
                console.error('‚ùå DexScreener error:', error);
                return [];
            }
        }

        async function fetchPumpFunData() {
            try {
                console.log('üî∑ Fetching from Pump.fun...');
                const response = await fetch(API_CONFIG.PUMP.TOKENS);
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Pump.fun API not available (use Vercel proxy)');
                    return [];
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log(`‚úì Pump.fun: ${data.data.length} tokens fetched`);
                    return data.data.slice(0, 30);
                }
                
                return [];
            } catch (error) {
                console.warn('‚ö†Ô∏è Pump.fun unavailable:', error.message);
                return [];
            }
        }

        async function fetchHybridData() {
            try {
                showStatus('üîÑ Fetching from multiple sources...', 'info');
                
                const [dexData, pumpData] = await Promise.all([
                    fetchDexScreenerData(),
                    fetchPumpFunData()
                ]);
                
                const allTokens = [...dexData, ...pumpData];
                console.log(`‚úÖ Total tokens: ${allTokens.length} (DEX: ${dexData.length}, Pump: ${pumpData.length})`);
                
                // Update status indicators
                document.getElementById('dex-status').innerHTML = dexData.length > 0 ? '‚úì Active' : '‚úó Offline';
                document.getElementById('dex-status').className = dexData.length > 0 ? 'text-green-400' : 'text-red-400';
                
                document.getElementById('pump-status').innerHTML = pumpData.length > 0 ? '‚úì Active' : '‚ö† Setup';
                document.getElementById('pump-status').className = pumpData.length > 0 ? 'text-green-400' : 'text-yellow-400';
                
                return allTokens;
            } catch (error) {
                console.error('‚ùå Hybrid fetch error:', error);
                showStatus('‚ùå Error fetching data', 'error');
                return [];
            }
        }

        // ==========================================
        // üéØ MAIN DATA PROCESSING
        // ==========================================

        async function fetchAndUpdateData() {
            try {
                let rawTokens = [];
                
                // Fetch based on selected source
                switch(state.source) {
                    case 'dex':
                        rawTokens = await fetchDexScreenerData();
                        break;
                    case 'pump':
                        rawTokens = await fetchPumpFunData();
                        break;
                    case 'hybrid':
                    default:
                        rawTokens = await fetchHybridData();
                        break;
                }
                
                if (rawTokens.length === 0) {
                    showStatus('‚ö†Ô∏è No data available. Try a different source.', 'error');
                    return;
                }
                
                // Process and enrich tokens
                const processedTokens = rawTokens.map(token => {
                    const ageMinutes = calculateAgeMinutes(token.createdAt);
                    const risk = calculateRiskScore({ ...token, ageMinutes });
                    
                    return {
                        ...token,
                        ageMinutes,
                        riskScore: risk.score,
                        riskLevel: risk.level,
                        riskReasons: risk.reasons
                    };
                });
                
                // Apply filters
                state.tokens = processedTokens.filter(token => {
                    // Age filter
                    const maxAge = {
                        '5m': 5,
                        '15m': 15,
                        '30m': 30,
                        '1h': 60,
                        '24h': 1440
                    }[state.filters.age] || 1440;
                    
                    if (token.ageMinutes > maxAge) return false;
                    
                    // Liquidity filter
                    if ((token.liquidity?.usd || 0) < state.filters.liquidity) return false;
                    
                    // Volume filter
                    if ((token.volume?.h24 || 0) < state.filters.volume) return false;
                    
                    // Chain filter
                    if (state.filters.chain !== 'all' && token.chainId !== state.filters.chain) return false;
                    
                    // Risk filter
                    if (state.filters.risk !== 'all' && token.riskLevel !== state.filters.risk) return false;
                    
                    return true;
                });
                
                // Sort by creation date (newest first)
                state.tokens.sort((a, b) => b.createdAt - a.createdAt);
                
                // Update UI
                updateTable();
                updateStats();
                updateActivityFeed();
                
                showStatus(`‚úÖ Updated: ${state.tokens.length} tokens found`, 'success');
                
            } catch (error) {
                console.error('‚ùå Update error:', error);
                showStatus('‚ùå Error updating data', 'error');
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tokens-tbody');
            
            if (state.tokens.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-400">
                            <i class="fas fa-filter mb-2 text-2xl"></i>
                            <p>No tokens match your filters. Try adjusting them.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = state.tokens.map(token => {
                const riskBadgeClass = token.riskLevel === 'HIGH' ? 'risk-high' : 
                                       token.riskLevel === 'MEDIUM' ? 'risk-medium' : 'risk-low';
                
                const badges = [];
                if (token.ageMinutes < 10) badges.push('<span class="badge-new text-xs px-2 py-1 rounded">NEW</span>');
                if (token.volume?.h24 > 100000) badges.push('<span class="badge-trending text-xs px-2 py-1 rounded">üî•</span>');
                if (token.liquidity?.usd > 100000) badges.push('<span class="badge-whale text-xs px-2 py-1 rounded">üêã</span>');
                
                return `
                    <tr class="hover:bg-slate-800/50 transition-all animate-fade-in">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center text-white text-xs font-bold">
                                    ${token.symbol?.substring(0, 3) || '???'}
                                </div>
                                <div>
                                    <div class="font-medium flex items-center gap-2">
                                        ${token.symbol}
                                        ${getChainBadge(token.chainId)}
                                    </div>
                                    <div class="text-xs text-gray-400">${token.name}</div>
                                </div>
                            </div>
                            <div class="flex gap-1 mt-2">
                                ${badges.join('')}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-medium">${formatAge(token.createdAt)}</div>
                            <div class="text-xs text-gray-400">${token.ageMinutes}m ago</div>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium">
                            ${formatAmount(token.volume.h24)}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            ${formatAmount(token.liquidity.usd)}
                        </td>
                        <td class="px-4 py-3 text-sm font-medium">
                            $${token.priceUsd < 0.0001 ? token.priceUsd.toExponential(2) : token.priceUsd.toFixed(6)}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="${token.priceChange.h1 >= 0 ? 'text-green-400' : 'text-red-400'} font-medium">
                                ${token.priceChange.h1 >= 0 ? '+' : ''}${token.priceChange.h1.toFixed(1)}%
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-col gap-1">
                                <span class="${riskBadgeClass} text-xs px-2 py-1 rounded text-center">${token.riskLevel}</span>
                                <div class="text-xs text-gray-400 text-center">${token.riskScore}/100</div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                                <button onclick="window.open('${token.url}', '_blank')" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition" title="View Chart">
                                    <i class="fas fa-chart-line text-xs"></i>
                                </button>
                                <button onclick="copyToClipboard('${token.mint || token.address}')" class="p-2 bg-green-600 hover:bg-green-700 rounded-lg transition" title="Copy Address">
                                    <i class="fas fa-copy text-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('token-count').textContent = state.tokens.length;
        }

        function updateStats() {
            document.getElementById('stat-tokens').textContent = state.tokens.length;
            
            const totalVolume = state.tokens.reduce((sum, t) => sum + (t.volume?.h24 || 0), 0);
            document.getElementById('stat-volume').textContent = formatAmount(totalVolume);
            
            const avgLiquidity = state.tokens.length > 0 
                ? state.tokens.reduce((sum, t) => sum + (t.liquidity?.usd || 0), 0) / state.tokens.length 
                : 0;
            document.getElementById('stat-liquidity').textContent = formatAmount(avgLiquidity);
            
            const now = new Date();
            document.getElementById('stat-update').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function updateActivityFeed() {
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = '';
            
            const recentTokens = state.tokens.slice(0, 8);
            
            if (recentTokens.length === 0) {
                feed.innerHTML = `
                    <div class="text-sm text-gray-400 text-center py-4">
                        <i class="fas fa-hourglass-half mb-2"></i>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }
            
            recentTokens.forEach(token => {
                const riskIcon = token.riskLevel === 'HIGH' ? 'üî¥' : token.riskLevel === 'MEDIUM' ? 'üü°' : 'üü¢';
                
                const item = document.createElement('div');
                item.className = 'text-sm p-2 rounded-lg bg-slate-800/30 animate-fade-in cursor-pointer hover:bg-slate-700/30 transition';
                item.innerHTML = `
                    <div class="flex items-start gap-2">
                        <span class="text-lg">üìà</span>
                        <div class="flex-1">
                            <div class="font-medium">${token.symbol}</div>
                            <div class="text-gray-400 text-xs">${formatAge(token.createdAt)} ‚Ä¢ ${formatAmount(token.liquidity.usd)} LQ</div>
                            <div class="flex gap-1 mt-1">
                                <span class="text-xs ${token.priceChange.h1 >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${token.priceChange.h1 >= 0 ? '+' : ''}${token.priceChange.h1.toFixed(1)}%
                                </span>
                                <span class="text-xs text-gray-400">‚Ä¢</span>
                                <span class="text-xs">${riskIcon}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if (token.url) window.open(token.url, '_blank');
                });
                
                feed.appendChild(item);
            });
        }

        // ==========================================
        // üéÆ CONTROLS
        // ==========================================

        function startLiveTracking() {
            if (state.isLive) return;
            
            state.isLive = true;
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            document.getElementById('live-indicator').classList.add('animate-pulse');
            document.getElementById('pulse-indicator').classList.add('animate-pulse');
            
            // Initial fetch
            fetchAndUpdateData();
            
            // Set up auto-refresh every 30 seconds
            state.refreshInterval = setInterval(() => {
                fetchAndUpdateData();
            }, 30000);
            
            // Timer countdown
            state.updateTimer = 30;
            setInterval(() => {
                state.updateTimer--;
                if (state.updateTimer <= 0) state.updateTimer = 30;
                document.getElementById('update-timer').textContent = `${state.updateTimer}s`;
            }, 1000);
            
            showStatus('üöÄ Live tracking started - Auto-refresh every 30s', 'success');
        }

        function stopLiveTracking() {
            if (!state.isLive) return;
            
            state.isLive = false;
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
            document.getElementById('live-indicator').classList.remove('animate-pulse');
            document.getElementById('pulse-indicator').classList.remove('animate-pulse');
            
            if (state.refreshInterval) {
                clearInterval(state.refreshInterval);
                state.refreshInterval = null;
            }
            
            showStatus('‚è∏Ô∏è Live tracking stopped', 'info');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('‚úì Address copied to clipboard!', 'success');
            });
        }

        // ==========================================
        // üöÄ INIT
        // ==========================================

        function init() {
            // Event listeners
            document.getElementById('btn-start').addEventListener('click', startLiveTracking);
            document.getElementById('btn-stop').addEventListener('click', stopLiveTracking);
            document.getElementById('btn-refresh').addEventListener('click', fetchAndUpdateData);
            document.getElementById('btn-apply-filters').addEventListener('click', () => {
                updateTable();
                updateStats();
                showStatus('‚úì Filters applied', 'success');
            });
            
            // Source selector
            document.getElementById('source-select').addEventListener('change', (e) => {
                state.source = e.target.value;
                if (state.isLive) {
                    fetchAndUpdateData();
                }
            });
            
            // Filter updates
            document.getElementById('filter-age').addEventListener('change', (e) => {
                state.filters.age = e.target.value;
            });
            document.getElementById('filter-volume').addEventListener('change', (e) => {
                state.filters.volume = parseInt(e.target.value);
            });
            document.getElementById('min-liquidity').addEventListener('change', (e) => {
                state.filters.liquidity = parseInt(e.target.value);
            });
            document.getElementById('filter-chain').addEventListener('change', (e) => {
                state.filters.chain = e.target.value;
            });
            document.getElementById('filter-risk').addEventListener('change', (e) => {
                state.filters.risk = e.target.value;
            });
            
            console.log('‚úÖ WhaleTracker Pro initialized');
            console.log('üì° Data sources:', API_CONFIG);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
