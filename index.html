<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/favicon.png">
  
  <!-- Barlow Font -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Chart.js f√ºr Portfolio Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
<title>Gobbles ‚Äî Cope Harder!</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ‚úÖ Echter Bonfida SNS Resolver (OHNE ES-Module) -->
<script>
  async function displayWalletLabel(address, el) {
    const short = `${address.slice(0,4)}‚Ä¶${address.slice(-4)}`;
    el.textContent = short;

    // Check LocalStorage cache
    const cached = localStorage.getItem("sns_"+address);
    if (cached) {
      el.textContent = `${short} (${cached}.sol)`;
    }
  }
  
  window.displayWalletLabel = displayWalletLabel;
</script>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --ink:#e9fbff; --muted:#9ed9e6; --accent:#00eaff;
    --good:#14F195; --bad:#ff6b6b; --purple:#9945FF; --blue:#00eaff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 800px at 70% -10%,rgba(0,234,255,.08),transparent 60%),
    linear-gradient(180deg,#05080c,#0a0f16 40%,#05080c);
    color:var(--ink);font-family:"Barlow", system-ui, -apple-system, Segoe UI, Roboto, Arial}
  a{color:var(--accent)}
  
  /* Barlow Font f√ºr Headlines */
  h1, h2, h3, .brand-wrap b {
    font-family:"Barlow", sans-serif;
    font-weight:800; /* ExtraBold like X headlines */
  }

  body {
    font-family:"Barlow", sans-serif;
    font-weight:400; /* regular for posts */
  }
  
  /* ‚≠ê Partikel/Sterne Hintergrund */
  #particles {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px 16px;position:relative;z-index:1}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:linear-gradient(180deg,rgba(10,15,22,.94),rgba(10,15,22,.6));border-bottom:1px solid rgba(255,255,255,.06)}
  .h-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand-wrap{display:flex;align-items:center;gap:10px}
  
  /* Logo Animation - komplett √ºberarbeitet */
  .logo-anim {
    width: 52px;
    height: 52px;
    border-radius: 10px;
    border: 3px solid #00eaff77;
    object-fit: cover;
    box-shadow: 0 0 12px rgba(0,234,255,0.35);
    animation: wobble 3s ease-in-out infinite, spinPulse 9s linear infinite;
  }

  /* Nur das 'G' hat spezielle Animation */
 .g-wobble {
  display: inline-block;
  transform-origin: center;
  animation: gWobble 3.2s ease-in-out infinite, gSpin 9s linear infinite;
  transform-origin: 55% 55%;
  background: linear-gradient(90deg,#00eaff,#9945FF,#14f195);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

  @keyframes gWobble {
    0%,100%{ transform: rotate(0deg) }
    20%{ transform: rotate(-6deg) }
    40%{ transform: rotate(4deg) }
  }
  
  @keyframes gSpin {
    0%{ filter: hue-rotate(0deg) }
    94%{ transform: rotate(0deg) }
    100%{ transform: rotate(360deg); filter: hue-rotate(50deg) }
  }

  @keyframes wobble {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-5deg) scale(1.10); }
    50% { transform: rotate(5deg) scale(1.10); }
    75% { transform: rotate(-3deg) scale(1.05); }
  }
  
  @keyframes spinPulse {
    0%, 90% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .brand-main {
    font-weight:800;
    font-size: 26px;
    background:linear-gradient(90deg,#00eaff,#9945FF,#14f195);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent
  }

  /* Wallet + Profile Bereich */
  .header-right-wrap {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-left: auto;
  }

  /* ============ GLOBAL NEON REFINES ============ */
  :root{
    --glass: rgba(15, 22, 34, .65);
    --glass-border: rgba(255,255,255,.10);
    --neo1:#00eaff; --neo2:#14F195; --neo3:#9945FF;
  }

  /* Cards etwas "floating" */
  .card{
    background: linear-gradient(180deg, rgba(17,24,39,.55), rgba(7,10,16,.65));
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(6px);
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
    border-radius: 16px;
  }

  /* Buttons ‚Äì behalte deine .btn Klasse, verfeinere Look */
  .btn{
    background: linear-gradient(135deg, rgba(0,234,255,.14), rgba(20,241,149,.14));
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 0 0 0 rgba(0,234,255,0);
    transition: box-shadow .25s ease, transform .15s ease, border-color .25s ease;
  }
  .btn:hover{
    border-color: rgba(0,234,255,.35);
    box-shadow: 0 8px 28px rgba(0,234,255,.25);
    transform: translateY(-1px);
  }

  /* Header-"Profile"-Pill */
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    height:32px; padding:0 14px;
    border-radius:999px; font-weight:700; text-decoration:none;
    color:var(--ink);
    background: linear-gradient(135deg, rgba(0,234,255,.10), rgba(153,69,255,.10));
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(6px);
    transition: all .25s ease;
  }
  .pill:hover{
    color:#e9fbff;
    box-shadow: 0 0 22px rgba(0,234,255,.25);
    border-color: rgba(0,234,255,.35);
    transform: translateY(-1px);
  }
  .profile-pill::before{
    content:"ü™™";
    filter:saturate(140%);
  }

  /* Wallet-Status-Pill etwas konsistenter (falls .status im Header) */
  .status{
    background: linear-gradient(135deg, rgba(0,234,255,.08), rgba(0,0,0,.08));
    border:1px solid rgba(255,255,255,.12);
    box-shadow: inset 0 0 12px rgba(0,234,255,.08);
  }

  .status{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  .connect-btn { margin-left: 10px; }
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(17,24,39,.6),rgba(7,10,16,.7));
    border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
  .card .body{padding:14px}
  .post {
    padding:12px;
    display:grid;
    grid-template-columns:48px 1fr;
    gap:12px;
    border-bottom:1px solid rgba(255,255,255,.04);
    opacity:0;
    animation:fadeUp .35s ease forwards;
    transition:0.25s ease;
  }
  .post:hover {
    background:radial-gradient(600px 160px at 15% 0%, rgba(0,234,255,.06), transparent 50%);
    transform: translateY(-1px);
    box-shadow: 0 8px 28px rgba(0,0,0,.25);
  }
  
  /* Boom-Post Animation */
  .post-boom {
    animation: dropBoom 0.55s cubic-bezier(.17,.67,.45,1.32) forwards;
    opacity: 0;
  }

  @keyframes dropBoom {
    0% {
      transform: translateY(-120px) scale(0.8) rotate(-3deg);
      opacity: 0;
      box-shadow: none;
    }
    80% {
      transform: translateY(8px) scale(1.03);
      opacity: 1;
    }
    100% {
      transform: translateY(0) scale(1);
      box-shadow: 0 0 18px rgba(0,255,150,.4);
    }
  }

  .avatar {
    width:48px;height:48px;border-radius:12px;
    background:conic-gradient(from 120deg,#9945FF,#14F195,#00FFA3);
    overflow:hidden;display:block;
    animation:pulseGlow 3s infinite ease-in-out;
    box-shadow:0 0 8px rgba(0,255,180,0.3);
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .muted{color:var(--muted);font-size:12px}
  textarea{background:#09101a;border:2px solid rgba(0,234,255,0.3);color:var(--ink);border-radius:12px;padding:14px;
    font:inherit;width:100%;height:120px;resize:vertical;box-shadow:0 0 15px rgba(0,234,255,0.1);transition:all 0.3s ease;}
  textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 20px rgba(0,234,255,0.3)}
  .small{font-size:12px;color:var(--muted)}
  
  /* Post Actions */
  .post-actions{display:flex;gap:18px;margin-top:6px;align-items:center}
  .icon-btn{cursor:pointer;font-size:14px;color:var(--muted);transition:all 0.2s ease;padding:4px 8px;border-radius:6px}
  .icon-btn:hover{color:var(--accent);background:rgba(0,234,255,0.1)}
  
  .tip-btn{background:linear-gradient(135deg,#062018,#0a2a22);border:1px solid #00ffa388;color:#00ffa3;
    margin-top:4px;padding:6px 12px;font-size:12px;border-radius:8px;cursor:pointer;box-shadow:0 0 10px rgba(0,255,163,0.2)}
  .tip-btn:hover{box-shadow:0 0 15px rgba(0,255,163,0.4)}
  
  .input-group{margin-bottom:12px}
  .input-label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
  .text-input{background:#09101a;border:2px solid rgba(255,255,255,.1);color:var(--ink);border-radius:10px;padding:10px 12px;
    width:100%;font:inherit;transition:all 0.3s ease;box-shadow:0 0 10px rgba(0,0,0,0.2)}
  .text-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 15px rgba(0,234,255,0.2)}

  .sol-icon{
    width:20px;
    height:20px;
    border-radius:6px;
  }
  
  .vote-btn{
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:4px;
    font-size:14px;
    color:#7b8ca4; /* muted gray */
    transition:0.2s;
    padding:4px 8px;
    border-radius:6px;
  }

  .vote-btn.active-up{
    color:#14F195; 
    text-shadow: 0 0 6px rgba(20,241,149,.7), 0 0 14px rgba(20,241,149,.5);
    font-weight:700;
  }

  .vote-btn.active-down{
    color:#9945FF;
    text-shadow: 0 0 6px rgba(153,69,255,.7), 0 0 14px rgba(153,69,255,.5);
    font-weight:700;
  }

  .vote-btn:hover{opacity:0.8;}

  /* Fade animation */
  @keyframes fadeUp {
    from { opacity:0;transform:translateY(6px);}
    to   { opacity:1;transform:translateY(0);}
  }

  /* Avatar breathing glow */
  @keyframes pulseGlow {
    0%   { box-shadow:0 0 6px rgba(0,255,180,0.25); }
    50%  { box-shadow:0 0 14px rgba(0,255,180,0.55); }
    100% { box-shadow:0 0 6px rgba(0,255,180,0.25); }
  }

  /* ‚úÖ Verified NFT Halo */
  .nft-halo {
    position: relative;
    border-radius: 12px;
    animation: nftGlow 2.5s ease-in-out infinite;
    box-shadow: 0 0 12px rgba(20,241,149,0.6), 0 0 24px rgba(0,234,255,0.4);
  }

  @keyframes nftGlow {
    0% { box-shadow: 0 0 8px rgba(0,234,255,0.35), 0 0 14px rgba(20,241,149,0.3); }
    50% { box-shadow: 0 0 18px rgba(0,234,255,0.7), 0 0 32px rgba(20,241,149,0.55); }
    100% { box-shadow: 0 0 8px rgba(0,234,255,0.35), 0 0 14px rgba(20,241,149,0.3); }
  }

  /* ‚úÖ Hashtag Styles */
  .hashtag {
    display:inline-block; padding:4px 10px; border-radius:10px;
    background: rgba(0,234,255,.10);
    border:1px solid rgba(0,234,255,.25);
    color:#9ed9e6; cursor:pointer; transition:.2s;
    font-weight:600;
  }
  .hashtag:hover {
    color:#e9fbff;
    box-shadow: 0 0 18px rgba(0,234,255,.25);
  }

  /* ‚úÖ Trending Styles */
  .trend-item {
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 12px; border-radius:10px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
    margin-bottom:8px; cursor:pointer;
    transition:.2s;
  }
  .trend-item:hover {
    background: rgba(0,234,255,.10);
    border-color: rgba(0,234,255,.25);
  }
  .trend-count {
    color:var(--muted);
    font-size:11px;
  }

  /* ‚úÖ Active Filter Badge */
  .active-filter {
    background:linear-gradient(135deg,var(--blue),var(--purple));
    color:white;
    padding:4px 8px;
    border-radius:6px;
    font-size:12px;
    margin-left:8px;
    animation:pulseGlow 2s infinite;
  }

  /* ===================== PROFILE MODAL STYLES ===================== */
  .profile-overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(8px);
    z-index:9999;
    display:flex; align-items:center; justify-content:center;
  }

  .profile-modal{
    width:75%; max-width:900px;
    background:rgba(15,22,34,.85);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    padding:20px;
    box-shadow:0 0 50px rgba(0,234,255,.25);
    backdrop-filter:blur(10px);
  }

  .profile-modal-header{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:10px;
  }

  .close-btn{
    background:transparent; border:none; color:#fff;
    font-size:22px; cursor:pointer;
  }

  #pfForm > div{
    display:flex; gap:6px; margin-bottom:6px;
  }
  #pfForm input{
    flex:1;
  }

  label {
    display: block;
    margin: 12px 0 6px 0;
    color: var(--muted);
    font-size: 14px;
    font-weight: 600;
  }
</style>
</head>
<body>
<!-- ‚≠ê Partikel/Sterne Canvas -->
<canvas id="particles"></canvas>

<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="logo-anim" alt="Gobbles">
      <div>
        <div class="brand-main"><span class="g-wobble">G</span>obbles</div>
        <div class="small">Cope Harder!</div>
      </div>
    </div>

    <div style="flex:1"></div>

    <span id="wallet-status" class="status">Not connected</span>
    <a id="profileLink" class="pill profile-pill" href="javascript:void(0)">Profile</a>
    <button id="connectBtn" class="btn connect-btn">Connect Wallet</button>
  </div>
</header>

<!-- Sound for posts -->
<audio id="postSound">
  <source src="../sounds/mgs2.mp3" type="audio/mpeg">
</audio>

<!-- Boom Sound for new posts -->
<audio id="boomSound">
  <source src="../sounds/boom.mp3" type="audio/mpeg">
</audio>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Create Post</h3>
          <textarea id="postText" maxlength="140" placeholder="What's happening? Use #hashtags for trends!"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">Fee: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Post</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Community Feed <span id="filterBadge" style="display:none"></span></h3>
        </div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="body">
          <h3>Trending</h3>
          <div id="trendBox">
            <div class="small" style="text-align:center;padding:20px;color:var(--muted)">
              No trends yet. Be the first to post with #hashtags!
            </div>
          </div>
          <button id="resetFeedBtn" class="btn" style="margin-top:10px;width:100%;">
            üîÑ Show All Posts
          </button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Sentiment & Trends</h3>
          <div class="input-group">
            <label class="input-label">Search Posts</label>
            <input type="text" class="text-input" placeholder="Enter keyword...">
          </div>
          <div class="input-group">
            <label class="input-label">Filter by User</label>
            <input type="text" class="text-input" placeholder="Wallet address...">
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- ===================== PROFILE MODAL ===================== -->
<div id="profileModal" class="profile-overlay" style="display:none">
  <div class="profile-modal">
    
    <div class="profile-modal-header">
      <h2>Edit Profile</h2>
      <button id="closeProfile" class="close-btn">‚úï</button>
    </div>

    <label>Bio (200 chars)</label>
    <textarea id="bioInput" maxlength="200" class="text-input" style="height:70px"></textarea>

    <label>Avatar / NFT URL</label>
    <input id="avatarInput" type="text" class="text-input" placeholder="https://..." />

    <label>Portfolio (symbol & percent)</label>
    <div id="pfForm"></div>
    <button id="addAsset" class="btn" style="margin-top:6px">+ Add Asset</button>

    <canvas id="pfChart" width="350" height="350" style="margin:10px auto; display:block"></canvas>

    <button id="saveProfile" class="btn" style="width:100%; margin-top:12px">Save Profile</button>

  </div>
</div>

<!-- ‚úÖ SCRIPT HIER - NACH DEM MODAL HTML -->
<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* ---------- LIB INIT ---------- */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- UI refs ---------- */
const statusEl = document.getElementById("wallet-status");
const connectBtn = document.getElementById("connectBtn");
const postBtn = document.getElementById("postBtn");
const feed = document.getElementById("feed");
const postText = document.getElementById("postText");
const postSound = document.getElementById("postSound");
const boomSound = document.getElementById("boomSound");
const trendBox = document.getElementById("trendBox");
const filterBadge = document.getElementById("filterBadge");
const resetFeedBtn = document.getElementById("resetFeedBtn");
const profileLink = document.getElementById("profileLink");

let wallet = null;
let currentFilter = null;

/* ---------- Hashtag Functions ---------- */
function extractHashtags(text) {
  return (text.match(/#\w+/g) || []).map(t => t.toLowerCase().replace('#', ''));
}

function renderTextWithTags(text){
  return text.replace(/#(\w+)/g, `<span class="hashtag" data-tag="$1">#$1</span>`);
}

/* ---------- Partikel/Sterne Animation ---------- */
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");
let particles = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Erstelle Partikel/Sterne
for (let i = 0; i < 80; i++) {
  particles.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    size: Math.random() * 1.5 + 0.5, // Kleinere, subtilere Gr√∂√üe
    speedX: (Math.random() - 0.5) * 0.3, // Langsamere Bewegung
    speedY: (Math.random() - 0.5) * 0.3,
    alpha: Math.random() * 0.6 + 0.2 // Subtile Transparenz
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => {
    p.x += p.speedX; 
    p.y += p.speedY;
    
    // Wrap around edges
    if (p.x < 0) p.x = canvas.width;
    if (p.x > canvas.width) p.x = 0;
    if (p.y < 0) p.y = canvas.height;
    if (p.y > canvas.height) p.y = 0;

    ctx.fillStyle = `rgba(0,234,255,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

/* ---------- Wallet helpers ---------- */
function getWallet(){ return window.phantom?.solana || window.solana; }
function uiConnected(pk){ 
  statusEl.textContent = "‚úÖ ";
  const span = document.createElement("span");
  statusEl.appendChild(span);
  
  // ‚úÖ Fallback falls displayWalletLabel nicht verf√ºgbar
  if (typeof displayWalletLabel === 'function') {
    displayWalletLabel(pk, span);
  } else {
    span.textContent = `${pk.slice(0,4)}‚Ä¶${pk.slice(-4)}`;
  }
  connectBtn.textContent="Disconnect"; 
}
function uiDisconnected(){ statusEl.textContent = "Not connected"; connectBtn.textContent="Connect Wallet"; }

connectBtn.onclick = async ()=> wallet ? disconnect() : connect();

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom wallet not found. Please install Phantom."); window.open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet = null; uiDisconnected();
}

/* ---------- Payment (robust confirm) ---------- */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Please connect wallet first");
  const conn = new solanaWeb3.Connection(RPC, { commitment:"confirmed", confirmTransactionInitialTimeout:120000 });

  const from = p.publicKey;
  const to   = new solanaWeb3.PublicKey(RECEIVER_WALLET);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);

  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("finalized");

  const tx = new solanaWeb3.Transaction({
    feePayer: from,
    recentBlockhash: blockhash
  }).add(
    solanaWeb3.SystemProgram.transfer({ fromPubkey: from, toPubkey: to, lamports })
  );

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false, maxRetries:6 });

  await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
  return sig;
}

/* ---------- NFT Avatar via Helius ---------- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;

  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });
  const json = await r.json();
  const items = json?.result?.items || [];
  // prefer metadata.image, fallback content.files[0].uri
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;

  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* ---------- DB ops ---------- */
async function savePost(text, tx){
  // Hashtags extrahieren (#solana #gobbles #pump)
  const tags = [...text.matchAll(/#(\w+)/g)].map(m => m[1].toLowerCase());

  // ‚úÖ Speichern mit Tags
  const { error } = await db.from("posts").insert([{ wallet, content:text, tx, tags }]);
  if(error) throw error;
}

/* ---------- VOTING SYSTEM (UPDATED) ---------- */
window.vote = async (id, dir) => {
  if(!wallet) return alert("Please connect your wallet!");

  const success = await db.rpc(
    dir === "up" ? "vote_up" : "vote_down",
    { p_post_id: id, p_wallet: wallet }
  );

  if(!success.error){
    localStorage.setItem("vote_" + id, dir);
  }

  loadFeed(); 
};

/* ---------- Feed loading ---------- */
async function loadFeed(tag = null){
  currentFilter = tag;
  
  // Update filter badge
  if(tag) {
    filterBadge.style.display = 'inline';
    filterBadge.innerHTML = `Filter: #${tag} <span class="clear-filter" style="cursor:pointer;margin-left:8px">‚úï</span>`;
  } else {
    filterBadge.style.display = 'none';
  }

  let query = db.from("posts").select("*").order("created_at", {ascending:false});

  if(tag) {
    query = query.contains("tags", [tag]);
  }

  const { data, error } = await query.limit(50);
    
  if(error){ console.error("Supabase load error:", error); return; }

  const htmlParts = [];
  
  for(const p of (data || [])){
    const img = await avatar(p.wallet);
    const hasNft = !!img; // true wenn ein NFT gefunden wurde
    const userVote = localStorage.getItem("vote_" + p.id);

    htmlParts.push(`
      <div class="post">
        <div class="avatar ${hasNft ? "nft-halo" : ""}">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
        <div>
          <b class="wallet-label" data-wallet="${p.wallet}">${p.wallet.slice(0,6)}...</b>
          <p style="white-space: pre-line">${renderTextWithTags(p.content)}</p>
          <div class="post-actions">
            
            <span class="vote-btn ${userVote === "up" ? "active-up" : ""}" onclick="vote('${p.id}','up')">
              üëç ${p.upvotes || 0}
            </span>

            <span class="vote-btn ${userVote === "down" ? "active-down" : ""}" onclick="vote('${p.id}','down')">
              üëé ${p.downvotes || 0}
            </span>

            <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
              <img src="../img/1Solana.png" class="sol-icon">
            </span>

            <a target="_blank" class="small" href="https://solscan.io/tx/${p.tx}">
              View TX
            </a>
          </div>
        </div>
      </div>`);
  }

  feed.innerHTML = htmlParts.join("");

  // ‚úÖ Echter SNS Resolver f√ºr alle Wallet-Labels
  document.querySelectorAll(".wallet-label").forEach(el => {
    if (typeof displayWalletLabel === 'function') {
      displayWalletLabel(el.dataset.wallet, el);
    }
  });
  
  // ‚úÖ Trends aktualisieren
  loadTrends();
}

/* ---------- Trending System ---------- */
async function loadTrends(){
  const { data, error } = await db.from("posts").select("tags");
  if(error) return;

  let count = {};

  data.forEach(p => {
    (p.tags || []).forEach(t => {
      count[t] = (count[t] || 0) + 1;
    });
  });

  const trends = Object.entries(count)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5);

  if(trends.length > 0) {
    trendBox.innerHTML = trends.map(t => `
      <div class="trend-item hashtag" data-tag="${t[0]}">
        #${t[0]} <span class="trend-count">${t[1]}</span>
      </div>
    `).join("");
  } else {
    trendBox.innerHTML = '<div class="small" style="text-align:center;padding:20px;color:var(--muted)">No trends yet. Be the first to post with #hashtags!</div>';
  }
}

/* ---------- Cooldown ---------- */
async function canPost(pub){
  const { data, error } = await db.from("posts").select("created_at").eq("wallet", pub).order("created_at", {ascending:false}).limit(1);
  if(error || !data?.length) return true;
  const last = new Date(data[0].created_at);
  return (Date.now() - last.getTime())/1000 >= 60;
}
function startCooldown(sec){
  let t = sec; postBtn.disabled = true;
  const id = setInterval(()=>{ postBtn.textContent = `Wait ${t--}s`; if(t<0){ clearInterval(id); postBtn.textContent="Post"; postBtn.disabled=false; }}, 1000);
}

/* ---------- Realtime Feed ---------- */
db.channel("public:posts")
  .on("postgres_changes", { event:"INSERT", schema:"public", table:"posts" }, () => {
    loadFeed(currentFilter);
    loadTrends();
  })
  .subscribe();

/* ---------- Global functions for tipping ---------- */
window.tipUser = async (to) => {
  if(!wallet) return alert("Please connect your wallet to tip!");
  if(to === wallet) return alert("You can't tip yourself! üòÇ");
  alert("Tip feature coming in Phase 2 ‚úÖ");
};

/* ---------- Post action ---------- */
postBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!wallet) return alert("Please connect your wallet first!");
  if(!text) return alert("Please enter some text!");

  // Cooldown
  const ok = await canPost(wallet);
  if(!ok){ alert("‚è≥ You can only post once per minute."); return; }

  try {
    const sig = await pay(0.001);
    await savePost(text, sig);
    
    // Sound abspielen
    postSound.currentTime = 0;
    postSound.play();
    
    // Boom Sound f√ºr neuen Post
    setTimeout(() => {
      boomSound.currentTime = 0;
      boomSound.play();
    }, 200);
    
    postText.value = "";
    loadFeed();
    startCooldown(60);
  } catch (err) {
    console.error(err);
    alert("‚ùå Post failed: " + (err.message || "Unknown error"));
  }
};

// ---------------- PROFILE MODAL LOGIC ----------------
const modal = document.getElementById("profileModal");
const openBtn = document.getElementById("profileLink");
const closeBtn = document.getElementById("closeProfile");
const saveBtn = document.getElementById("saveProfile");
const addBtn = document.getElementById("addAsset");
const pfForm = document.getElementById("pfForm");
const bioInput = document.getElementById("bioInput");
const avatarInput = document.getElementById("avatarInput");

let pfChart;
let pfData = [];

// Open modal - KORRIGIERT MIT FEHLERBEHANDLUNG
openBtn.onclick = () => {
  if(!wallet) {
    alert("Please connect your wallet first!");
    return;
  }
  console.log("Opening profile modal...");
  loadProfile();
  modal.style.display = "flex";
};

// Close modal
closeBtn.onclick = () => {
  modal.style.display = "none";
};

// Add asset field
addBtn.onclick = () => renderAsset("", "");

// Render input row
function renderAsset(symbol, percent){
  const row = document.createElement("div");
  row.innerHTML = `
    <input class="text-input" placeholder="BTC (e.g., SOL, ETH)" value="${symbol}">
    <input class="text-input" placeholder="25 (%)" type="number" value="${percent}">
  `;
  pfForm.appendChild(row);
}

// Load profile from DB - MIT FEHLERBEHANDLUNG
async function loadProfile(){
  try {
    console.log("Loading profile for:", wallet);
    
    // Versuche Profile zu laden, aber fange Fehler ab falls Tabelle nicht existiert
    const { data, error } = await db.from("profiles").select("*").eq("wallet", wallet).single();
    
    if(error) {
      console.log("Profile table might not exist yet, using default values:", error);
      // Setze Standardwerte
      bioInput.value = "";
      avatarInput.value = "";
      pfData = [];
      pfForm.innerHTML = "";
      // F√ºge ein Beispiel-Asset hinzu
      renderAsset("SOL", "50");
      drawChart();
      return;
    }
    
    if(data){
      bioInput.value = data.bio || "";
      avatarInput.value = data.avatar || "";
      pfData = data.portfolio || [];
      pfForm.innerHTML = "";
      
      // Falls keine Portfolio-Daten, f√ºge Beispiel hinzu
      if(pfData.length === 0) {
        renderAsset("SOL", "50");
      } else {
        pfData.forEach(a => renderAsset(a.symbol, a.percent));
      }
      
      drawChart();
    } else {
      // Kein Profil gefunden - setze Standardwerte
      pfData = [];
      pfForm.innerHTML = "";
      renderAsset("SOL", "50");
      drawChart();
    }
  } catch (error) {
    console.error("Error loading profile:", error);
    // Fallback: Setze Standardwerte
    bioInput.value = "";
    avatarInput.value = "";
    pfData = [];
    pfForm.innerHTML = "";
    renderAsset("SOL", "50");
    drawChart();
  }
}

// Save profile - MIT FEHLERBEHANDLUNG
saveBtn.onclick = async () => {
  try {
    const rows = [...pfForm.querySelectorAll("div")];
    pfData = rows.map(r => {
      const [s, p] = r.querySelectorAll("input");
      return { symbol: s.value, percent: Number(p.value) };
    }).filter(x => x.symbol && x.percent);

    console.log("Saving profile data:", { wallet, bio: bioInput.value, avatar: avatarInput.value, portfolio: pfData });

    // Versuche zu speichern
    const { error } = await db.from("profiles").upsert({
      wallet,
      bio: bioInput.value,
      avatar: avatarInput.value,
      portfolio: pfData
    });

    if(error) {
      console.error("Supabase error:", error);
      // Falls Tabelle nicht existiert, zeige Info f√ºr manuelle Erstellung
      if(error.code === '42P01') { // table does not exist
        alert("‚ÑπÔ∏è Profile table doesn't exist yet. Please create the 'profiles' table in Supabase first.\n\nTable schema:\n- wallet (text, primary key)\n- bio (text)\n- avatar (text)\n- portfolio (jsonb)");
      } else {
        alert("‚ùå Error saving profile: " + error.message);
      }
      return;
    }

    alert("‚úÖ Profile saved successfully!");
    modal.style.display = "none";
    
  } catch (error) {
    console.error("Error saving profile:", error);
    alert("‚ùå Error saving profile: " + error.message);
  }
};

// Donut Chart - VERBESSERTE VERSION
function drawChart(){
  const ctx = document.getElementById("pfChart");
  if(!ctx) {
    console.log("Chart canvas not found");
    return;
  }
  
  if(pfChart) {
    pfChart.destroy();
  }

  // Stelle sicher, dass wir Daten haben
  const chartData = pfData && pfData.length > 0 ? pfData : [{ symbol: "SOL", percent: 100 }];
  
  try {
    pfChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: chartData.map(a => a.symbol),
        datasets: [{
          data: chartData.map(a => a.percent),
          backgroundColor: [
            '#00eaff', '#14F195', '#9945FF', '#FF6B6B', '#FFD93D',
            '#6BCF7F', '#FF9A76', '#A66CFF', '#9AD0F5', '#FFB6C1'
          ],
          borderWidth: 0,
          borderColor: 'rgba(255,255,255,0.1)'
        }]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#9ed9e6',
              font: {
                family: 'Barlow',
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.parsed}%`;
              }
            }
          }
        },
        cutout: '60%'
      }
    });
  } catch (error) {
    console.error("Error drawing chart:", error);
  }
}

/* ---------- Event Listeners ---------- */
document.addEventListener("click", (e) => {
  // Hashtag Click
  if(e.target.classList.contains("hashtag")){
    const tag = e.target.dataset.tag;
    if(tag) loadFeed(tag);
  }

  // Clear Filter
  if(e.target.classList.contains("clear-filter")){
    loadFeed();
  }

  // Reset Feed Button
  if(e.target.id === "resetFeedBtn" || e.target.closest("#resetFeedBtn")){
    loadFeed();
  }
});

// Close modal when clicking outside
modal.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.style.display = "none";
  }
});

// ESC key to close modal
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && modal.style.display === "flex") {
    modal.style.display = "none";
  }
});

/* ---------- INIT ---------- */
loadFeed();
loadTrends();

// Auto-connect if phantom already connected
getWallet()?.on("connect", (pk) => { wallet = pk.publicKey.toString(); uiConnected(wallet); });
getWallet()?.on("disconnect", () => { wallet = null; uiDisconnected(); });
if(getWallet()?.publicKey){ wallet = getWallet().publicKey.toString(); uiConnected(wallet); }
</script>
</body>
</html>
