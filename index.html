<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/favicon.png">
  
  <!-- Barlow Font -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700;800&display=swap" rel="stylesheet">
  
<title>Gobbles ‚Äî Cope Harder!</title>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ‚úÖ Echter Bonfida SNS Resolver (OHNE ES-Module) -->
<script>
  async function displayWalletLabel(address, el) {
    const short = `${address.slice(0,4)}‚Ä¶${address.slice(-4)}`;
    el.textContent = short;

    // Check LocalStorage cache
    const cached = localStorage.getItem("sns_"+address);
    if (cached) {
      el.textContent = `${short} (${cached}.sol)`;
    }
  }
  
  window.displayWalletLabel = displayWalletLabel;
</script>

<style>
  /* ... (DEIN GANZES CSS BLEIBT UNVER√ÑNDERT) ... */
</style>
</head>
<body>
<!-- ‚≠ê Partikel/Sterne Canvas -->
<canvas id="particles"></canvas>

<header>
  <div class="h-wrap">
    <div class="brand-wrap">
      <img src="../img/1boss.png" class="logo-anim" alt="Gobbles">
      <div>
        <div class="brand-main"><span class="g-wobble">G</span>obbles</div>
        <div class="small">Cope Harder!</div>
      </div>
    </div>

    <div style="flex:1"></div>

    <span id="wallet-status" class="status">Not connected</span>
    <button id="profileLink" class="pill profile-pill">Profile</button>
    <button id="connectBtn" class="btn connect-btn">Connect Wallet</button>
  </div>
</header>

<!-- Sound for posts -->
<audio id="postSound">
  <source src="../sounds/mgs2.mp3" type="audio/mpeg">
</audio>

<!-- Boom Sound for new posts -->
<audio id="boomSound">
  <source src="../sounds/boom.mp3" type="audio/mpeg">
</audio>

<main class="container">
  <div class="grid">
    <section>
      <div class="card">
        <div class="body">
          <h3>Create Post</h3>
          <textarea id="postText" maxlength="140" placeholder="What's happening? Use #hashtags for trends!"></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <div class="small">Fee: 0.001 SOL</div>
            <div style="flex:1"></div>
            <button id="postBtn" class="btn">Post</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Community Feed <span id="filterBadge" style="display:none"></span></h3>
        </div>
        <div id="feed"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="body">
          <h3>Trending</h3>
          <div id="trendBox">
            <div class="small" style="text-align:center;padding:20px;color:var(--muted)">
              No trends yet. Be the first to post with #hashtags!
            </div>
          </div>
          <button id="resetFeedBtn" class="btn" style="margin-top:10px;width:100%;">
            üîÑ Show All Posts
          </button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="body">
          <h3>Sentiment & Trends</h3>
          <div class="input-group">
            <label class="input-label">Search Posts</label>
            <input type="text" class="text-input" placeholder="Enter keyword...">
          </div>
          <div class="input-group">
            <label class="input-label">Filter by User</label>
            <input type="text" class="text-input" placeholder="Wallet address...">
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Profile Popup -->
<div id="profilePopup" class="popup-overlay">
  <div class="popup-card">
    <div class="popup-header">
      <h3>Your Profile</h3>
      <button class="close-popup">&times;</button>
    </div>
    
    <div class="popup-body">
      <div class="profile-avatar">
        <div id="profileAvatar" class="avatar nft-halo">
          <!-- Avatar wird via JS geladen -->
        </div>
      </div>
      
      <div class="profile-info">
        <div class="wallet-info">
          <span id="profileWallet" class="wallet-label"></span>
          <span class="nft-badge">NFT Holder</span>
        </div>
        
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-number" id="postsCount">0</span>
            <span class="stat-label">Posts</span>
          </div>
          <div class="stat">
            <span class="stat-number" id="upvotesCount">0</span>
            <span class="stat-label">Upvotes</span>
          </div>
          <div class="stat">
            <span class="stat-number" id="tipsReceived">0</span>
            <span class="stat-label">Tips</span>
          </div>
        </div>
      </div>
      
      <div class="profile-actions">
        <button class="btn" onclick="copyWalletAddress()">Copy Wallet</button>
        <button class="btn" onclick="viewOnExplorer()">View on Explorer</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL  = "https://nigwdyolfgixcejslaue.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZ3dkeW9sZmdpeGNlanNsYXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNTMzNzMsImV4cCI6MjA3NTYyOTM3M30.u3g0vzcuF6LstbnsrYyzl1TezJa-lKkd0xk55iddoyw";

const RECEIVER_WALLET = "Eamw917X8VNmH6xuD6mnR9Z5uyganASWRr4aNUU4tomt";
const RPC              = "https://mainnet.helius-rpc.com/?api-key=b5dce25c-09db-45bd-ba9b-d2e2f16fc841";
const HELIUS           = "4e2d8758-bf0e-473b-ae3c-c31bf809553c";

/* ---------- LIB INIT ---------- */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- UI refs (NUR DEKLARIEREN - werden sp√§ter gesetzt) ---------- */
let statusEl, connectBtn, postBtn, feed, postText, postSound, boomSound;
let trendBox, filterBadge, resetFeedBtn, profileLink, profilePopup;
let wallet = null;
let currentFilter = null;

/* ---------- Hashtag Functions ---------- */
function extractHashtags(text) {
  return (text.match(/#\w+/g) || []).map(t => t.toLowerCase().replace('#', ''));
}

function renderTextWithTags(text){
  return text.replace(/#(\w+)/g, `<span class="hashtag" data-tag="$1">#$1</span>`);
}

/* ---------- Partikel/Sterne Animation ---------- */
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");
let particles = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Erstelle Partikel/Sterne
for (let i = 0; i < 80; i++) {
  particles.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    size: Math.random() * 1.5 + 0.5,
    speedX: (Math.random() - 0.5) * 0.3,
    speedY: (Math.random() - 0.5) * 0.3,
    alpha: Math.random() * 0.6 + 0.2
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => {
    p.x += p.speedX; 
    p.y += p.speedY;
    
    if (p.x < 0) p.x = canvas.width;
    if (p.x > canvas.width) p.x = 0;
    if (p.y < 0) p.y = canvas.height;
    if (p.y > canvas.height) p.y = 0;

    ctx.fillStyle = `rgba(0,234,255,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

/* ---------- Wallet helpers ---------- */
function getWallet(){ return window.phantom?.solana || window.solana; }

function uiConnected(pk){ 
  if (!statusEl) return;
  statusEl.textContent = "‚úÖ ";
  const span = document.createElement("span");
  statusEl.appendChild(span);
  
  if (typeof displayWalletLabel === 'function') {
    displayWalletLabel(pk, span);
  } else {
    span.textContent = `${pk.slice(0,4)}‚Ä¶${pk.slice(-4)}`;
  }
  if (connectBtn) connectBtn.textContent="Disconnect"; 
}

function uiDisconnected(){ 
  if (statusEl) statusEl.textContent = "Not connected"; 
  if (connectBtn) connectBtn.textContent="Connect Wallet"; 
}

async function connect(){
  const p = getWallet();
  if(!p){ alert("Phantom wallet not found. Please install Phantom."); window.open("https://phantom.app","_blank"); return; }
  const r = await p.connect();
  wallet = r.publicKey.toString();
  uiConnected(wallet);
}

async function disconnect(){
  await getWallet()?.disconnect();
  wallet = null; 
  uiDisconnected();
}

/* ---------- Payment ---------- */
async function pay(amount){
  const p = getWallet();
  if(!p?.publicKey) throw new Error("Please connect wallet first");
  const conn = new solanaWeb3.Connection(RPC, { commitment:"confirmed", confirmTransactionInitialTimeout:120000 });

  const from = p.publicKey;
  const to   = new solanaWeb3.PublicKey(RECEIVER_WALLET);
  const lamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);

  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash("finalized");

  const tx = new solanaWeb3.Transaction({
    feePayer: from,
    recentBlockhash: blockhash
  }).add(
    solanaWeb3.SystemProgram.transfer({ fromPubkey: from, toPubkey: to, lamports })
  );

  const signed = await p.signTransaction(tx);
  const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false, maxRetries:6 });

  await conn.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, "confirmed");
  return sig;
}

/* ---------- NFT Avatar via Helius ---------- */
async function avatar(pub){
  const cache = localStorage.getItem("a_"+pub);
  if(cache) return cache;

  const r = await fetch(`https://mainnet.helius-rpc.com/?api-key=${HELIUS}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ jsonrpc:"2.0", id:"nft", method:"getAssetsByOwner", params:{ ownerAddress:pub } })
  });
  const json = await r.json();
  const items = json?.result?.items || [];
  let img = items.find(n=>n?.content?.metadata?.image)?.content?.metadata?.image;
  if(!img) img = items.find(n=>n?.content?.files?.[0]?.uri)?.content?.files?.[0]?.uri || null;

  if(img) localStorage.setItem("a_"+pub, img);
  return img;
}

/* ---------- DB ops ---------- */
async function savePost(text, tx){
  const tags = [...text.matchAll(/#(\w+)/g)].map(m => m[1].toLowerCase());
  const { error } = await db.from("posts").insert([{ wallet, content:text, tx, tags }]);
  if(error) throw error;
}

/* ---------- VOTING SYSTEM (KORRIGIERT) ---------- */
window.vote = async (id, dir) => {
  if(!wallet) return alert("Please connect your wallet!");

  const success = await db.rpc(
    dir === "up" ? "vote_up" : "vote_down",
    { p_post_id: id, p_wallet: wallet }
  );

  if(!success.error){
    localStorage.setItem("vote_" + id, dir);
  }

  loadFeed(); 
};

/* ---------- Feed loading ---------- */
async function loadFeed(tag = null){
  currentFilter = tag;
  
  if(tag) {
    if (filterBadge) {
      filterBadge.style.display = 'inline';
      filterBadge.innerHTML = `Filter: #${tag} <span class="clear-filter" style="cursor:pointer;margin-left:8px">‚úï</span>`;
    }
  } else {
    if (filterBadge) filterBadge.style.display = 'none';
  }

  let query = db.from("posts").select("*").order("created_at", {ascending:false});

  if(tag) {
    query = query.contains("tags", [tag]);
  }

  const { data, error } = await query.limit(50);
    
  if(error){ console.error("Supabase load error:", error); return; }

  const htmlParts = [];
  
  for(const p of (data || [])){
    const img = await avatar(p.wallet);
    const hasNft = !!img;
    const userVote = localStorage.getItem("vote_" + p.id);

    htmlParts.push(`
      <div class="post">
        <div class="avatar ${hasNft ? "nft-halo" : ""}">${img ? `<img src="${img}" alt="pfp">` : ""}</div>
        <div>
          <b class="wallet-label" data-wallet="${p.wallet}">${p.wallet.slice(0,6)}...</b>
          <p style="white-space: pre-line">${renderTextWithTags(p.content)}</p>
          <div class="post-actions">
            
            <span class="vote-btn ${userVote === "up" ? "active-up" : ""}" onclick="vote('${p.id}','up')">
              üëç ${p.upvotes || 0}
            </span>

            <span class="vote-btn ${userVote === "down" ? "active-down" : ""}" onclick="vote('${p.id}','down')">
              üëé ${p.downvotes || 0}
            </span>

            <span class="icon-btn sol-btn" onclick="tipUser('${p.wallet}')">
              <img src="../img/1Solana.png" class="sol-icon">
            </span>

            <a target="_blank" class="small" href="https://solscan.io/tx/${p.tx}">
              View TX
            </a>
          </div>
        </div>
      </div>`);
  }

  if (feed) {
    feed.innerHTML = htmlParts.join("");
  }

  document.querySelectorAll(".wallet-label").forEach(el => {
    if (typeof displayWalletLabel === 'function') {
      displayWalletLabel(el.dataset.wallet, el);
    }
  });
  
  loadTrends();
}

/* ---------- Trending System ---------- */
async function loadTrends(){
  const { data, error } = await db.from("posts").select("tags");
  if(error) return;

  let count = {};

  data.forEach(p => {
    (p.tags || []).forEach(t => {
      count[t] = (count[t] || 0) + 1;
    });
  });

  const trends = Object.entries(count)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5);

  if(trends.length > 0 && trendBox) {
    trendBox.innerHTML = trends.map(t => `
      <div class="trend-item hashtag" data-tag="${t[0]}">
        #${t[0]} <span class="trend-count">${t[1]}</span>
      </div>
    `).join("");
  } else if (trendBox) {
    trendBox.innerHTML = '<div class="small" style="text-align:center;padding:20px;color:var(--muted)">No trends yet. Be the first to post with #hashtags!</div>';
  }
}

/* ---------- Cooldown ---------- */
async function canPost(pub){
  const { data, error } = await db.from("posts").select("created_at").eq("wallet", pub).order("created_at", {ascending:false}).limit(1);
  if(error || !data?.length) return true;
  const last = new Date(data[0].created_at);
  return (Date.now() - last.getTime())/1000 >= 60;
}

function startCooldown(sec){
  if (!postBtn) return;
  let t = sec; 
  postBtn.disabled = true;
  const id = setInterval(()=>{ 
    postBtn.textContent = `Wait ${t--}s`; 
    if(t<0){ 
      clearInterval(id); 
      postBtn.textContent="Post"; 
      postBtn.disabled=false; 
    }
  }, 1000);
}

/* ---------- Realtime Feed ---------- */
db.channel("public:posts")
  .on("postgres_changes", { event:"INSERT", schema:"public", table:"posts" }, () => {
    loadFeed(currentFilter);
    loadTrends();
  })
  .subscribe();

/* ---------- Global functions for tipping ---------- */
window.tipUser = async (to) => {
  if(!wallet) return alert("Please connect your wallet to tip!");
  if(to === wallet) return alert("You can't tip yourself! üòÇ");
  alert("Tip feature coming in Phase 2 ‚úÖ");
};

/* ---------- Post action ---------- */
function setupPostButton() {
  if (!postBtn || !postText) return;
  
  postBtn.onclick = async ()=>{
    const text = postText.value.trim();
    if(!wallet) return alert("Please connect your wallet first!");
    if(!text) return alert("Please enter some text!");

    const ok = await canPost(wallet);
    if(!ok){ alert("‚è≥ You can only post once per minute."); return; }

    try {
      const sig = await pay(0.001);
      await savePost(text, sig);
      
      if (postSound) {
        postSound.currentTime = 0;
        postSound.play();
      }
      
      setTimeout(() => {
        if (boomSound) {
          boomSound.currentTime = 0;
          boomSound.play();
        }
      }, 200);
      
      postText.value = "";
      loadFeed();
      startCooldown(60);
    } catch (err) {
      console.error(err);
      alert("‚ùå Post failed: " + (err.message || "Unknown error"));
    }
  };
}

/* ---------- Profile Popup Functions ---------- */
window.openProfilePopup = async function() {
  if (!wallet) {
    alert("Please connect your wallet first!");
    return;
  }

  try {
    await loadProfileData();
    
    if (profilePopup) {
      profilePopup.classList.add("show");
      document.body.style.overflow = "hidden";
    }
  } catch(err) {
    console.error("Profile load error:", err);
    alert("Failed to load profile");
  }
}

window.closeProfilePopup = function() {
  if (profilePopup) {
    profilePopup.classList.remove("show");
    document.body.style.overflow = "auto";
  }
}

async function loadProfileData() {
  try {
    const avatarImg = await avatar(wallet);
    const profileAvatar = document.getElementById("profileAvatar");
    if (profileAvatar) {
      if (avatarImg) {
        profileAvatar.innerHTML = `<img src="${avatarImg}" alt="Profile Avatar">`;
      } else {
        profileAvatar.innerHTML = '';
      }
    }

    const profileWallet = document.getElementById("profileWallet");
    if (profileWallet) {
      if (typeof displayWalletLabel === 'function') {
        displayWalletLabel(wallet, profileWallet);
      } else {
        profileWallet.textContent = `${wallet.slice(0, 6)}...${wallet.slice(-4)}`;
      }
    }

    const { data: posts } = await db.from("posts")
      .select("id, upvotes, downvotes")
      .eq("wallet", wallet);
    
    const postsTotal = posts?.length || 0;
    const upvotesTotal = posts?.reduce((sum, post) => sum + (post.upvotes || 0), 0) || 0;
    
    const postsCountEl = document.getElementById("postsCount");
    const upvotesCountEl = document.getElementById("upvotesCount");
    const tipsReceivedEl = document.getElementById("tipsReceived");
    
    if (postsCountEl) postsCountEl.textContent = postsTotal;
    if (upvotesCountEl) upvotesCountEl.textContent = upvotesTotal;
    if (tipsReceivedEl) tipsReceivedEl.textContent = "0";

  } catch (error) {
    console.error("Error loading profile data:", error);
    throw error;
  }
}

window.copyWalletAddress = function() {
  if(!wallet) return alert("No wallet connected!");
  navigator.clipboard.writeText(wallet).then(() => {
    alert("‚úÖ Wallet address copied!");
  }).catch(() => {
    alert("Failed to copy address");
  });
}

window.viewOnExplorer = function() {
  if(!wallet) return alert("No wallet connected!");
  window.open(`https://solscan.io/account/${wallet}`, "_blank");
}

/* ---------- EVENT LISTENERS F√úR POPUP (NACH DOM!) ---------- */
document.addEventListener("DOMContentLoaded", () => {
  // Erst JETZT die Elemente holen!
  statusEl = document.getElementById("wallet-status");
  connectBtn = document.getElementById("connectBtn");
  postBtn = document.getElementById("postBtn");
  feed = document.getElementById("feed");
  postText = document.getElementById("postText");
  postSound = document.getElementById("postSound");
  boomSound = document.getElementById("boomSound");
  trendBox = document.getElementById("trendBox");
  filterBadge = document.getElementById("filterBadge");
  resetFeedBtn = document.getElementById("resetFeedBtn");
  profileLink = document.getElementById("profileLink");
  profilePopup = document.getElementById("profilePopup");

  // Connect Button
  if (connectBtn) {
    connectBtn.onclick = async () => wallet ? disconnect() : connect();
  }

  // Post Button
  setupPostButton();

  // Close Button
  const closeBtn = document.querySelector(".close-popup");
  if (closeBtn) {
    closeBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.closeProfilePopup();
    });
  }

  // Background Click
  if (profilePopup) {
    profilePopup.addEventListener("click", (e) => {
      if (e.target === profilePopup) {
        window.closeProfilePopup();
      }
    });
  }

  // Profile Link ‚Äì JETZT funktioniert's!
  if (profileLink) {
    profileLink.addEventListener("click", (e) => {
      e.preventDefault();
      window.openProfilePopup();
    });
  }

  // Reset Feed Button
  if (resetFeedBtn) {
    resetFeedBtn.addEventListener("click", () => {
      loadFeed();
    });
  }

  // Hashtag Click Handler
  document.addEventListener("click", (e) => {
    if(e.target.classList.contains("hashtag")){
      const tag = e.target.dataset.tag;
      if(tag) loadFeed(tag);
    }

    if(e.target.classList.contains("clear-filter")){
      loadFeed();
    }
  });

  // Auto-connect if phantom already connected
  if(getWallet()?.publicKey){ 
    wallet = getWallet().publicKey.toString(); 
    uiConnected(wallet); 
  }

  // Initial load
  loadFeed();
  loadTrends();
});
</script>
</body>
</html>
